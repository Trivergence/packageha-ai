{
  "version": 3,
  "sources": ["../../../src/shopify.ts", "../../../src/charter.ts", "../../../src/sovereign-switch.ts", "../../../src/session.ts", "../../../src/index.ts", "file:///C:/Users/akhod/AppData/Local/npm-cache/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "file:///C:/Users/akhod/AppData/Local/npm-cache/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-QDVGqt/middleware-insertion-facade.js", "file:///C:/Users/akhod/AppData/Local/npm-cache/_npx/32026684e21afda6/node_modules/wrangler/templates/middleware/common.ts", "../bundle-QDVGqt/middleware-loader.entry.ts"],
  "sourceRoot": "D:\\OneDrive\\Files\\Work\\Trivergence\\GitHub\\packageha-ai-1\\.wrangler\\tmp\\dev-CsqMYe",
  "sourcesContent": ["/**\n * Shopify Integration\n * Handles product catalog and order creation\n */\n\nexport interface ShopifyProduct {\n    id: number;\n    title: string;\n    variants: Array<{\n        id: number;\n        title: string;\n        price: string;\n    }>;\n}\n\nexport interface ShopifyResponse {\n    products?: ShopifyProduct[];\n}\n\nexport async function getActiveProducts(shopUrl: string, token: string): Promise<ShopifyProduct[]> {\n    const cleanShop = shopUrl.replace(/(^\\w+:|^)\\/\\//, '').replace(/\\/$/, '');\n    const url = `https://${cleanShop}/admin/api/2024-01/products.json?status=active&limit=50`;\n\n    try {\n        const response = await fetch(url, {\n            method: \"GET\",\n            headers: {\n                \"X-Shopify-Access-Token\": token,\n                \"Content-Type\": \"application/json\"\n            }\n        });\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            throw new Error(`Shopify API Error ${response.status}: ${errorText}`);\n        }\n\n        const data = await response.json() as ShopifyResponse;\n        return data.products || [];\n\n    } catch (error: any) {\n        console.error(\"[getActiveProducts] Error:\", error);\n        throw new Error(`Failed to fetch products: ${error.message}`);\n    }\n}\n\nexport interface DraftOrderResponse {\n    draft_order?: {\n        id: number;\n        invoice_url?: string;\n        order_id?: number;\n    };\n}\n\nexport interface DraftOrderResult {\n    draftOrderId: number;\n    adminUrl: string;\n    invoiceUrl?: string;\n}\n\nexport interface CustomLineItem {\n    title: string;\n    price: string; // Price as string (e.g., \"500.00\")\n    quantity: number;\n}\n\nexport async function createDraftOrder(\n    shopUrl: string,\n    token: string,\n    variantId: number | null,\n    qty: number,\n    note: string = \"\",\n    customLineItems?: CustomLineItem[] // Optional custom line items for services\n): Promise<DraftOrderResult> {\n    const cleanShop = shopUrl.replace(/(^\\w+:|^)\\/\\//, '').replace(/\\/$/, '');\n    const url = `https://${cleanShop}/admin/api/2024-01/draft_orders.json`;\n\n    // Build line items array\n    const lineItems: any[] = [];\n    \n    // Add package product if variant ID provided\n    if (variantId) {\n        lineItems.push({\n            variant_id: variantId,\n            quantity: qty\n        });\n    }\n    \n    // Add custom line items (services) if provided\n    if (customLineItems && customLineItems.length > 0) {\n        customLineItems.forEach(item => {\n            lineItems.push({\n                title: item.title,\n                price: item.price,\n                quantity: item.quantity\n            });\n        });\n    }\n\n    // At least one line item is required\n    if (lineItems.length === 0) {\n        throw new Error(\"At least one line item (product variant or custom item) is required\");\n    }\n\n    const payload = {\n        draft_order: {\n            line_items: lineItems,\n            note: note.trim(),\n            tags: \"studium-ai-generated\"\n        }\n    };\n\n    try {\n        const response = await fetch(url, {\n            method: \"POST\",\n            headers: {\n                \"X-Shopify-Access-Token\": token,\n                \"Content-Type\": \"application/json\"\n            },\n            body: JSON.stringify(payload)\n        });\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            throw new Error(`Shopify API Error ${response.status}: ${errorText}`);\n        }\n\n        const data = await response.json() as DraftOrderResponse;\n        const draftOrderId = data.draft_order?.id;\n        \n        if (!draftOrderId) {\n            throw new Error(\"No draft order ID returned from Shopify\");\n        }\n\n        // Construct admin URL (more reliable than invoice URL)\n        const adminUrl = `https://${cleanShop}/admin/draft_orders/${draftOrderId}`;\n        \n        return {\n            draftOrderId,\n            adminUrl,\n            invoiceUrl: data.draft_order?.invoice_url\n        };\n    } catch (error: any) {\n        console.error(\"[createDraftOrder] Error:\", error);\n        throw new Error(`Failed to create draft order: ${error.message}`);\n    }\n}", "/**\n * The Charter: The \"Soul\" of the Being\n * Defines the values, rules, and behavior patterns for the Packageha Sales Associate\n */\n\nexport interface CharterStep {\n    id: string;\n    question: string;\n    validation?: (answer: string) => boolean | string;\n    options?: string[] | string[][]; // Optional predefined options - can be flat array or grouped array (for grouped mode)\n    multiple?: boolean | \"grouped\"; // If true, allow multiple selections (checkboxes), if false, single selection (radio buttons), if \"grouped\", first group is radio, rest are checkboxes\n    defaultValue?: string; // Optional default value for UI hints\n}\n\nexport interface CharterPhase {\n    mission: string;\n    rules: string[];\n}\n\nexport interface Charter {\n    meta: {\n        name: string;\n        tone: string;\n        version: string;\n    };\n    discovery: CharterPhase;\n    variant: CharterPhase;\n    consultation: {\n        mission: string;\n        steps: CharterStep[];\n    };\n    // Optional: Additional consultation phases for complex flows\n    productDetails?: {\n        mission: string;\n        steps: CharterStep[];\n    };\n    packageSpecs?: {\n        mission: string;\n        steps: CharterStep[];\n    };\n    fulfillmentSpecs?: {\n        mission: string;\n        steps: CharterStep[];\n    };\n    launchKit?: {\n        mission: string;\n        steps: CharterStep[];\n    };\n}\n\nexport const SALES_CHARTER: Charter = {\n    meta: {\n        name: \"Packageha Sales Associate\",\n        tone: \"Professional, thorough, and consultative. Always helpful, never pushy.\",\n        version: \"3.0\",\n    },\n\n    // PHASE 1: FINDING THE PACKAGE (Packageha's packages, not client's product)\n    discovery: {\n        mission: \"Find the best match ID for the user's request from the provided inventory list.\",\n        rules: [\n            \"IGNORE prefixes like 'TEST' or 'rs-' in package titles.\",\n            \"MATCH LOOSELY: 'Box' matches 'Custom Box Calculator'. 'Photo' matches '\u062E\u062F\u0645\u0629 \u062A\u0635\u0648\u064A\u0631'.\",\n            \"If multiple matches exist, pick the most relevant one based on the user's specific keywords.\",\n            \"Be culturally aware - support both English and Arabic product names.\",\n            \"If the user is just greeting or chatting, respond warmly but guide them to search.\",\n            \"Return ONLY a JSON object with 'type' and relevant fields. NO MARKDOWN.\",\n        ]\n    },\n\n    // PHASE 2: REFINING THE OPTION\n    variant: {\n        mission: \"Identify which specific product option (variant) the user wants.\",\n        rules: [\n            \"Analyze the user's input against the provided Options list.\",\n            \"Match by keywords, synonyms, or partial matches.\",\n            \"If the user wants to switch products entirely, return 'RESTART'.\",\n            \"If unclear, ask for clarification by listing the available options.\",\n            \"Return ONLY a JSON object. NO MARKDOWN.\",\n        ]\n    },\n\n    // STEP 1: Product Details - Information about what goes inside the package\n    productDetails: {\n        mission: \"Collect information about the product that will go inside the package to help recommend the right packaging solution.\",\n        steps: [\n            {\n                id: \"product_description\",\n                question: \"First, tell me about your product. What is it? What does it do?\",\n            },\n            {\n                id: \"product_dimensions\",\n                question: \"What are your product dimensions? (Length x Width x Height in cm or inches)\",\n                validation: (answer: string) => {\n                    const hasNumbers = /\\d/.test(answer);\n                    if (!hasNumbers) return \"Please include dimensions with numbers (e.g., 20x15x10 cm).\";\n                    return true;\n                }\n            },\n            {\n                id: \"product_weight\",\n                question: \"Approximately how much does your product weigh? (grams or ounces)\",\n            },\n            {\n                id: \"fragility\",\n                question: \"Is your product fragile? Does it need special protection?\",\n                options: [\"Not fragile\", \"Somewhat fragile\", \"Very fragile\", \"Needs cushioning/protection\"],\n                multiple: false\n            },\n            {\n                id: \"budget\",\n                question: \"What's your budget range for packaging? (per unit or total)\",\n                options: [\"Under 1 SAR/unit\", \"1-5 SAR/unit\", \"5-10 SAR/unit\", \"10-20 SAR/unit\", \"20+ SAR/unit\", \"Budget flexible\", \"Will discuss\"],\n                multiple: false\n            }\n        ]\n    },\n\n    // STEP 2: Package Selection - Packageha package search/selection with specifications\n    // This uses discovery + variant for finding the Packageha package, then collects package specs\n    // Note: \"package\" here refers to Packageha's packages (what we sell), NOT the client's product\n    packageSpecs: {\n        mission: \"Collect package specifications (material, dimensions, print) after Packageha package is selected.\",\n        steps: [\n            { \n                id: \"material\", \n                question: \"Do you have a preference for Material?\",\n                options: [\"Corrugated\", \"Folding Carton\", \"Rigid Box\", \"Paperboard\", \"Kraft\", \"White Cardboard\"],\n                multiple: false // Single selection (radio buttons)\n            },\n            { \n                id: \"dimensions\", \n                question: \"What are the internal Dimensions for the package? (Length x Width x Height in cm or inches)\",\n                validation: (answer: string) => {\n                    const hasNumbers = /\\d/.test(answer);\n                    if (!hasNumbers) return \"Please include dimensions with numbers (e.g., 20x15x10 cm).\";\n                    return true;\n                }\n            },\n            { \n                id: \"print\", \n                question: \"Tell me about the Printing/Finish.\",\n                // Grouped options: first array is mutually exclusive (radio), second array can be combined (checkboxes)\n                options: [\n                    // Printing type - mutually exclusive (choose one)\n                    [\"Full color printing\", \"Logo only\", \"No printing\"],\n                    // Finishing options - can be combined (select multiple)\n                    [\"Gold foil\", \"Silver foil\", \"Matte lamination\", \"Glossy lamination\", \"UV coating\", \"Embossing\", \"Debossing\"]\n                ],\n                multiple: \"grouped\" // Special mode: first group is radio, second group is checkboxes\n            }\n        ]\n    },\n\n    // STEP 3: Fulfilment Specs - Order fulfillment information\n    fulfillmentSpecs: {\n        mission: \"Collect all information needed for order fulfillment and delivery.\",\n        steps: [\n            { \n                id: \"quantity\", \n                question: \"What quantity would you like to order?\",\n                validation: (answer: string) => {\n                    const match = answer.match(/(\\d+(?:\\.\\d+)?)/);\n                    if (!match) {\n                        return \"Please provide a valid quantity (e.g., 100, 500, 1000).\";\n                    }\n                    const num = Math.floor(parseFloat(match[1]));\n                    if (!num || num < 1) {\n                        return \"Please provide a valid quantity (e.g., 100, 500, 1000).\";\n                    }\n                    return true;\n                }\n            },\n            { \n                id: \"timeline\", \n                question: \"When is your deadline for delivery?\",\n                options: [\"1-2 weeks\", \"2-4 weeks\", \"1-2 months\", \"2-3 months\", \"3+ months\", \"Flexible\"],\n                multiple: false\n            },\n            {\n                id: \"shipping_address\",\n                question: \"Where should we deliver the order? (Please provide shipping address or city/region)\",\n            },\n            {\n                id: \"special_instructions\",\n                question: \"Any special fulfillment instructions or requirements? (optional - type 'none' to skip)\",\n            }\n        ]\n    },\n\n    // STEP 4: Launch Kit - Brand launch services\n    launchKit: {\n        mission: \"Offer and collect information for brand launch services.\",\n        steps: [\n            {\n                id: \"service_selection\",\n                question: \"Would you like to add any brand launch services? (Select all that apply)\",\n                options: [\n                    \"Hero shot photography\",\n                    \"Stop-motion unboxing video\",\n                    \"E-commerce product photos\",\n                    \"3D render with packaging for website\",\n                    \"Package design consultation\",\n                    \"Brand styling consultation\",\n                    \"None - skip launch services\"\n                ],\n                multiple: true // Checkboxes - can select multiple\n            },\n            {\n                id: \"service_timeline\",\n                question: \"What's your timeline for these services?\",\n                options: [\"ASAP\", \"1-2 weeks\", \"2-4 weeks\", \"1-2 months\", \"Flexible\"],\n                multiple: false\n            },\n            {\n                id: \"service_notes\",\n                question: \"Any specific requirements or details for the launch services? (optional - type 'none' to skip)\",\n            }\n        ]\n    },\n\n    // Legacy consultation - kept for backward compatibility but not used in new flow\n    consultation: {\n        mission: \"Legacy - not used in new flow structure\",\n        steps: []\n    }\n};\n\n/**\n * Package Ordering Charter - Simplified flow for ordering packages\n * @deprecated - Keeping for reference but not actively used\n */\nexport const PACKAGE_ORDER_CHARTER: Charter = {\n    meta: {\n        name: \"Packageha Package Ordering Assistant\",\n        tone: \"Professional, efficient, and helpful. Guide users to order packages quickly.\",\n        version: \"1.0\",\n    },\n    discovery: {\n        mission: \"Help user select a package from the available catalog.\",\n        rules: SALES_CHARTER.discovery.rules, // Reuse discovery rules\n    },\n    variant: {\n        mission: \"Help user select package variant.\",\n        rules: SALES_CHARTER.variant.rules, // Reuse variant rules\n    },\n    consultation: {\n        mission: \"Collect package order details efficiently.\",\n        steps: [\n            {\n                id: \"quantity\",\n                question: \"What quantity would you like to order?\",\n                validation: SALES_CHARTER.consultation.steps[0]?.validation,\n            },\n            {\n                id: \"notes\",\n                question: \"Any special requirements or notes for this order? (optional - type 'none' to skip)\",\n            },\n        ],\n    },\n};\n\n/**\n * Launch Kit Charter - Studio services ordering\n * @deprecated - Integrated into SALES_CHARTER.launchKit\n */\nexport const LAUNCH_KIT_CHARTER: Charter = {\n    meta: {\n        name: \"Packageha Launch Kit Assistant\",\n        tone: \"Professional and consultative. Help clients select studio services for their products.\",\n        version: \"1.0\",\n    },\n    discovery: {\n        mission: \"Present Launch Kit services to the user.\",\n        rules: [\n            \"Present services clearly and professionally.\",\n            \"Explain what each service includes.\",\n            \"Help user understand which services they need.\",\n        ],\n    },\n    variant: SALES_CHARTER.variant, // Not used but required by interface\n    consultation: {\n        mission: \"Collect project details for Launch Kit services.\",\n        steps: [\n            {\n                id: \"services\",\n                question: \"Which services would you like? (Product Photography, Package Design, Brand Consultation)\",\n            },\n            {\n                id: \"product_info\",\n                question: \"Tell me about your product(s) - name, description, or what you're launching.\",\n            },\n            {\n                id: \"timeline\",\n                question: \"What's your target timeline for this project?\",\n            },\n            {\n                id: \"budget\",\n                question: \"Do you have a budget range for this project?\",\n            },\n            {\n                id: \"notes\",\n                question: \"Any additional requirements or special requests?\",\n            },\n        ],\n    },\n};\n\n/**\n * Packaging Assistant Charter - Help users find the right package\n * @deprecated - Keeping for reference but not actively used\n */\nexport const PACKAGING_ASSISTANT_CHARTER: Charter = {\n    meta: {\n        name: \"Packageha Packaging Consultant\",\n        tone: \"Consultative and expert. Help users understand their packaging needs and recommend the best solutions.\",\n        version: \"1.0\",\n    },\n    discovery: {\n        mission: \"Understand the user's product and packaging needs.\",\n        rules: [\n            \"Ask clarifying questions to understand the product.\",\n            \"Be thorough but conversational.\",\n            \"Collect all necessary information before recommending.\",\n        ],\n    },\n    variant: SALES_CHARTER.variant, // Not used but required\n    consultation: {\n        mission: \"Collect product information to recommend the best packaging solution.\",\n        steps: [\n            {\n                id: \"product_description\",\n                question: \"First, tell me about your product. What is it? What does it do?\",\n            },\n            {\n                id: \"dimensions\",\n                question: \"What are the product dimensions? (Length x Width x Height in cm or inches)\",\n                validation: (answer: string) => {\n                    const hasNumbers = /\\d/.test(answer);\n                    if (!hasNumbers) return \"Please include dimensions with numbers (e.g., 20x15x10 cm).\";\n                    return true;\n                },\n            },\n            {\n                id: \"weight\",\n                question: \"Approximately how much does it weigh? (grams or ounces)\",\n            },\n            {\n                id: \"fragility\",\n                question: \"Is the product fragile? Does it need special protection?\",\n            },\n            {\n                id: \"brand_requirements\",\n                question: \"Any specific branding or design requirements? (logo, colors, finish)\",\n            },\n            {\n                id: \"budget\",\n                question: \"What's your budget range for packaging? (per unit or total)\",\n            },\n            {\n                id: \"quantity\",\n                question: \"What quantity are you planning to order?\",\n                validation: (answer: string) => {\n                    const match = answer.match(/(\\d+(?:\\.\\d+)?)/);\n                    if (!match) return \"Please provide a quantity (e.g., 100, 500, 1000).\";\n                    return true;\n                },\n            },\n        ],\n    },\n};\n\n/**\n * Build a system prompt from the Charter for AI calls\n */\nexport function buildCharterPrompt(phase: \"discovery\" | \"variant\" | \"consultation\", charter: Charter = SALES_CHARTER): string {\n    let prompt = `You are ${charter.meta.name}. ${charter.meta.tone}\\n\\n`;\n\n    if (phase === \"discovery\") {\n        prompt += `MISSION: ${charter.discovery.mission}\\n\\n`;\n        prompt += `RULES:\\n${charter.discovery.rules.map(r => `- ${r}`).join(\"\\n\")}\\n`;\n    } else if (phase === \"variant\") {\n        prompt += `MISSION: ${charter.variant.mission}\\n\\n`;\n        prompt += `RULES:\\n${charter.variant.rules.map(r => `- ${r}`).join(\"\\n\")}\\n`;\n    } else if (phase === \"consultation\") {\n        prompt += `MISSION: ${charter.consultation.mission}\\n\\n`;\n    }\n\n    prompt += `\\nAlways follow these rules strictly. Return valid JSON only.`;\n    return prompt;\n}\n", "/**\n * The Hybrid Sovereign Switch\n * Routes AI calls based on SOVEREIGN_MODE configuration\n */\n\nimport { Env, SovereignMode } from \"./types\";\n\nexport interface AIConfig {\n  provider: \"cloudflare\" | \"openai\" | \"gemini\" | \"vertex\" | \"local\";\n  model?: string;\n  endpoint?: string;\n  headers?: Record<string, string>;\n  apiKey?: string;\n}\n\nexport class SovereignSwitch {\n  private mode: SovereignMode;\n  private env: Env;\n\n  constructor(env: Env) {\n    this.env = env;\n    this.mode = (env.SOVEREIGN_MODE || \"COMMERCIAL\") as SovereignMode;\n  }\n\n  /**\n   * Get the appropriate AI configuration based on mode\n   */\n  getAIConfig(): AIConfig {\n    switch (this.mode) {\n      case \"COMMERCIAL\":\n        // Mode A: Cloudflare AI (Legacy - small models)\n        return {\n          provider: \"cloudflare\",\n          model: \"@cf/meta/llama-3-8b-instruct\",\n        };\n\n      case \"COMMERCIAL_OPENAI\":\n        // Mode A1: OpenAI (ChatGPT) - GPT-4o or GPT-3.5-turbo\n        if (!this.env.OPENAI_API_KEY) {\n          throw new Error(\"OPENAI_API_KEY is required for COMMERCIAL_OPENAI mode\");\n        }\n        return {\n          provider: \"openai\",\n          model: \"gpt-4o-mini\", // Cost-effective, fast. Use \"gpt-4o\" for best quality\n          apiKey: this.env.OPENAI_API_KEY,\n        };\n\n      case \"COMMERCIAL_GEMINI\":\n        // Mode A2: Google Gemini - Auto-selects working model\n        if (!this.env.GEMINI_API_KEY) {\n          throw new Error(\"GEMINI_API_KEY is required for COMMERCIAL_GEMINI mode\");\n        }\n        return {\n          provider: \"gemini\",\n          // Model will be auto-selected from available models at runtime\n          model: undefined, // Will be determined by getWorkingGeminiModel()\n          apiKey: this.env.GEMINI_API_KEY,\n        };\n\n      case \"SOVEREIGN\":\n        // Mode B: Google Vertex AI (Dammam Region) via Cloudflare AI Gateway\n        return {\n          provider: \"vertex\",\n          endpoint: this.env.VERTEX_AI_ENDPOINT || \"https://aiplatform.googleapis.com/v1\",\n          model: \"gemini-pro\",\n          headers: {\n            \"Authorization\": `Bearer ${this.env.VERTEX_AI_PROJECT}`,\n            \"Content-Type\": \"application/json\",\n          },\n        };\n\n      case \"AIR_GAPPED\":\n        // Mode C: Local Llama 3.1 GPU server via Docker\n        return {\n          provider: \"local\",\n          endpoint: this.env.LOCAL_LLAMA_ENDPOINT || \"http://localhost:8080/v1/chat/completions\",\n          model: \"llama-3.1-70b\",\n        };\n\n      default:\n        // Fallback to Gemini if key available, otherwise Cloudflare AI\n        if (this.env.GEMINI_API_KEY) {\n          return {\n            provider: \"gemini\",\n            model: \"gemini-pro\",\n            apiKey: this.env.GEMINI_API_KEY,\n          };\n        }\n        return {\n          provider: \"cloudflare\",\n          model: \"@cf/meta/llama-3-8b-instruct\",\n        };\n    }\n  }\n\n  /**\n   * Execute AI call through the appropriate provider\n   */\n  async callAI(prompt: string, systemPrompt?: string): Promise<string> {\n    const config = this.getAIConfig();\n\n    try {\n      switch (config.provider) {\n        case \"cloudflare\":\n          return await this.callCloudflareAI(prompt, systemPrompt, config.model!);\n\n        case \"openai\":\n          return await this.callOpenAI(prompt, systemPrompt, config);\n\n        case \"gemini\":\n          return await this.callGemini(prompt, systemPrompt, config);\n\n        case \"vertex\":\n          return await this.callVertexAI(prompt, systemPrompt, config);\n\n        case \"local\":\n          return await this.callLocalAI(prompt, systemPrompt, config);\n\n        default:\n          throw new Error(`Unknown provider: ${config.provider}`);\n      }\n    } catch (error: any) {\n      console.error(`[SovereignSwitch] Error in ${config.provider}:`, error);\n      throw new Error(`AI call failed: ${error.message}`);\n    }\n  }\n\n  private async callCloudflareAI(\n    prompt: string,\n    systemPrompt: string | undefined,\n    model: string\n  ): Promise<string> {\n    if (!this.env.AI) {\n      throw new Error(\"Cloudflare AI binding not available\");\n    }\n\n    const messages: Array<{ role: string; content: string }> = [];\n    if (systemPrompt) {\n      messages.push({ role: \"system\", content: systemPrompt });\n    }\n    messages.push({ role: \"user\", content: prompt });\n\n    const response = await this.env.AI.run(model, { messages });\n    return response.response || \"\";\n  }\n\n  private async callOpenAI(\n    prompt: string,\n    systemPrompt: string | undefined,\n    config: AIConfig\n  ): Promise<string> {\n    const endpoint = \"https://api.openai.com/v1/chat/completions\";\n    \n    const messages: Array<{ role: string; content: string }> = [];\n    if (systemPrompt) {\n      messages.push({ role: \"system\", content: systemPrompt });\n    }\n    messages.push({ role: \"user\", content: prompt });\n\n    const payload = {\n      model: config.model || \"gpt-4o-mini\",\n      messages: messages,\n      temperature: 0.7,\n      max_tokens: 1024,\n    };\n\n    const response = await fetch(endpoint, {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${config.apiKey}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);\n    }\n\n    const data = await response.json();\n    return data.choices?.[0]?.message?.content || \"\";\n  }\n\n  /**\n   * List available Gemini models\n   */\n  async listGeminiModels(apiKey: string): Promise<string[]> {\n    try {\n      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;\n      const response = await fetch(endpoint);\n      \n      if (!response.ok) {\n        throw new Error(`Failed to list models: ${response.status}`);\n      }\n      \n      const data = await response.json();\n      // Filter models that support generateContent\n      const models = (data.models || [])\n        .filter((m: any) => m.supportedGenerationMethods?.includes('generateContent'))\n        .map((m: any) => m.name.replace('models/', ''))\n        .sort();\n      \n      return models;\n    } catch (error: any) {\n      console.error(\"[listGeminiModels] Error:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get a working Gemini model (tries to find one that works)\n   */\n  async getWorkingGeminiModel(apiKey: string, preferredModel?: string): Promise<string> {\n    // First, try to list available models\n    const availableModels = await this.listGeminiModels(apiKey);\n    \n    if (availableModels.length === 0) {\n      // Fallback if list fails\n      return preferredModel || \"gemini-pro\";\n    }\n    \n    // If preferred model is in the list, use it\n    if (preferredModel && availableModels.includes(preferredModel)) {\n      return preferredModel;\n    }\n    \n    // Prefer models with \"flash\" in the name (faster, cheaper)\n    const flashModels = availableModels.filter(m => m.toLowerCase().includes('flash'));\n    if (flashModels.length > 0) {\n      return flashModels[0];\n    }\n    \n    // Prefer models with \"1.5\" in the name (newer)\n    const v15Models = availableModels.filter(m => m.includes('1.5'));\n    if (v15Models.length > 0) {\n      return v15Models[0];\n    }\n    \n    // Fallback to first available model\n    return availableModels[0];\n  }\n\n  private async callGemini(\n    prompt: string,\n    systemPrompt: string | undefined,\n    config: AIConfig\n  ): Promise<string> {\n    if (!config.apiKey) {\n      throw new Error(\"Gemini API key is required\");\n    }\n    \n    // Get a working model (automatically selects from available models)\n    const model = config.model || await this.getWorkingGeminiModel(config.apiKey);\n    const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${config.apiKey}`;\n\n    // Combine system prompt and user prompt for Gemini\n    let fullPrompt = prompt;\n    if (systemPrompt) {\n      fullPrompt = `${systemPrompt}\\n\\n${prompt}`;\n    }\n\n    const payload = {\n      contents: [{\n        parts: [{\n          text: fullPrompt\n        }]\n      }],\n      generationConfig: {\n        temperature: 0.7,\n        maxOutputTokens: 1024,\n      }\n    };\n\n    const response = await fetch(endpoint, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Gemini API error: ${response.status} - ${errorText}`);\n    }\n\n    const data = await response.json();\n    return data.candidates?.[0]?.content?.parts?.[0]?.text || \"\";\n  }\n\n  private async callVertexAI(\n    prompt: string,\n    systemPrompt: string | undefined,\n    config: AIConfig\n  ): Promise<string> {\n    // Vertex AI via Cloudflare AI Gateway\n    // This would typically go through Cloudflare's AI Gateway for routing\n    const endpoint = `${config.endpoint}/projects/${this.env.VERTEX_AI_PROJECT}/locations/${this.env.VERTEX_AI_LOCATION || \"asia-southeast1\"}/publishers/google/models/${config.model}:predict`;\n\n    const messages: Array<{ role: string; content: string }> = [];\n    if (systemPrompt) {\n      messages.push({ role: \"system\", content: systemPrompt });\n    }\n    messages.push({ role: \"user\", content: prompt });\n\n    const payload = {\n      instances: [{\n        messages: messages\n      }],\n      parameters: {\n        temperature: 0.7,\n        maxOutputTokens: 1024,\n      }\n    };\n\n    const response = await fetch(endpoint, {\n      method: \"POST\",\n      headers: config.headers || {},\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      throw new Error(`Vertex AI error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return data.predictions?.[0]?.content || \"\";\n  }\n\n  private async callLocalAI(\n    prompt: string,\n    systemPrompt: string | undefined,\n    config: AIConfig\n  ): Promise<string> {\n    // Local Llama server (OpenAI-compatible API)\n    const messages: Array<{ role: string; content: string }> = [];\n    if (systemPrompt) {\n      messages.push({ role: \"system\", content: systemPrompt });\n    }\n    messages.push({ role: \"user\", content: prompt });\n\n    const payload = {\n      model: config.model,\n      messages: messages,\n      temperature: 0.7,\n    };\n\n    const response = await fetch(config.endpoint!, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      throw new Error(`Local AI error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return data.choices?.[0]?.message?.content || \"\";\n  }\n\n  /**\n   * Get current mode for logging/debugging\n   */\n  getMode(): SovereignMode {\n    return this.mode;\n  }\n}\n\n", "/**\n * PackagehaSession: The Being (Agent)\n * Stateful Durable Object that maintains conversation memory and follows the Charter\n */\n\nimport { getActiveProducts, createDraftOrder, CustomLineItem } from \"./shopify\";\nimport { \n    SALES_CHARTER, \n    PACKAGE_ORDER_CHARTER, \n    LAUNCH_KIT_CHARTER, \n    PACKAGING_ASSISTANT_CHARTER,\n    buildCharterPrompt \n} from \"./charter\";\nimport { SovereignSwitch } from \"./sovereign-switch\";\nimport { \n    Env, \n    Memory, \n    Product, \n    Variant, \n    AIDecision, \n    VariantDecision, \n    RequestBody,\n    AgentFlow,\n    PackageRecommendation\n} from \"./types\";\n\n// Default memory template - timestamps set when creating new memory\nconst DEFAULT_MEMORY_TEMPLATE: Omit<Memory, \"createdAt\" | \"lastActivity\"> = {\n    flow: \"direct_sales\",\n    step: \"start\",\n    clipboard: {},\n    questionIndex: 0,\n};\n\nconst GREETINGS = [\"hi\", \"hello\", \"hey\", \"hola\", \"\u0645\u0631\u062D\u0628\u0627\", \"\u0647\u0644\u0627\", \"\u0623\u0647\u0644\u0627\"];\nconst RESET_KEYWORDS = [\"reset\", \"\u0625\u0639\u0627\u062F\u0629\", \"start over\", \"new\", \"\u062C\u062F\u064A\u062F\"];\n\nexport class PackagehaSession {\n    state: DurableObjectState;\n    env: Env;\n    private sovereignSwitch: SovereignSwitch;\n\n    constructor(state: DurableObjectState, env: Env) {\n        this.state = state;\n        this.env = env;\n        this.sovereignSwitch = new SovereignSwitch(env);\n    }\n\n    async fetch(request: Request): Promise<Response> {\n        try {\n            // Parse request\n            const body = await this.parseRequestBody(request);\n            const userMessage = (body.message || \"\").trim();\n\n            // Handle reset\n            if (this.shouldReset(userMessage)) {\n                return await this.handleReset();\n            }\n\n            // Load or initialize memory\n            let memory = await this.loadMemory();\n\n            // Determine flow (explicit from request or from memory)\n            const requestedFlow = body.flow || memory.flow || \"direct_sales\";\n            if (!memory.flow || memory.flow !== requestedFlow) {\n                // Flow changed - reset to start of new flow\n                memory.flow = requestedFlow as AgentFlow;\n                memory.step = \"start\";\n                memory.clipboard = {};\n                memory.questionIndex = 0;\n            }\n\n            // Route to appropriate flow handler\n            let reply: string;\n            let memoryWasReset = false;\n            let draftOrder: any = undefined;\n            let productMatches: any[] | undefined = undefined;\n            \n            switch (memory.flow) {\n                case \"direct_sales\":\n                    const directSalesResult = await this.handleDirectSalesFlow(userMessage, memory);\n                    reply = directSalesResult.reply;\n                    memoryWasReset = directSalesResult.memoryReset || false;\n                    draftOrder = directSalesResult.draftOrder;\n                    productMatches = directSalesResult.productMatches;\n                    break;\n                case \"package_order\":\n                    const packageOrderResult = await this.handlePackageOrderFlow(userMessage, memory);\n                    reply = packageOrderResult.reply;\n                    memoryWasReset = packageOrderResult.memoryReset || false;\n                    draftOrder = packageOrderResult.draftOrder;\n                    productMatches = packageOrderResult.productMatches;\n                    break;\n                case \"launch_kit\":\n                    const launchKitResult = await this.handleLaunchKitFlow(userMessage, memory);\n                    reply = launchKitResult.reply;\n                    memoryWasReset = launchKitResult.memoryReset || false;\n                    draftOrder = launchKitResult.draftOrder;\n                    break;\n                case \"packaging_assistant\":\n                    const assistantResult = await this.handlePackagingAssistantFlow(userMessage, memory);\n                    reply = assistantResult.reply;\n                    memoryWasReset = assistantResult.memoryReset || false;\n                    break;\n                default:\n                    reply = \"I'm not sure what to do. Type 'reset' to start over.\";\n                    const now = Date.now();\n                    memory = {\n                        flow: DEFAULT_MEMORY_TEMPLATE.flow,\n                        step: DEFAULT_MEMORY_TEMPLATE.step,\n                        clipboard: {},\n                        questionIndex: DEFAULT_MEMORY_TEMPLATE.questionIndex,\n                        createdAt: now,\n                        lastActivity: now,\n                    };\n            }\n\n            // Save memory if it wasn't reset (deleted)\n            // Note: We always save when !memoryWasReset because:\n            // - If memory exists in storage, we're updating it\n            // - If memory doesn't exist, it was newly created by loadMemory() and should be persisted\n            // - The only time we don't save is when memoryWasReset=true (explicitly deleted)\n            if (!memoryWasReset) {\n                // Update memory timestamp and save\n                memory.lastActivity = Date.now();\n                await this.state.storage.put(\"memory\", memory);\n            }\n\n            // Build response with optional fields\n            const response: any = { reply };\n            if (draftOrder) response.draftOrder = draftOrder;\n            if (productMatches) response.productMatches = productMatches;\n            \n            // Add flow state for UI tracking\n            response.flowState = {\n                step: memory.step,\n                packageName: memory.packageName, // Packageha's package (what we sell), NOT client's product\n                variantName: memory.selectedVariantName,\n                hasPackage: !!memory.packageId, // Packageha's package selected, NOT client's product\n                hasVariant: !!memory.selectedVariantId,\n                questionIndex: memory.questionIndex\n            };\n            \n            // Add variant options if we're in variant selection step OR if package is selected but variant isn't\n            // This helps frontend know what variants are available even if we haven't explicitly asked yet\n            if (memory.packageId && memory.variants && !memory.selectedVariantId) {\n                // Include variants for variant selection steps\n                if (memory.step === \"ask_variant\" || memory.step === \"select_package_variant\" || \n                    (memory.step === \"consultation\" && memory.variants.length > 1)) {\n                    response.variants = memory.variants.map(v => ({\n                        id: v.id,\n                        title: v.title,\n                        price: v.price\n                    }));\n                }\n            }\n            \n            // Add current consultation question based on current step\n            let consultationPhase: { mission: string; steps: any[] } | null = null;\n            if (memory.step === \"product_details\" && SALES_CHARTER.productDetails) {\n                consultationPhase = SALES_CHARTER.productDetails;\n            } else if (memory.step === \"select_package_specs\" && SALES_CHARTER.packageSpecs) {\n                consultationPhase = SALES_CHARTER.packageSpecs;\n            } else if (memory.step === \"fulfillment_specs\" && SALES_CHARTER.fulfillmentSpecs) {\n                consultationPhase = SALES_CHARTER.fulfillmentSpecs;\n            } else if (memory.step === \"launch_kit\" && SALES_CHARTER.launchKit) {\n                consultationPhase = SALES_CHARTER.launchKit;\n            } else if (memory.step === \"consultation\") {\n                // Legacy consultation step (for old flows)\n                let charter;\n                if (memory.flow === \"direct_sales\") {\n                    charter = SALES_CHARTER;\n                } else if (memory.flow === \"package_order\") {\n                    charter = PACKAGE_ORDER_CHARTER;\n                }\n                if (charter && charter.consultation) {\n                    consultationPhase = charter.consultation;\n                }\n            }\n            \n            if (consultationPhase) {\n                const steps = consultationPhase.steps;\n                const currentIndex = memory.questionIndex;\n                if (currentIndex < steps.length) {\n                    const currentStep = steps[currentIndex];\n                    // Generate default value based on product/variant info if applicable\n                    let defaultValue = null;\n                    if (currentStep.id === \"quantity\" && memory.clipboard[\"quantity\"]) {\n                        defaultValue = memory.clipboard[\"quantity\"];\n                    } else if (currentStep.id === \"dimensions\" || currentStep.id === \"product_dimensions\") {\n                        // Could suggest based on product type, but for now leave empty\n                        defaultValue = \"\";\n                    }\n                    \n                    response.currentQuestion = {\n                        id: currentStep.id,\n                        question: currentStep.question,\n                        options: (currentStep as any).options || null,\n                        multiple: (currentStep as any).multiple !== undefined ? (currentStep as any).multiple : true, // Default to multiple if not specified\n                        defaultValue: defaultValue\n                    };\n                }\n            }\n\n            return this.jsonResponse(response);\n\n        } catch (error: any) {\n            console.error(\"[PackagehaSession] Error:\", error);\n            return this.jsonResponse({ \n                reply: \"I encountered an error. Please try again or type 'reset' to start over.\" \n            }, 500);\n        }\n    }\n\n    // ==================== FLOW HANDLERS ====================\n\n    /**\n     * Direct Sales Flow - New structure with multiple steps\n     * Steps: product_details -> select_package -> fulfillment_specs -> launch_kit -> draft_order\n     */\n    private async handleDirectSalesFlow(\n        userMessage: string, \n        memory: Memory\n    ): Promise<{ reply: string; memoryReset?: boolean; draftOrder?: any; productMatches?: any[] }> {\n        switch (memory.step) {\n            case \"start\":\n                // Start with product details step\n                memory.step = \"product_details\";\n                memory.questionIndex = 0;\n                if (!SALES_CHARTER.productDetails) {\n                    return { reply: \"Error: Product details configuration missing.\" };\n                }\n                return { reply: SALES_CHARTER.productDetails.steps[0].question };\n                \n            case \"product_details\":\n                return await this.handleConsultationPhase(\n                    userMessage, \n                    memory, \n                    SALES_CHARTER.productDetails!,\n                    \"select_package\"\n                );\n                \n            case \"select_package\":\n            case \"select_package_discovery\":\n                // Handle package discovery/search\n                return await this.handlePackageSelection(userMessage, memory);\n                \n            case \"select_package_variant\":\n                // Handle variant selection\n                return await this.handleVariantSelection(userMessage, memory, SALES_CHARTER);\n                \n            case \"select_package_specs\":\n                // Handle package specifications (material, dimensions, print)\n                return await this.handleConsultationPhase(\n                    userMessage,\n                    memory,\n                    SALES_CHARTER.packageSpecs!,\n                    \"fulfillment_specs\"\n                );\n                \n            case \"fulfillment_specs\":\n                return await this.handleConsultationPhase(\n                    userMessage,\n                    memory,\n                    SALES_CHARTER.fulfillmentSpecs!,\n                    \"launch_kit\"\n                );\n                \n            case \"launch_kit\":\n                return await this.handleConsultationPhase(\n                    userMessage,\n                    memory,\n                    SALES_CHARTER.launchKit!,\n                    \"draft_order\"\n                );\n                \n            case \"draft_order\":\n                return await this.createProjectQuote(memory);\n                \n            default:\n                memory.step = \"start\";\n                return await this.handleDirectSalesFlow(userMessage, memory);\n        }\n    }\n\n    /**\n     * Package Ordering Flow (simplified MVP)\n     */\n    private async handlePackageOrderFlow(\n        userMessage: string,\n        memory: Memory\n    ): Promise<{ reply: string; memoryReset?: boolean; draftOrder?: any; productMatches?: any[] }> {\n        switch (memory.step) {\n            case \"start\":\n            case \"select_product\":\n                return await this.handleDiscovery(userMessage, memory, PACKAGE_ORDER_CHARTER);\n            case \"ask_variant\":\n                return await this.handleVariantSelection(userMessage, memory, PACKAGE_ORDER_CHARTER);\n            case \"consultation\":\n                return await this.handleConsultation(userMessage, memory, PACKAGE_ORDER_CHARTER);\n            default:\n                memory.step = \"start\";\n                return await this.handleDiscovery(userMessage, memory, PACKAGE_ORDER_CHARTER);\n        }\n    }\n\n    /**\n     * Launch Kit Flow\n     */\n    private async handleLaunchKitFlow(\n        userMessage: string,\n        memory: Memory\n    ): Promise<{ reply: string; memoryReset?: boolean }> {\n        switch (memory.step) {\n            case \"start\":\n                return { reply: await this.handleLaunchKitStart(userMessage, memory) };\n            case \"select_services\":\n                return await this.handleLaunchKitServiceSelection(userMessage, memory);\n            case \"consultation\":\n                return await this.handleConsultation(userMessage, memory, LAUNCH_KIT_CHARTER);\n            default:\n                memory.step = \"start\";\n                return { reply: await this.handleLaunchKitStart(userMessage, memory) };\n        }\n    }\n\n    /**\n     * Packaging Assistant Flow\n     */\n    private async handlePackagingAssistantFlow(\n        userMessage: string,\n        memory: Memory\n    ): Promise<{ reply: string; memoryReset?: boolean }> {\n        switch (memory.step) {\n            case \"start\":\n                return { reply: await this.handlePackagingAssistantStart(userMessage, memory) };\n            case \"consultation\":\n                return await this.handlePackagingAssistantConsultation(userMessage, memory);\n            case \"show_recommendations\":\n                return await this.handlePackagingAssistantRecommendations(userMessage, memory);\n            default:\n                memory.step = \"start\";\n                return { reply: await this.handlePackagingAssistantStart(userMessage, memory) };\n        }\n    }\n\n    // ==================== SHARED HANDLERS ====================\n\n    /**\n     * Get products (with caching for 5 minutes)\n     */\n    private async getCachedProducts(): Promise<any[]> {\n        const cacheKey = \"products_cache\";\n        const cacheTimestampKey = \"products_cache_timestamp\";\n        const CACHE_TTL = 5 * 60 * 1000; // 5 minutes\n\n        try {\n            // Check cache\n            const cached = await this.state.storage.get<any[]>(cacheKey);\n            const timestamp = await this.state.storage.get<number>(cacheTimestampKey);\n            \n            if (cached && timestamp && (Date.now() - timestamp) < CACHE_TTL) {\n                console.log(\"[getCachedProducts] Using cached products\");\n                return cached;\n            }\n\n            // Fetch fresh products\n            console.log(\"[getCachedProducts] Fetching fresh products\");\n            const products = await getActiveProducts(\n                this.env.SHOP_URL,\n                this.env.SHOPIFY_ACCESS_TOKEN\n            );\n\n            // Cache products\n            await this.state.storage.put(cacheKey, products);\n            await this.state.storage.put(cacheTimestampKey, Date.now());\n\n            return products;\n        } catch (error: any) {\n            console.error(\"[getCachedProducts] Error:\", error);\n            throw error;\n        }\n    }\n\n    private async handleDiscovery(userMessage: string, memory: Memory, charter: any): Promise<{ reply: string; productMatches?: any[] }> {\n        // If we're in select_product or select_package_discovery step, check if user is selecting a number first\n        if ((memory.step === \"select_product\" || memory.step === \"select_package_discovery\") && memory.pendingMatches) {\n            const numMatch = userMessage.trim().match(/^(\\d+)$/);\n            if (numMatch) {\n                const selectedNum = parseInt(numMatch[1]) - 1;\n                if (selectedNum >= 0 && selectedNum < memory.pendingMatches.length) {\n                    // User selected a package - get the package index from the match\n                    const selectedPackageIndex = memory.pendingMatches[selectedNum].id;\n                    \n                    // Fetch packages from Shopify (they call them \"products\" in their API)\n                    let products;\n                    try {\n                        products = await this.getCachedProducts();\n                    } catch (error: any) {\n                        return { reply: \"I'm having trouble accessing the package catalog. Please try again later.\" };\n                    }\n                    \n                    const packageProduct = products[selectedPackageIndex];\n                    if (!packageProduct) {\n                        return { reply: \"I found a match but couldn't load the package details. Please try again.\" };\n                    }\n\n                    // Store package info (Packageha's package, not client's product)\n                    memory.packageName = packageProduct.title;\n                    memory.packageId = packageProduct.id;\n                    memory.variants = packageProduct.variants.map((v: any) => ({\n                        id: v.id,\n                        title: v.title,\n                        price: v.price,\n                    }));\n                    memory.pendingMatches = undefined; // Clear pending matches\n\n                    // Auto-skip variant selection if only one variant\n                    if (memory.variants.length === 1) {\n                        memory.selectedVariantId = memory.variants[0].id;\n                        // Use \"Default\" instead of the variant title when auto-selecting single variant\n                        memory.selectedVariantName = \"Default\";\n                        // For direct_sales flow, use select_package_specs instead of consultation\n                        if (memory.flow === \"direct_sales\") {\n                            memory.step = \"select_package_specs\";\n                            memory.questionIndex = 0;\n                            if (!SALES_CHARTER.packageSpecs) {\n                                return { reply: \"Error: Package specs configuration missing.\" };\n                            }\n                            return { reply: `Found **${packageProduct.title}**.\\n\\n${SALES_CHARTER.packageSpecs.steps[0].question}` };\n                        } else {\n                            // Legacy flow\n                            memory.step = \"consultation\";\n                            memory.questionIndex = 0;\n                            return { reply: `Found **${packageProduct.title}**.\\n\\nLet's get your project details.\\n\\n${charter.consultation.steps[0].question}` };\n                        }\n                    }\n\n                    // Ask for variant selection\n                    // For direct_sales flow, use select_package_variant instead of ask_variant\n                    if (memory.flow === \"direct_sales\") {\n                        memory.step = \"select_package_variant\";\n                    } else {\n                        memory.step = \"ask_variant\";\n                    }\n                    const options = memory.variants.map(v => v.title).join(\", \");\n                    return { reply: `Found **${packageProduct.title}**.\\n\\nWhich type are you interested in?\\n\\nOptions: ${options}` };\n                } else {\n                    // Invalid number\n                    const matchesList = memory.pendingMatches.map((m, i) => `${i + 1}. **${m.name}** - ${m.reason}`).join(\"\\n\");\n                    return {\n                        reply: `Please select a number between 1 and ${memory.pendingMatches.length}:\\n\\n${matchesList}`,\n                        productMatches: memory.pendingMatches\n                    };\n                }\n            } else {\n                // User didn't provide a valid number - could be searching again or invalid input\n                // Continue to search logic below\n                memory.pendingMatches = undefined;\n                // Don't reset step to \"start\" if we're in select_package_discovery - keep the current step\n                if (memory.step !== \"select_package_discovery\" && memory.step !== \"select_package\") {\n                    memory.step = \"start\";\n                }\n            }\n        }\n        \n        // Handle greetings locally (save AI cost)\n        if (this.isGreeting(userMessage)) {\n            return { reply: \"Hello! I'm your packaging consultant. What are you looking for? (e.g., 'Custom Boxes', 'Bags', 'Printing Services')\" };\n        }\n\n        // Fetch packages from Shopify (they call them \"products\" in their API, but these are Packageha packages)\n        let products;\n        try {\n            products = await this.getCachedProducts();\n        } catch (error: any) {\n            console.error(\"[handleDiscovery] Error fetching packages:\", error);\n            return { reply: \"I'm having trouble accessing the package catalog. Please try again later.\" };\n        }\n\n        if (products.length === 0) {\n            return { reply: \"I'm having trouble accessing the package catalog. Please try again later.\" };\n        }\n\n        // Prepare inventory context - include full product names (including Arabic) for better AI reasoning\n        const inventoryList = products.map((p, index) => {\n            const cleanTitle = p.title.replace(/TEST\\s?-\\s?|rs-/gi, \"\").trim();\n            return `ID ${index}: ${cleanTitle}`;\n        }).join(\"\\n\");\n\n        // Build AI prompt with Charter - request multiple matches if available\n        const systemPrompt = buildCharterPrompt(\"discovery\", charter);\n        \n        // Include product details context if available (for direct sales flow)\n        let productContext = '';\n        if (memory.clipboard && Object.keys(memory.clipboard).length > 0) {\n            const contextParts = [];\n            if (memory.clipboard.product_description) {\n                contextParts.push(`Product: ${memory.clipboard.product_description}`);\n            }\n            if (memory.clipboard.product_dimensions) {\n                contextParts.push(`Dimensions: ${memory.clipboard.product_dimensions}`);\n            }\n            if (memory.clipboard.product_weight) {\n                contextParts.push(`Weight: ${memory.clipboard.product_weight}`);\n            }\n            if (memory.clipboard.fragility) {\n                contextParts.push(`Fragility: ${memory.clipboard.fragility}`);\n            }\n            if (memory.clipboard.budget) {\n                contextParts.push(`Budget: ${memory.clipboard.budget}`);\n            }\n            if (contextParts.length > 0) {\n                productContext = `\\n\\nProduct Details:\\n${contextParts.join('\\n')}\\n\\nUse this context to recommend the most suitable packaging solution.`;\n            }\n        }\n        \n        const userPrompt = `Inventory:\\n${inventoryList}\\n\\nUser Input: \"${userMessage}\"${productContext}\\n\\nReturn JSON:\\n- If single match: { \"type\": \"found\", \"id\": <index>, \"reason\": \"...\" }\\n- If multiple matches: { \"type\": \"multiple\", \"matches\": [{\"id\": <index>, \"name\": \"<product_name>\", \"reason\": \"...\"}, ...] }\\n- If chatting: { \"type\": \"chat\", \"reply\": \"...\" }\\n- If no match: { \"type\": \"none\", \"reason\": \"...\" }`;\n\n        // Get AI decision\n        const decision = await this.getAIDecision(userPrompt, systemPrompt);\n\n        // Process decision\n        if (decision.type === \"chat\") {\n            return { reply: decision.reply || \"I focus on packaging solutions. What are you looking for?\" };\n        }\n\n        if (decision.type === \"none\") {\n            return { reply: \"I couldn't find that product. We offer Boxes, Bags, and Printing services. What do you need?\" };\n        }\n\n        // Handle multiple matches - return for user selection\n        if (decision.type === \"multiple\" && decision.matches && decision.matches.length > 0) {\n            const matches = decision.matches\n                .filter(m => m.id !== undefined && products[m.id])\n                .slice(0, 5) // Limit to 5 matches\n                .map(m => ({\n                    id: m.id!,\n                    packageId: products[m.id!].id, // Packageha's package ID\n                    name: products[m.id!].title,\n                    reason: m.reason || \"Matches your search\"\n                }));\n\n            // Keep the current step (select_package_discovery) instead of resetting to select_product\n            // Only set to select_product if we're in the old flow\n            if (memory.step !== \"select_package_discovery\" && memory.step !== \"select_package\") {\n                memory.step = \"select_product\";\n            }\n            memory.pendingMatches = matches;\n\n            const matchesList = matches.map((m, i) => `${i + 1}. **${m.name}** - ${m.reason}`).join(\"\\n\");\n            return {\n                reply: `I found ${matches.length} matching packages:\\n\\n${matchesList}\\n\\nPlease select a package by number (1-${matches.length}) or describe what you need more specifically.`,\n                productMatches: matches\n            };\n        }\n\n        // Handle single match\n        const selectedPackageIndex = decision.id;\n\n        if (selectedPackageIndex !== undefined && products[selectedPackageIndex]) {\n            const packageProduct = products[selectedPackageIndex];\n            if (!packageProduct) {\n                return { reply: \"I found a match but couldn't load the package details. Please try again.\" };\n            }\n\n            // Store package info (Packageha's package, not client's product)\n            memory.packageName = packageProduct.title;\n            memory.packageId = packageProduct.id;\n            memory.variants = packageProduct.variants.map((v: any) => ({\n                id: v.id,\n                title: v.title,\n                price: v.price,\n            }));\n\n            // Auto-skip variant selection if only one variant\n            if (memory.variants.length === 1) {\n                memory.selectedVariantId = memory.variants[0].id;\n                memory.selectedVariantName = \"Default\";\n                // For direct_sales flow, use select_package_specs instead of consultation\n                if (memory.flow === \"direct_sales\") {\n                    memory.step = \"select_package_specs\";\n                    memory.questionIndex = 0;\n                    if (!SALES_CHARTER.packageSpecs) {\n                        return { reply: \"Error: Package specs configuration missing.\" };\n                    }\n                    return { reply: `Found **${packageProduct.title}**.\\n\\n${SALES_CHARTER.packageSpecs.steps[0].question}` };\n                } else {\n                    // Legacy flow\n                    memory.step = \"consultation\";\n                    memory.questionIndex = 0;\n                    return { reply: `Found **${packageProduct.title}**.\\n\\nLet's get your project details.\\n\\n${charter.consultation.steps[0].question}` };\n                }\n            }\n\n            // Ask for variant selection\n            // For direct_sales flow, use select_package_variant instead of ask_variant\n            if (memory.flow === \"direct_sales\") {\n                memory.step = \"select_package_variant\";\n            } else {\n                memory.step = \"ask_variant\";\n            }\n            const options = memory.variants.map(v => v.title).join(\", \");\n            return { reply: `Found **${packageProduct.title}**.\\n\\nWhich type are you interested in?\\n\\nOptions: ${options}` };\n        }\n\n        return { reply: \"I'm not sure how to help with that. What packaging solution are you looking for?\" };\n    }\n\n    private async handleVariantSelection(\n        userMessage: string, \n        memory: Memory,\n        charter: any\n    ): Promise<{ reply: string; memoryReset?: boolean }> {\n        // Allow restarting search\n        if (this.shouldRestartSearch(userMessage)) {\n            await this.state.storage.delete(\"memory\");\n            return { \n                reply: \"Okay, let's start over. What are you looking for?\",\n                memoryReset: true \n            };\n        }\n\n        if (!memory.variants || memory.variants.length === 0) {\n            return { \n                reply: \"I lost track of the product options. Type 'reset' to start over.\" \n            };\n        }\n\n        // Build context\n        const optionsContext = memory.variants.map((v, i) => `ID ${i}: ${v.title}`).join(\"\\n\");\n\n        // Get AI decision\n        const systemPrompt = buildCharterPrompt(\"variant\", charter);\n        const userPrompt = `Options:\\n${optionsContext}\\n\\nUser: \"${userMessage}\"\\n\\nReturn JSON:\\n- If match: { \"match\": true, \"id\": <index> }\\n- If no match: { \"match\": false, \"reply\": \"...\" }`;\n\n        const decision = await this.getVariantDecision(userPrompt, systemPrompt);\n\n        if (decision.match && decision.id !== undefined && memory.variants[decision.id]) {\n            const selected = memory.variants[decision.id];\n            memory.selectedVariantId = selected.id;\n            memory.selectedVariantName = selected.title === \"Default Title\" ? \"Default\" : selected.title;\n            \n            // Move to package specs phase\n            memory.step = \"select_package_specs\";\n            memory.questionIndex = 0;\n            if (!SALES_CHARTER.packageSpecs) {\n                return { reply: \"Error: Package specs configuration missing.\" };\n            }\n            return { \n                reply: `Selected **${selected.title}**.\\n\\n${SALES_CHARTER.packageSpecs.steps[0].question}` \n            };\n        }\n\n        return { \n            reply: decision.reply || \"Please select one of the options listed above.\" \n        };\n    }\n\n    /**\n     * Generic consultation handler for any consultation phase\n     * @param nextStep - The step to move to after this consultation is complete\n     */\n    private async handleConsultationPhase(\n        userMessage: string, \n        memory: Memory,\n        consultationPhase: { mission: string; steps: any[] },\n        nextStep: string\n    ): Promise<{ reply: string; memoryReset?: boolean; draftOrder?: any }> {\n        const steps = consultationPhase.steps;\n        const currentIndex = memory.questionIndex;\n\n        if (currentIndex >= steps.length) {\n            // All questions answered - move to next step\n            // This shouldn't happen if we're handling questions properly, but handle gracefully\n            memory.step = nextStep;\n            memory.questionIndex = 0;\n            if (nextStep === \"draft_order\") {\n                return await this.createProjectQuote(memory);\n            }\n            return this.getNextStepPrompt(nextStep);\n        }\n\n        const currentStep = steps[currentIndex];\n\n        // Validate answer if validator exists\n        if (currentStep.validation) {\n            const validationResult = currentStep.validation(userMessage);\n            if (validationResult !== true) {\n                return { \n                    reply: typeof validationResult === \"string\" \n                        ? validationResult \n                        : \"Please provide a valid answer.\" \n                };\n            }\n        }\n\n        // Store answer\n        memory.clipboard[currentStep.id] = userMessage;\n\n        // Check if there are more questions\n        if (currentIndex < steps.length - 1) {\n            memory.questionIndex = currentIndex + 1;\n            const nextStepQ = steps[memory.questionIndex];\n            return { reply: nextStepQ.question };\n        }\n\n        // Last question answered - move to next phase\n        memory.step = nextStep;\n        memory.questionIndex = 0;\n        if (nextStep === \"draft_order\") {\n            return await this.createProjectQuote(memory);\n        }\n        return this.getNextStepPrompt(nextStep);\n    }\n\n    /**\n     * Helper to get the prompt for the next step after a consultation phase completes\n     */\n    private getNextStepPrompt(nextStep: string): { reply: string } {\n        if (nextStep === \"select_package\") {\n            return { reply: \"Great! Now let's find the perfect package for your product. What type of packaging are you looking for?\" };\n        } else if (nextStep === \"fulfillment_specs\") {\n            if (!SALES_CHARTER.fulfillmentSpecs) {\n                return { reply: \"Error: Fulfillment specs configuration missing.\" };\n            }\n            return { reply: SALES_CHARTER.fulfillmentSpecs.steps[0].question };\n        } else if (nextStep === \"launch_kit\") {\n            if (!SALES_CHARTER.launchKit) {\n                return { reply: \"Error: Launch kit configuration missing.\" };\n            }\n            return { reply: SALES_CHARTER.launchKit.steps[0].question };\n        }\n        \n        return { reply: \"Moving to next step...\" };\n    }\n\n    /**\n     * Handle package selection (discovery -> variant -> specs)\n     */\n    private async handlePackageSelection(\n        userMessage: string,\n        memory: Memory\n    ): Promise<{ reply: string; productMatches?: any[] }> {\n        // If we haven't selected a package yet, do discovery\n        if (!memory.packageId) {\n            // If message is empty or just whitespace, return a prompt (don't call handleDiscovery)\n            if (!userMessage || userMessage.trim() === \"\") {\n                memory.step = \"select_package_discovery\";\n                return { reply: \"Great! Now let's find the perfect package for your product. What type of packaging are you looking for?\" };\n            }\n            \n            memory.step = \"select_package_discovery\";\n            const result = await this.handleDiscovery(userMessage, memory, SALES_CHARTER);\n            \n            // If discovery returned productMatches (multiple matches), return them immediately\n            if (result.productMatches && result.productMatches.length > 0) {\n                return result;\n            }\n            \n            // If discovery found a package, handle variant selection\n            if (memory.packageId && memory.variants) {\n                if (memory.variants.length === 1) {\n                    // Auto-select single variant\n                    memory.selectedVariantId = memory.variants[0].id;\n                    memory.selectedVariantName = \"Default\";\n                    memory.step = \"select_package_specs\";\n                    memory.questionIndex = 0;\n                    if (!SALES_CHARTER.packageSpecs) {\n                        return { reply: \"Error: Package specs configuration missing.\" };\n                    }\n                    return { reply: SALES_CHARTER.packageSpecs.steps[0].question };\n                } else {\n                    // Ask for variant\n                    memory.step = \"select_package_variant\";\n                    const options = memory.variants.map(v => v.title).join(\", \");\n                    return { reply: `Found **${memory.packageName}**.\\n\\nWhich type are you interested in?\\n\\nOptions: ${options}` };\n                }\n            }\n            \n            return result;\n        }\n        \n        // Package already selected - this shouldn't happen, but handle gracefully\n        return { reply: \"Package already selected. Moving forward...\" };\n    }\n\n    private async handleConsultation(\n        userMessage: string, \n        memory: Memory,\n        charter: any\n    ): Promise<{ reply: string; memoryReset?: boolean; draftOrder?: any }> {\n        const steps = charter.consultation.steps;\n        const currentIndex = memory.questionIndex;\n\n        if (currentIndex >= steps.length) {\n            return { reply: \"I've collected all the information. Generating your quote...\" };\n        }\n\n        const currentStep = steps[currentIndex];\n\n        // Validate answer if validator exists\n        if (currentStep.validation) {\n            const validationResult = currentStep.validation(userMessage);\n            if (validationResult !== true) {\n                return { \n                    reply: typeof validationResult === \"string\" \n                        ? validationResult \n                        : \"Please provide a valid answer.\" \n                };\n            }\n        }\n\n        // Store answer\n        memory.clipboard[currentStep.id] = userMessage;\n\n        // Check if there are more questions\n        if (currentIndex < steps.length - 1) {\n            memory.questionIndex = currentIndex + 1;\n            const nextStep = steps[memory.questionIndex];\n            return { reply: nextStep.question };\n        }\n\n        // All questions answered - create draft order\n        return await this.createProjectQuote(memory);\n    }\n\n    // ==================== HELPER METHODS ====================\n\n    private async createProjectQuote(\n        memory: Memory\n    ): Promise<{ reply: string; memoryReset?: boolean; draftOrder?: any }> {\n        // Package selection is optional (might be services only)\n        // But typically we need at least package or services\n        \n        // Collect all answers from all consultation phases\n        const allAnswers: string[] = [];\n        \n        // Product Details\n        if (SALES_CHARTER.productDetails) {\n            SALES_CHARTER.productDetails.steps.forEach(step => {\n                const answer = memory.clipboard[step.id];\n                if (answer) {\n                    allAnswers.push(`- ${step.id.toUpperCase()}: ${answer}`);\n                }\n            });\n        }\n        \n        // Package Specs\n        if (SALES_CHARTER.packageSpecs) {\n            SALES_CHARTER.packageSpecs.steps.forEach(step => {\n                const answer = memory.clipboard[step.id];\n                if (answer) {\n                    allAnswers.push(`- PACKAGE ${step.id.toUpperCase()}: ${answer}`);\n                }\n            });\n        }\n        \n        // Fulfillment Specs\n        if (SALES_CHARTER.fulfillmentSpecs) {\n            SALES_CHARTER.fulfillmentSpecs.steps.forEach(step => {\n                const answer = memory.clipboard[step.id];\n                if (answer) {\n                    allAnswers.push(`- FULFILLMENT ${step.id.toUpperCase()}: ${answer}`);\n                }\n            });\n        }\n        \n        // Launch Kit\n        if (SALES_CHARTER.launchKit) {\n            SALES_CHARTER.launchKit.steps.forEach(step => {\n                const answer = memory.clipboard[step.id];\n                if (answer) {\n                    allAnswers.push(`- LAUNCH KIT ${step.id.toUpperCase()}: ${answer}`);\n                }\n            });\n        }\n        \n        // Format project brief\n        const briefNote = `--- PROJECT BRIEF ---\nPackage: ${memory.selectedVariantName || memory.packageName || \"Not selected\"}\n${allAnswers.join(\"\\n\")}\n---------------------\nGenerated by Studium AI Agent (${SALES_CHARTER.meta.name})\nTimestamp: ${new Date().toISOString()}\n`;\n\n        // Parse quantity safely\n        const qtyRaw = memory.clipboard['quantity'] || \"1\";\n        const qtyNum = parseInt(qtyRaw.replace(/\\D/g, '')) || 1;\n\n        // Build custom line items for Launch Kit services\n        const customLineItems: CustomLineItem[] = [];\n        const serviceSelection = memory.clipboard['service_selection'];\n        if (serviceSelection && serviceSelection !== \"None - skip launch services\") {\n            // Parse service selection (could be comma-separated or array-like)\n            const services = serviceSelection.split(',').map(s => s.trim()).filter(s => s && s !== \"None - skip launch services\");\n            \n            // Default pricing for services (can be configured later)\n            const servicePricing: Record<string, string> = {\n                \"Hero shot photography\": \"500.00\",\n                \"Stop-motion unboxing video\": \"800.00\",\n                \"E-commerce product photos\": \"400.00\",\n                \"3D render with packaging for website\": \"600.00\",\n                \"Package design consultation\": \"300.00\",\n                \"Brand styling consultation\": \"350.00\"\n            };\n            \n            services.forEach(service => {\n                const price = servicePricing[service] || \"500.00\"; // Default price\n                customLineItems.push({\n                    title: service,\n                    price: price,\n                    quantity: 1\n                });\n            });\n        }\n\n        try {\n            const draftOrder = await createDraftOrder(\n                this.env.SHOP_URL,\n                this.env.SHOPIFY_ACCESS_TOKEN,\n                memory.selectedVariantId || null, // Allow null if no package selected\n                qtyNum,\n                briefNote,\n                customLineItems.length > 0 ? customLineItems : undefined\n            );\n\n            // createDraftOrder throws on error, so if we reach here, draftOrder is valid\n            // Reset memory for new project\n            await this.state.storage.delete(\"memory\");\n            \n            // Return structured response with draft order info\n            return { \n                reply: `\u2705 **Project Brief Created!**\\n\\nI've attached all your specifications to the order. Please review and complete your purchase.\\n\\nType 'reset' to start a new project.`,\n                memoryReset: true,\n                draftOrder: {\n                    id: draftOrder.draftOrderId,\n                    adminUrl: draftOrder.adminUrl,\n                    invoiceUrl: draftOrder.invoiceUrl\n                }\n            };\n        } catch (error: any) {\n            console.error(\"[createProjectQuote] Error:\", error);\n            return { \n                reply: `\u26A0\uFE0F I encountered an error while creating your quote. Please try again or contact support.` \n            };\n        }\n    }\n\n    private async getAIDecision(prompt: string, systemPrompt: string): Promise<AIDecision> {\n        try {\n            const response = await this.sovereignSwitch.callAI(prompt, systemPrompt);\n            const cleanJson = this.sanitizeJSON(response);\n            const decision = JSON.parse(cleanJson) as AIDecision;\n            \n            // Validate decision structure\n            if (!decision.type || ![\"found\", \"chat\", \"none\", \"multiple\"].includes(decision.type)) {\n                throw new Error(\"Invalid decision type\");\n            }\n            \n            return decision;\n        } catch (error: any) {\n            console.error(\"[getAIDecision] Error:\", error);\n            return { \n                type: \"chat\", \n                reply: \"I'm having trouble processing that. Could you rephrase your request?\" \n            };\n        }\n    }\n\n    private async getVariantDecision(prompt: string, systemPrompt: string): Promise<VariantDecision> {\n        try {\n            const response = await this.sovereignSwitch.callAI(prompt, systemPrompt);\n            const cleanJson = this.sanitizeJSON(response);\n            const decision = JSON.parse(cleanJson) as VariantDecision;\n            return decision;\n        } catch (error: any) {\n            console.error(\"[getVariantDecision] Error:\", error);\n            return { match: false, reply: \"I'm having trouble understanding. Please select an option from the list.\" };\n        }\n    }\n\n    private sanitizeJSON(text: string): string {\n        // Remove markdown code blocks\n        return text.replace(/```json|```/g, \"\").trim();\n    }\n\n    private async loadMemory(): Promise<Memory> {\n        const stored = await this.state.storage.get<Memory>(\"memory\");\n        if (!stored) {\n            // Create new memory with fresh timestamps and a fresh clipboard object\n            // Important: Create a new clipboard object to avoid sharing references\n            const now = Date.now();\n            return {\n                flow: DEFAULT_MEMORY_TEMPLATE.flow,\n                step: DEFAULT_MEMORY_TEMPLATE.step,\n                clipboard: {}, // Fresh object, not shared reference\n                questionIndex: DEFAULT_MEMORY_TEMPLATE.questionIndex,\n                createdAt: now,\n                lastActivity: now,\n            };\n        }\n        // Ensure flow exists for old memories\n        if (!stored.flow) {\n            stored.flow = \"direct_sales\";\n        }\n        return stored;\n    }\n\n    private async handleReset(): Promise<Response> {\n        await this.state.storage.delete(\"memory\");\n        return this.jsonResponse({ \n            reply: \"\u267B\uFE0F Memory reset. Starting fresh! What packaging solution are you looking for?\" \n        });\n    }\n\n    private async parseRequestBody(request: Request): Promise<RequestBody> {\n        try {\n            return await request.json() as RequestBody;\n        } catch {\n            return {};\n        }\n    }\n\n    private shouldReset(message: string): boolean {\n        const lower = message.toLowerCase().trim();\n        // Use word boundary matching to avoid false positives\n        // Match reset keywords as whole words only (not substrings)\n        return RESET_KEYWORDS.some(keyword => {\n            const keywordLower = keyword.toLowerCase();\n            // Escape special regex characters in keyword\n            const escapedKeyword = keywordLower.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n            // Match as whole word using word boundaries\n            const regex = new RegExp(`\\\\b${escapedKeyword}\\\\b`, 'i');\n            return regex.test(lower);\n        });\n    }\n\n    private shouldRestartSearch(message: string): boolean {\n        const lower = message.toLowerCase();\n        return lower.includes(\"search\") || lower.includes(\"change\") || lower.includes(\"different\");\n    }\n\n    private isGreeting(message: string): boolean {\n        return GREETINGS.includes(message.toLowerCase());\n    }\n\n    private jsonResponse(data: any, status: number = 200): Response {\n        return new Response(JSON.stringify(data), {\n            status,\n            headers: {\n                \"Content-Type\": \"application/json\",\n                \"Access-Control-Allow-Origin\": \"*\",\n            },\n        });\n    }\n}\n", "import { PackagehaSession } from \"./session\";\r\nimport { Env } from \"./types\";\r\nimport { SovereignSwitch } from \"./sovereign-switch\";\r\n\r\nexport { PackagehaSession };\r\n\r\n/**\r\n * Main Worker Entry Point\r\n * Routes requests to stateful Durable Object sessions\r\n */\r\nexport default {\r\n  async fetch(request: Request, env: Env): Promise<Response> {\r\n    // Handle CORS preflight\r\n    if (request.method === \"OPTIONS\") {\r\n      return new Response(null, { \r\n        headers: {\r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\r\n          \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n          \"Access-Control-Max-Age\": \"86400\",\r\n        } \r\n      });\r\n    }\r\n\r\n    // Route POST requests to Durable Object session\r\n    if (request.method === \"POST\") {\r\n      // Use IP address for session ID (could also use user ID from auth)\r\n      const cfIp = request.headers.get(\"CF-Connecting-IP\");\r\n      const forwardedFor = request.headers.get(\"X-Forwarded-For\");\r\n      \r\n      let ip = \"anonymous\";\r\n      if (cfIp) {\r\n        ip = cfIp.trim();\r\n      } else if (forwardedFor) {\r\n        // Extract first IP and trim whitespace (handles malformed headers with spaces)\r\n        ip = forwardedFor.split(\",\")[0].trim();\r\n      }\r\n      \r\n      const sessionId = env.PackagehaSession.idFromName(ip);\r\n      const session = env.PackagehaSession.get(sessionId);\r\n      \r\n      return session.fetch(request);\r\n    }\r\n\r\n    // Health check / info endpoint\r\n    if (request.method === \"GET\") {\r\n      // Check if it's a models list request\r\n      const url = new URL(request.url);\r\n      if (url.pathname === \"/models\" || url.searchParams.get(\"list\") === \"models\") {\r\n        try {\r\n          const sovereignSwitch = new SovereignSwitch(env);\r\n          if (env.GEMINI_API_KEY) {\r\n            const models = await sovereignSwitch.listGeminiModels(env.GEMINI_API_KEY);\r\n            const selected = await sovereignSwitch.getWorkingGeminiModel(env.GEMINI_API_KEY);\r\n            return new Response(\r\n              JSON.stringify({ \r\n                provider: \"gemini\",\r\n                models: models,\r\n                selected: selected\r\n              }), \r\n              { \r\n                status: 200,\r\n                headers: { \r\n                  \"Content-Type\": \"application/json\",\r\n                  \"Access-Control-Allow-Origin\": \"*\"\r\n                }\r\n              }\r\n            );\r\n          } else {\r\n            return new Response(\r\n              JSON.stringify({ error: \"GEMINI_API_KEY not configured\" }), \r\n              { \r\n                status: 400,\r\n                headers: { \r\n                  \"Content-Type\": \"application/json\",\r\n                  \"Access-Control-Allow-Origin\": \"*\"\r\n                }\r\n              }\r\n            );\r\n          }\r\n        } catch (error: any) {\r\n          return new Response(\r\n            JSON.stringify({ error: error.message }), \r\n            { \r\n              status: 500,\r\n              headers: { \r\n                \"Content-Type\": \"application/json\",\r\n                \"Access-Control-Allow-Origin\": \"*\"\r\n              }\r\n            }\r\n          );\r\n        }\r\n      }\r\n\r\n      return new Response(\r\n        JSON.stringify({ \r\n          service: \"Studium Agent\",\r\n          version: \"2.0\",\r\n          campus: \"Packageha\",\r\n          practice: \"Sales\",\r\n          status: \"operational\"\r\n        }), \r\n        { \r\n          status: 200,\r\n          headers: { \r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\"\r\n          }\r\n        }\r\n      );\r\n    }\r\n  }\r\n};", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"D:\\\\OneDrive\\\\Files\\\\Work\\\\Trivergence\\\\GitHub\\\\packageha-ai-1\\\\src\\\\index.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\akhod\\\\AppData\\\\Local\\\\npm-cache\\\\_npx\\\\32026684e21afda6\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\akhod\\\\AppData\\\\Local\\\\npm-cache\\\\_npx\\\\32026684e21afda6\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"D:\\\\OneDrive\\\\Files\\\\Work\\\\Trivergence\\\\GitHub\\\\packageha-ai-1\\\\src\\\\index.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"D:\\\\OneDrive\\\\Files\\\\Work\\\\Trivergence\\\\GitHub\\\\packageha-ai-1\\\\.wrangler\\\\tmp\\\\bundle-QDVGqt\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\akhod\\\\AppData\\\\Local\\\\npm-cache\\\\_npx\\\\32026684e21afda6\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"D:\\\\OneDrive\\\\Files\\\\Work\\\\Trivergence\\\\GitHub\\\\packageha-ai-1\\\\.wrangler\\\\tmp\\\\bundle-QDVGqt\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"D:\\\\OneDrive\\\\Files\\\\Work\\\\Trivergence\\\\GitHub\\\\packageha-ai-1\\\\.wrangler\\\\tmp\\\\bundle-QDVGqt\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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",
  "names": ["selectedPackageIndex", "products"]
}
