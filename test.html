<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packageha AI - Flow Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .config-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .config-section input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .config-section input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .config-section button {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .flow-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .flow-btn {
            padding: 6px 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .flow-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }
        
        .steps-container {
            padding: 30px;
        }
        
        .step-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .step-section.completed {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .step-section.active {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .step-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            transition: background 0.2s;
        }
        
        .step-section.active .step-header {
            background: #f8f9ff;
        }
        
        .step-section.completed .step-header {
            background: #f8fff9;
        }
        
        .step-header:hover {
            background: #f5f5f5;
        }
        
        .step-title {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .step-section.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-section.active .step-number {
            background: #667eea;
            color: white;
        }
        
        .step-info {
            flex: 1;
        }
        
        .step-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .step-detail {
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        
        .step-chevron {
            font-size: 20px;
            color: #999;
            transition: transform 0.3s;
        }
        
        .step-section.active .step-chevron {
            transform: rotate(180deg);
            color: #667eea;
        }
        
        .step-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .step-section.active .step-content {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        
        .step-body {
            padding: 0 20px 20px 20px;
            background: white;
        }
        
        .step-body.completed-view {
            padding: 20px;
            background: #f8fff9;
        }
        
        .answer-display {
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            font-size: 15px;
            color: #333;
        }
        
        .completed-questions-section {
            background: #f8fff9;
            border: 1px solid #d4edda;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .completed-question-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #28a745;
        }
        
        .completed-question-item:last-child {
            margin-bottom: 0;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 16px 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .checkbox-label:hover {
            border-color: #6c63ff;
            background: #f5f4ff;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #6c63ff;
        }
        
        .question-text {
            font-size: 15px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        
        .option-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .dimensions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .submit-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .submit-btn:hover:not(:disabled) {
            background: #5568d3;
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .draft-order-success {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .draft-order-success h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .draft-order-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .draft-order-links a {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .draft-order-links a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .dimensions-row {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .steps-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¦ Packageha AI - Flow Tester</h1>
            <div class="config-section">
                <input type="text" id="apiUrl" placeholder="Worker URL" value="https://packageha-ai.akhodary-006.workers.dev">
                <button onclick="loadAvailableModels()">Check Models</button>
            </div>
            <div class="flow-selector">
                <button class="flow-btn active" data-flow="direct_sales" onclick="selectFlow('direct_sales')">Direct Sales</button>
                <button class="flow-btn" data-flow="package_order" onclick="selectFlow('package_order')">Package Order</button>
                <button class="flow-btn" data-flow="launch_kit" onclick="selectFlow('launch_kit')">Launch Kit</button>
                <button class="flow-btn" data-flow="packaging_assistant" onclick="selectFlow('packaging_assistant')">Packaging Assistant</button>
            </div>
        </div>
        
        <div class="steps-container" id="stepsContainer">
            <!-- Steps will be dynamically generated -->
        </div>
    </div>
    
    <script>
        let currentFlow = 'direct_sales';
        let flowState = {
            product: null,
            variant: null,
            consultation: {}
        };
        
        const steps = [
            { id: 'product', name: 'Select Product', key: 'product' },
            { id: 'variant', name: 'Select Variant', key: 'variant' },
            { id: 'consultation', name: 'Project Details', key: 'consultation' },
            { id: 'order', name: 'Draft Order', key: 'order' }
        ];
        
        function selectFlow(flow) {
            currentFlow = flow;
            document.querySelectorAll('.flow-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-flow="${flow}"]`).classList.add('active');
            resetFlow();
        }
        
        function resetFlow() {
            flowState = { product: null, variant: null, consultation: {} };
            renderSteps();
        }
        
        function renderSteps() {
            const container = document.getElementById('stepsContainer');
            let html = '';
            
            steps.forEach((step, index) => {
                const isCompleted = isStepCompleted(step.id);
                const isActive = isStepActive(step.id);
                const stepData = getStepData(step.id);
                
                html += `
                    <div class="step-section ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}" data-step="${step.id}">
                        <div class="step-header" onclick="toggleStep('${step.id}')">
                            <div class="step-title">
                                <div class="step-number">${isCompleted ? 'âœ“' : (index + 1)}</div>
                                <div class="step-info">
                                    <div class="step-name">${step.name}</div>
                                    <div class="step-detail">${getStepDetail(step.id, stepData)}</div>
                                </div>
                            </div>
                            <div class="step-chevron">â–¼</div>
                        </div>
                        <div class="step-content">
                            ${isActive ? renderStepContent(step.id, stepData) : (isCompleted ? renderCompletedView(step.id, stepData) : '')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Expand active step and focus input
            steps.forEach(step => {
                const isActive = isStepActive(step.id);
                console.log(`[renderSteps] Step ${step.id} isActive:`, isActive);
                if (isActive) {
                    const stepEl = document.querySelector(`[data-step="${step.id}"]`);
                    if (stepEl) {
                        stepEl.classList.add('active');
                        console.log(`[renderSteps] Expanded step: ${step.id}`);
                        autoFocusInput(step.id);
                    }
                }
            });
        }
        
        function isStepCompleted(stepId) {
            if (stepId === 'product') return !!flowState.product;
            if (stepId === 'variant') return !!flowState.variant;
            if (stepId === 'consultation') return flowState.draftOrder || Object.keys(flowState.consultation || {}).length > 0;
            if (stepId === 'order') return !!flowState.draftOrder;
            return false;
        }
        
        function isStepActive(stepId) {
            const result = (() => {
                if (flowState.draftOrder) return stepId === 'order';
                if (!flowState.product) return stepId === 'product';
                if (!flowState.variant) return stepId === 'variant';
                if (!flowState.draftOrder) return stepId === 'consultation';
                return false;
            })();
            console.log(`[isStepActive] ${stepId}:`, result, 'flowState:', { 
                product: flowState.product, 
                variant: flowState.variant, 
                draftOrder: !!flowState.draftOrder 
            });
            return result;
        }
        
        function getStepData(stepId) {
            if (stepId === 'product') return flowState.productData;
            if (stepId === 'variant') return flowState.variantData;
            if (stepId === 'consultation') {
                console.log('[getStepData] consultation data:', flowState.consultationData);
                return flowState.consultationData;
            }
            return null;
        }
        
        function getStepDetail(stepId, stepData) {
            if (stepId === 'product' && flowState.product) return flowState.product;
            if (stepId === 'variant' && flowState.variant) return flowState.variant;
            if (stepId === 'consultation' && Object.keys(flowState.consultation || {}).length > 0) {
                return `${Object.keys(flowState.consultation).length} question(s) answered`;
            }
            if (stepId === 'order' && flowState.draftOrder) return 'Order created successfully';
            return 'Pending';
        }
        
        function toggleStep(stepId) {
            const stepEl = document.querySelector(`[data-step="${stepId}"]`);
            if (stepEl) {
                stepEl.classList.toggle('active');
            }
        }
        
        function renderStepContent(stepId, stepData) {
            if (stepId === 'product') {
                if (stepData && stepData.matches) {
                    return renderProductSelection(stepData.matches);
                }
                return renderProductSearch();
            }
            if (stepId === 'variant') {
                if (stepData && stepData.variants) {
                    return renderVariantSelection(stepData.variants);
                }
                return '<div class="step-body"><p>Loading variants...</p></div>';
            }
            if (stepId === 'consultation') {
                console.log('[renderStepContent] Consultation stepData:', stepData);
                let html = '';
                
                // Show completed questions first
                if (flowState.consultation && Object.keys(flowState.consultation).length > 0) {
                    html += '<div class="completed-questions-section">';
                    html += '<div style="font-weight: 600; margin-bottom: 12px; color: #28a745;">âœ“ Completed Questions:</div>';
                    Object.entries(flowState.consultation).forEach(([questionId, answer]) => {
                        html += `<div class="completed-question-item">
                            <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(questionId)}</div>
                            <div style="color: #333;">${answer}</div>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Show current question
                if (stepData && stepData.currentQuestion) {
                    console.log('[renderStepContent] Rendering question:', stepData.currentQuestion);
                    html += renderQuestion(stepData.currentQuestion);
                } else {
                    console.log('[renderStepContent] No currentQuestion in stepData, showing loading');
                    html += '<div class="step-body"><p>Loading question...</p></div>';
                }
                
                return html;
            }
            if (stepId === 'order') {
                if (flowState.draftOrder) {
                    return renderDraftOrder(flowState.draftOrder);
                }
                return '<div class="step-body"><p>Generating draft order...</p></div>';
            }
            return '';
        }
        
        function renderCompletedView(stepId, stepData) {
            if (stepId === 'product' && flowState.product) {
                return `<div class="step-body completed-view"><div class="answer-display">${flowState.product}</div></div>`;
            }
            if (stepId === 'variant' && flowState.variant) {
                return `<div class="step-body completed-view"><div class="answer-display">${flowState.variant}</div></div>`;
            }
            if (stepId === 'consultation' && flowState.consultation) {
                let html = '<div class="step-body completed-view">';
                Object.entries(flowState.consultation).forEach(([key, value]) => {
                    html += `<div class="answer-display" style="margin-bottom: 10px;"><strong>${key}:</strong> ${value}</div>`;
                });
                html += '</div>';
                return html;
            }
            return '';
        }
        
        function renderProductSearch() {
            return `
                <div class="step-body">
                    <div class="question-text">What product are you looking for?</div>
                    <div class="input-group">
                        <input type="text" id="productSearchInput" placeholder="e.g., Custom Boxes, Bags, Printing Services..." 
                               onkeydown="if(event.key==='Enter') searchProducts()">
                    </div>
                    <button class="submit-btn" onclick="searchProducts()">Search Products</button>
                </div>
            `;
        }
        
        function renderProductSelection(matches) {
            let html = '<div class="step-body"><div class="question-text">Select a product:</div><div class="options-grid">';
            matches.forEach((match, index) => {
                html += `
                    <div class="option-card" onclick="selectProduct(${index}, '${match.name.replace(/'/g, "\\'")}')">
                        <div style="font-weight: 600; margin-bottom: 8px;">${match.name}</div>
                        <div style="font-size: 12px; color: #666;">${match.reason}</div>
                    </div>
                `;
            });
            html += '</div></div>';
            return html;
        }
        
        function renderVariantSelection(variants) {
            let html = '<div class="step-body"><div class="question-text">Select a variant:</div><div class="options-grid">';
            variants.forEach((variant, index) => {
                html += `
                    <div class="option-card" onclick="selectVariant(${index}, '${variant.title.replace(/'/g, "\\'")}', ${variant.id})">
                        <div style="font-weight: 600; margin-bottom: 8px;">${variant.title}</div>
                        <div style="font-size: 12px; color: #666;">Price: ${variant.price}</div>
                    </div>
                `;
            });
            html += '</div></div>';
            return html;
        }
        
        function getQuestionLabel(questionId) {
            const labels = {
                'quantity': 'Quantity',
                'material': 'Material',
                'dimensions': 'Dimensions',
                'print': 'Printing/Finish',
                'timeline': 'Timeline',
                'budget': 'Budget'
            };
            return labels[questionId] || questionId;
        }
        
        function renderQuestion(question) {
            let html = '<div class="step-body"><div class="question-text">' + question.question + '</div>';
            
            if (question.options && question.options.length > 0) {
                // Render as checkboxes with notes field
                html += '<div class="checkbox-group" id="checkbox-group-' + question.id + '">';
                question.options.forEach((option, index) => {
                    html += `
                        <label class="checkbox-label">
                            <input type="checkbox" value="${String(option).replace(/"/g, '&quot;')}" 
                                   id="checkbox-${question.id}-${index}">
                            <span>${option}</span>
                        </label>
                    `;
                });
                html += '</div>';
                
                // Additional notes field
                html += `
                    <div class="input-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #666;">Additional notes (optional):</label>
                        <input type="text" id="notes-${question.id}" placeholder="Any additional details or custom requirements...">
                    </div>
                    <button class="submit-btn" onclick="submitCheckboxAnswer('${question.id}')">Submit</button>
                `;
            } else {
                // Render as input field(s)
                if (question.id === 'dimensions') {
                    // Special handling for dimensions - 3 separate inputs
                    html += `
                        <div class="dimensions-row">
                            <div class="input-group">
                                <label>Length</label>
                                <input type="text" id="dim_length" placeholder="e.g., 20 cm">
                            </div>
                            <div class="input-group">
                                <label>Width</label>
                                <input type="text" id="dim_width" placeholder="e.g., 15 cm">
                            </div>
                            <div class="input-group">
                                <label>Height</label>
                                <input type="text" id="dim_height" placeholder="e.g., 10 cm">
                            </div>
                        </div>
                        <button class="submit-btn" onclick="submitDimensions('${question.id}')">Submit</button>
                    `;
                } else if (question.id === 'quantity') {
                    // Number input for quantity
                    html += `
                        <div class="input-group">
                            <input type="number" id="questionInput" value="${question.defaultValue || '1'}" min="1" placeholder="Enter quantity">
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                } else {
                    // Regular text input
                    html += `
                        <div class="input-group">
                            <input type="text" id="questionInput" value="${question.defaultValue || ''}" placeholder="Enter your answer...">
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function renderDraftOrder(draftOrder) {
            return `
                <div class="draft-order-success">
                    <h2>âœ… Draft Order Created!</h2>
                    <div class="draft-order-links">
                        ${draftOrder.adminUrl ? `<a href="${draftOrder.adminUrl}" target="_blank">ðŸ“‹ View Draft Order</a>` : ''}
                        ${draftOrder.invoiceUrl ? `<a href="${draftOrder.invoiceUrl}" target="_blank">ðŸ’³ View Invoice & Pay</a>` : ''}
                    </div>
                </div>
            `;
        }
        
        function searchProducts() {
            const input = document.getElementById('productSearchInput');
            if (input && input.value.trim()) {
                sendSelection(input.value.trim(), { type: 'product_search' });
            } else {
                // If empty, send a generic search
                sendSelection('show me products', { type: 'product_search' });
            }
        }
        
        function selectProduct(index, name) {
            console.log('[selectProduct] Product selected:', { index, name });
            sendSelection(String(index + 1), { type: 'product', name });
        }
        
        function selectVariant(index, title, id) {
            console.log('[selectVariant] Variant selected:', { index, title, id });
            sendSelection(title, { type: 'variant', title, id });
        }
        
        function selectOption(option, questionId) {
            sendSelection(option, { type: 'option', questionId, option });
        }
        
        function submitCheckboxAnswer(questionId) {
            const checkboxes = document.querySelectorAll(`#checkbox-group-${questionId} input[type="checkbox"]:checked`);
            const notesInput = document.getElementById(`notes-${questionId}`);
            const notes = notesInput ? notesInput.value.trim() : '';
            
            const selectedOptions = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedOptions.length === 0 && !notes) {
                alert('Please select at least one option or add notes.');
                return;
            }
            
            let answer = selectedOptions.join(', ');
            if (notes) {
                answer += (answer ? ' | Notes: ' : 'Notes: ') + notes;
            }
            
            sendSelection(answer, { type: 'answer', questionId });
        }
        
        function submitAnswer(questionId) {
            const input = document.getElementById('questionInput');
            if (input && input.value.trim()) {
                sendSelection(input.value.trim(), { type: 'answer', questionId });
            }
        }
        
        function submitDimensions(questionId) {
            const length = document.getElementById('dim_length')?.value.trim() || '';
            const width = document.getElementById('dim_width')?.value.trim() || '';
            const height = document.getElementById('dim_height')?.value.trim() || '';
            
            if (!length || !width || !height) {
                alert('Please fill in all dimension fields (Length, Width, and Height)');
                return;
            }
            
            const dimensions = `${length} x ${width} x ${height}`;
            sendSelection(dimensions, { type: 'answer', questionId });
        }
        
        // Auto-focus input when step becomes active
        function autoFocusInput(stepId) {
            setTimeout(() => {
                if (stepId === 'product') {
                    const input = document.getElementById('productSearchInput');
                    if (input) input.focus();
                } else {
                    const input = document.getElementById('questionInput');
                    if (input) input.focus();
                }
            }, 100);
        }
        
        async function sendSelection(message, metadata) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                console.error('[sendSelection] No API URL provided');
                return;
            }
            
            console.log('[sendSelection] Sending request:', { message, metadata, flow: currentFlow });
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, flow: currentFlow })
                });
                
                console.log('[sendSelection] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[sendSelection] Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('[sendSelection] Response data:', data);
                
                handleResponse(data, metadata);
            } catch (error) {
                console.error('[sendSelection] Error:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        function handleResponse(data, metadata) {
            console.log('[handleResponse] Called with:', { data, metadata });
            console.log('[handleResponse] Current flowState:', JSON.parse(JSON.stringify(flowState)));
            console.log('[handleResponse] Response data.flowState:', data.flowState);
            console.log('[handleResponse] Response data.currentQuestion:', data.currentQuestion ? 'present' : 'missing');
            console.log('[handleResponse] Response data.variants:', data.variants ? `${data.variants.length} variants` : 'none');
            
            // CRITICAL: Check for variant auto-skip FIRST (before any other logic)
            // If backend is in consultation (currentQuestion present) but no variant is selected,
            // it means variant step was auto-skipped (single variant or no variants)
            if (data.currentQuestion && !flowState.variant && flowState.product) {
                console.log('[handleResponse] CRITICAL: Detecting variant auto-skip - currentQuestion present but no variant');
                if (data.flowState && data.flowState.hasVariant && data.flowState.variantName) {
                    console.log('[handleResponse] Setting variant from flowState.variantName:', data.flowState.variantName);
                    flowState.variant = data.flowState.variantName;
                } else {
                    console.log('[handleResponse] No variant name in flowState - using "Default"');
                    flowState.variant = 'Default';
                }
                flowState.variantData = null; // Clear variant data since we're auto-completing
            }
            
            // Handle product search - show matches
            if (metadata && metadata.type === 'product_search') {
                console.log('[handleResponse] Handling product_search');
                if (data.productMatches && data.productMatches.length > 0) {
                    console.log('[handleResponse] Found product matches:', data.productMatches.length);
                    flowState.productData = { matches: data.productMatches };
                    renderSteps();
                    return;
                }
                // If no matches but we have a reply, the product was found directly
                if (data.flowState && data.flowState.hasProduct) {
                    console.log('[handleResponse] Product found directly:', data.flowState.productName);
                    flowState.product = data.flowState.productName;
                    flowState.productData = null;
                    
                    // Check if variant was auto-skipped immediately after product selection
                    if (data.currentQuestion) {
                        console.log('[handleResponse] Product found and variant auto-skipped (currentQuestion present)');
                        flowState.variant = data.flowState?.variantName || 'Default';
                        flowState.variantData = null;
                        
                        // CRITICAL: Set consultationData before returning
                        if (!flowState.consultationData) {
                            flowState.consultationData = {};
                        }
                        flowState.consultationData.currentQuestion = data.currentQuestion;
                        console.log('[handleResponse] Set consultationData in product_search handler:', flowState.consultationData);
                    }
                    
                    renderSteps();
                    return;
                }
            }
            
            // Update flow state based on metadata and response
            if (metadata && metadata.type === 'product' && data.flowState && data.flowState.hasProduct) {
                console.log('[handleResponse] Product selected:', data.flowState.productName);
                flowState.product = data.flowState.productName || metadata.name;
                flowState.productData = null;
                
                // Check if variant was auto-skipped (backend went straight to consultation)
                if (data.currentQuestion) {
                    console.log('[handleResponse] Product selected and variant auto-skipped (currentQuestion present)');
                    flowState.variant = data.flowState?.variantName || 'Default';
                    flowState.variantData = null;
                } else if (data.flowState.hasVariant && data.flowState.variantName) {
                    console.log('[handleResponse] Variant auto-selected (single variant):', data.flowState.variantName);
                    flowState.variant = data.flowState.variantName;
                    flowState.variantData = null;
                }
            }
            
            if (metadata && metadata.type === 'variant' && data.flowState && data.flowState.hasVariant) {
                console.log('[handleResponse] Variant selected:', data.flowState.variantName);
                flowState.variant = data.flowState.variantName || metadata.title;
                flowState.variantData = null;
            }
            
            if (metadata && (metadata.type === 'answer' || metadata.type === 'option')) {
                console.log('[handleResponse] Answer/option recorded:', metadata.questionId, metadata.option || metadata.message);
                if (!flowState.consultation) flowState.consultation = {};
                flowState.consultation[metadata.questionId] = metadata.option || metadata.message;
            }
            
            // Update step data
            if (data.productMatches) {
                console.log('[handleResponse] Updating productMatches:', data.productMatches.length);
                flowState.productData = { matches: data.productMatches };
            }
            if (data.variants) {
                console.log('[handleResponse] Updating variants:', data.variants.length, data.variants);
                flowState.variantData = { variants: data.variants };
            }
            if (data.currentQuestion) {
                console.log('[handleResponse] Updating currentQuestion:', data.currentQuestion.id, data.currentQuestion);
                if (!flowState.consultationData) {
                    flowState.consultationData = {};
                }
                flowState.consultationData.currentQuestion = data.currentQuestion;
                console.log('[handleResponse] consultationData after update:', flowState.consultationData);
                // Note: Variant auto-skip is handled at the top of this function
            }
            if (data.draftOrder) {
                console.log('[handleResponse] Draft order created:', data.draftOrder.id);
                flowState.draftOrder = data.draftOrder;
            }
            
            // Special handling: if backend step is "ask_variant" but we don't have variants yet
            if (data.flowState && data.flowState.step === 'ask_variant' && !data.variants && !flowState.variantData) {
                console.log('[handleResponse] Backend is in ask_variant but no variants in response - may need to fetch');
            }
            
            console.log('[handleResponse] Updated flowState:', JSON.parse(JSON.stringify(flowState)));
            console.log('[handleResponse] data.flowState from backend:', data.flowState);
            
            // Re-render steps
            console.log('[handleResponse] Re-rendering steps...');
            renderSteps();
        }
        
        async function loadAvailableModels() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                alert('Please enter a Worker URL');
                return;
            }
            
            try {
                const response = await fetch(`${apiUrl}?list=models`);
                const data = await response.json();
                if (data.selected) {
                    alert(`Selected Model: ${data.selected}\n\nAvailable: ${data.models.length} models`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Initialize
        renderSteps();
    </script>
</body>
</html>