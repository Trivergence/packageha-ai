<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packageha AI - Flow Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .config-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .config-section input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .config-section input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .config-section button {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .flow-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .flow-btn {
            padding: 6px 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .flow-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }
        
        .steps-container {
            padding: 30px;
        }
        
        .step-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .step-section.completed {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .step-section.active {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .step-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            transition: background 0.2s;
        }
        
        .step-section.active .step-header {
            background: #f8f9ff;
        }
        
        .step-section.completed .step-header {
            background: #f8fff9;
        }
        
        .step-header:hover {
            background: #f5f5f5;
        }
        
        .step-title {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .step-section.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-section.active .step-number {
            background: #667eea;
            color: white;
        }
        
        .step-info {
            flex: 1;
        }
        
        .step-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .step-detail {
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        
        .step-chevron {
            font-size: 20px;
            color: #999;
            transition: transform 0.3s;
        }
        
        .step-section.active .step-chevron {
            transform: rotate(180deg);
            color: #667eea;
        }
        
        .step-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .step-section.active .step-content {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        
        .step-body {
            padding: 0 20px 20px 20px;
            background: white;
        }
        
        .step-body.completed-view {
            padding: 20px;
            background: #f8fff9;
        }
        
        .answer-display {
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            font-size: 15px;
            color: #333;
        }
        
        .question-text {
            font-size: 15px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        
        .option-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .dimensions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .submit-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .submit-btn:hover:not(:disabled) {
            background: #5568d3;
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .draft-order-success {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .draft-order-success h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .draft-order-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .draft-order-links a {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .draft-order-links a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .dimensions-row {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .steps-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¦ Packageha AI - Flow Tester</h1>
            <div class="config-section">
                <input type="text" id="apiUrl" placeholder="Worker URL" value="https://packageha-ai.akhodary-006.workers.dev">
                <button onclick="loadAvailableModels()">Check Models</button>
            </div>
            <div class="flow-selector">
                <button class="flow-btn active" data-flow="direct_sales" onclick="selectFlow('direct_sales')">Direct Sales</button>
                <button class="flow-btn" data-flow="package_order" onclick="selectFlow('package_order')">Package Order</button>
                <button class="flow-btn" data-flow="launch_kit" onclick="selectFlow('launch_kit')">Launch Kit</button>
                <button class="flow-btn" data-flow="packaging_assistant" onclick="selectFlow('packaging_assistant')">Packaging Assistant</button>
            </div>
        </div>
        
        <div class="steps-container" id="stepsContainer">
            <!-- Steps will be dynamically generated -->
        </div>
    </div>
    
    <script>
        let currentFlow = 'direct_sales';
        let flowState = {
            product: null,
            variant: null,
            consultation: {}
        };
        
        const steps = [
            { id: 'product', name: 'Select Product', key: 'product' },
            { id: 'variant', name: 'Select Variant', key: 'variant' },
            { id: 'consultation', name: 'Project Details', key: 'consultation' },
            { id: 'order', name: 'Draft Order', key: 'order' }
        ];
        
        function selectFlow(flow) {
            currentFlow = flow;
            document.querySelectorAll('.flow-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-flow="${flow}"]`).classList.add('active');
            resetFlow();
        }
        
        function resetFlow() {
            flowState = { product: null, variant: null, consultation: {} };
            renderSteps();
        }
        
        function renderSteps() {
            const container = document.getElementById('stepsContainer');
            let html = '';
            
            steps.forEach((step, index) => {
                const isCompleted = isStepCompleted(step.id);
                const isActive = isStepActive(step.id);
                const stepData = getStepData(step.id);
                
                html += `
                    <div class="step-section ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}" data-step="${step.id}">
                        <div class="step-header" onclick="toggleStep('${step.id}')">
                            <div class="step-title">
                                <div class="step-number">${isCompleted ? 'âœ“' : (index + 1)}</div>
                                <div class="step-info">
                                    <div class="step-name">${step.name}</div>
                                    <div class="step-detail">${getStepDetail(step.id, stepData)}</div>
                                </div>
                            </div>
                            <div class="step-chevron">â–¼</div>
                        </div>
                        <div class="step-content">
                            ${isActive ? renderStepContent(step.id, stepData) : (isCompleted ? renderCompletedView(step.id, stepData) : '')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Expand active step
            steps.forEach(step => {
                if (isStepActive(step.id)) {
                    const stepEl = document.querySelector(`[data-step="${step.id}"]`);
                    if (stepEl && !stepEl.classList.contains('active')) {
                        stepEl.classList.add('active');
                    }
                }
            });
        }
        
        function isStepCompleted(stepId) {
            if (stepId === 'product') return !!flowState.product;
            if (stepId === 'variant') return !!flowState.variant;
            if (stepId === 'consultation') return flowState.draftOrder || Object.keys(flowState.consultation || {}).length > 0;
            if (stepId === 'order') return !!flowState.draftOrder;
            return false;
        }
        
        function isStepActive(stepId) {
            if (flowState.draftOrder) return stepId === 'order';
            if (!flowState.product) return stepId === 'product';
            if (!flowState.variant) return stepId === 'variant';
            if (!flowState.draftOrder) return stepId === 'consultation';
            return false;
        }
        
        function getStepData(stepId) {
            if (stepId === 'product') return flowState.productData;
            if (stepId === 'variant') return flowState.variantData;
            if (stepId === 'consultation') return flowState.consultationData;
            return null;
        }
        
        function getStepDetail(stepId, stepData) {
            if (stepId === 'product' && flowState.product) return flowState.product;
            if (stepId === 'variant' && flowState.variant) return flowState.variant;
            if (stepId === 'consultation' && Object.keys(flowState.consultation || {}).length > 0) {
                return `${Object.keys(flowState.consultation).length} question(s) answered`;
            }
            if (stepId === 'order' && flowState.draftOrder) return 'Order created successfully';
            return 'Pending';
        }
        
        function toggleStep(stepId) {
            const stepEl = document.querySelector(`[data-step="${stepId}"]`);
            if (stepEl) {
                stepEl.classList.toggle('active');
            }
        }
        
        function renderStepContent(stepId, stepData) {
            if (stepId === 'product') {
                if (stepData && stepData.matches) {
                    return renderProductSelection(stepData.matches);
                }
                return '<div class="step-body"><p>Searching for products...</p></div>';
            }
            if (stepId === 'variant') {
                if (stepData && stepData.variants) {
                    return renderVariantSelection(stepData.variants);
                }
                return '<div class="step-body"><p>Loading variants...</p></div>';
            }
            if (stepId === 'consultation') {
                if (stepData && stepData.currentQuestion) {
                    return renderQuestion(stepData.currentQuestion);
                }
                return '<div class="step-body"><p>Loading question...</p></div>';
            }
            if (stepId === 'order') {
                if (flowState.draftOrder) {
                    return renderDraftOrder(flowState.draftOrder);
                }
                return '<div class="step-body"><p>Generating draft order...</p></div>';
            }
            return '';
        }
        
        function renderCompletedView(stepId, stepData) {
            if (stepId === 'product' && flowState.product) {
                return `<div class="step-body completed-view"><div class="answer-display">${flowState.product}</div></div>`;
            }
            if (stepId === 'variant' && flowState.variant) {
                return `<div class="step-body completed-view"><div class="answer-display">${flowState.variant}</div></div>`;
            }
            if (stepId === 'consultation' && flowState.consultation) {
                let html = '<div class="step-body completed-view">';
                Object.entries(flowState.consultation).forEach(([key, value]) => {
                    html += `<div class="answer-display" style="margin-bottom: 10px;"><strong>${key}:</strong> ${value}</div>`;
                });
                html += '</div>';
                return html;
            }
            return '';
        }
        
        function renderProductSelection(matches) {
            let html = '<div class="step-body"><div class="question-text">Select a product:</div><div class="options-grid">';
            matches.forEach((match, index) => {
                html += `
                    <div class="option-card" onclick="selectProduct(${index}, '${match.name.replace(/'/g, "\\'")}')">
                        <div style="font-weight: 600; margin-bottom: 8px;">${match.name}</div>
                        <div style="font-size: 12px; color: #666;">${match.reason}</div>
                    </div>
                `;
            });
            html += '</div></div>';
            return html;
        }
        
        function renderVariantSelection(variants) {
            let html = '<div class="step-body"><div class="question-text">Select a variant:</div><div class="options-grid">';
            variants.forEach((variant, index) => {
                html += `
                    <div class="option-card" onclick="selectVariant(${index}, '${variant.title.replace(/'/g, "\\'")}', ${variant.id})">
                        <div style="font-weight: 600; margin-bottom: 8px;">${variant.title}</div>
                        <div style="font-size: 12px; color: #666;">Price: ${variant.price}</div>
                    </div>
                `;
            });
            html += '</div></div>';
            return html;
        }
        
        function renderQuestion(question) {
            let html = '<div class="step-body"><div class="question-text">' + question.question + '</div>';
            
            if (question.options && question.options.length > 0) {
                // Render as option cards
                html += '<div class="options-grid">';
                question.options.forEach((option, index) => {
                    html += `
                        <div class="option-card" onclick="selectOption('${String(option).replace(/'/g, "\\'")}', '${question.id}')">
                            ${option}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                // Render as input field(s)
                if (question.id === 'dimensions') {
                    // Special handling for dimensions - 3 separate inputs
                    html += `
                        <div class="dimensions-row">
                            <div class="input-group">
                                <label>Length</label>
                                <input type="text" id="dim_length" placeholder="e.g., 20 cm">
                            </div>
                            <div class="input-group">
                                <label>Width</label>
                                <input type="text" id="dim_width" placeholder="e.g., 15 cm">
                            </div>
                            <div class="input-group">
                                <label>Height</label>
                                <input type="text" id="dim_height" placeholder="e.g., 10 cm">
                            </div>
                        </div>
                        <button class="submit-btn" onclick="submitDimensions('${question.id}')">Submit</button>
                    `;
                } else if (question.id === 'quantity') {
                    // Number input for quantity
                    html += `
                        <div class="input-group">
                            <input type="number" id="questionInput" value="${question.defaultValue || '1'}" min="1" placeholder="Enter quantity">
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                } else {
                    // Regular text input
                    html += `
                        <div class="input-group">
                            <input type="text" id="questionInput" value="${question.defaultValue || ''}" placeholder="Enter your answer...">
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function renderDraftOrder(draftOrder) {
            return `
                <div class="draft-order-success">
                    <h2>âœ… Draft Order Created!</h2>
                    <div class="draft-order-links">
                        ${draftOrder.adminUrl ? `<a href="${draftOrder.adminUrl}" target="_blank">ðŸ“‹ View Draft Order</a>` : ''}
                        ${draftOrder.invoiceUrl ? `<a href="${draftOrder.invoiceUrl}" target="_blank">ðŸ’³ View Invoice & Pay</a>` : ''}
                    </div>
                </div>
            `;
        }
        
        function selectProduct(index, name) {
            sendSelection(String(index + 1), { type: 'product', name });
        }
        
        function selectVariant(index, title, id) {
            sendSelection(title, { type: 'variant', title, id });
        }
        
        function selectOption(option, questionId) {
            sendSelection(option, { type: 'option', questionId, option });
        }
        
        function submitAnswer(questionId) {
            const input = document.getElementById('questionInput');
            if (input && input.value.trim()) {
                sendSelection(input.value.trim(), { type: 'answer', questionId });
            }
        }
        
        function submitDimensions(questionId) {
            const length = document.getElementById('dim_length')?.value.trim() || '';
            const width = document.getElementById('dim_width')?.value.trim() || '';
            const height = document.getElementById('dim_height')?.value.trim() || '';
            
            if (!length || !width || !height) {
                alert('Please fill in all dimension fields');
                return;
            }
            
            const dimensions = `${length} x ${width} x ${height}`;
            sendSelection(dimensions, { type: 'answer', questionId });
        }
        
        async function sendSelection(message, metadata) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) return;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, flow: currentFlow })
                });
                
                const data = await response.json();
                handleResponse(data, metadata);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function handleResponse(data, metadata) {
            // Update flow state based on metadata and response
            if (metadata.type === 'product' && data.flowState && data.flowState.hasProduct) {
                flowState.product = data.flowState.productName || metadata.name;
                flowState.productData = null;
            }
            
            if (metadata.type === 'variant' && data.flowState && data.flowState.hasVariant) {
                flowState.variant = data.flowState.variantName || metadata.title;
                flowState.variantData = null;
            }
            
            if (metadata.type === 'answer' || metadata.type === 'option') {
                if (!flowState.consultation) flowState.consultation = {};
                flowState.consultation[metadata.questionId] = metadata.option || metadata.message;
            }
            
            // Update step data
            if (data.productMatches) {
                flowState.productData = { matches: data.productMatches };
            }
            if (data.variants) {
                flowState.variantData = { variants: data.variants };
            }
            if (data.currentQuestion) {
                flowState.consultationData = { currentQuestion: data.currentQuestion };
            }
            if (data.draftOrder) {
                flowState.draftOrder = data.draftOrder;
            }
            
            // Re-render steps
            renderSteps();
        }
        
        async function loadAvailableModels() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                alert('Please enter a Worker URL');
                return;
            }
            
            try {
                const response = await fetch(`${apiUrl}?list=models`);
                const data = await response.json();
                if (data.selected) {
                    alert(`Selected Model: ${data.selected}\n\nAvailable: ${data.models.length} models`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Initialize
        renderSteps();
    </script>
</body>
</html>