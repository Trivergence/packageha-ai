<!DOCTYPE html>
<!--
    Packageha AI - Salla Integration Tester
    
    This is a frontend test interface for the Packageha AI agent with Salla integration.
    Merchants can connect their Salla store and select products, upload images, or enter text descriptions
    to start the package design flow.
    It provides a step-by-step UI for testing the complete sales consultation process:
    
    Flow Steps:
    1. Product Details - Collect information about the product that will be packaged
    2. Package Selection - Search and select a package (includes variant selection and package specs)
    3. Fulfillment Specs - Collect order fulfillment information (quantity, timeline, shipping, etc.)
    4. Launch Kit - Optional brand launch services
    5. Draft Order - Final order creation and confirmation
    
    Features:
    - Visual step-by-step interface with collapsible sections
    - Handles various question types (text, radio, checkbox, grouped options)
    - Product search and selection with AI-powered matching
    - Variant auto-skip handling (when only one variant exists)
    - State management across all consultation phases
    - Loading indicators during API calls
    - Draft order display with links to Shopify admin and invoice
    
    Note: Only the direct_sales flow is supported. Other flows have been removed.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packageha - ÿ™ÿµŸÖŸäŸÖ ÿ£ÿ∫ŸÑŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</title>
    <!-- Google Maps Places API for address autocomplete -->
    <!-- NOTE: Replace YOUR_GOOGLE_MAPS_API_KEY with your actual Google Maps API key -->
    <!-- IMPORTANT: Enable "Places API" in Google Cloud Console for this API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAAYiLzZ_7ccJatguVNSOq4YTwOrcKhgY&libraries=places&language=ar"></script>
    <script>
        // Global flag to track if Google Maps loaded successfully
        window.googleMapsLoaded = false;
        window.googleMapsReady = new Promise((resolve) => {
            // Check if Google Maps is already loaded
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                window.googleMapsLoaded = true;
                resolve();
            } else {
                // Wait for load event
                window.addEventListener('load', function() {
                    if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                        window.googleMapsLoaded = true;
                        resolve();
                    }
                });
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            padding: 30px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,193,7,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .lang-toggle {
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }
        
        .lang-toggle button {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            background: transparent;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .lang-toggle button.active {
            background: rgba(255,255,255,0.2);
            color: #FFC107;
        }
        
        /* User Account & Store Management */
        .account-section {
            padding: 30px 40px;
            background: #fafbfc;
            border-bottom: 1px solid #e8ecf1;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            flex-wrap: wrap;
            gap: 15px;
            cursor: pointer;
            user-select: none;
        }
        
        .account-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .account-header-chevron {
            font-size: 16px;
            color: #666;
            transition: transform 0.3s;
        }
        
        /* LTR (English): Point right when collapsed, down when expanded */
        html[dir="ltr"] .account-section.collapsed .account-header-chevron {
            transform: rotate(-90deg);
        }
        
        /* RTL (Arabic): Point left when collapsed, down when expanded */
        html[dir="rtl"] .account-section.collapsed .account-header-chevron {
            transform: rotate(90deg);
        }
        
        .stores-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 0;
        }
        
        .account-section:not(.collapsed) .stores-container {
            max-height: 1000px;
            margin-top: 25px;
            transition: max-height 0.5s ease-in;
        }
        
        .connect-store-btn {
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .connect-store-btn:hover {
            background: #2d2d2d;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .connect-store-btn span:first-child {
            font-size: 24px;
        }
        
        .stores-list {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .store-card {
            background: white;
            border: 1px solid #e8ecf1;
            border-radius: 16px;
            padding: 20px;
            min-width: 200px;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .store-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transform: translateY(-4px);
        }
        
        .store-logo-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            border-radius: 12px;
            background: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .store-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .store-logo-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #999;
        }
        
        .host-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .host-badge img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .store-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .disconnect-btn {
            width: 100%;
            padding: 8px 16px;
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .disconnect-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        .connect-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        
        .connect-menu.visible {
            display: block;
        }
        
        .connect-menu-item {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f5f7fa;
        }
        
        .connect-menu-item:last-child {
            border-bottom: none;
        }
        
        .connect-menu-item:hover {
            background: #f5f7fa;
        }
        
        .connect-menu-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .connect-menu-item-text {
            flex: 1;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .config-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .config-section input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .config-section input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .config-section button {
            padding: 8px 16px;
            background: #000;
            color: #FFC107;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Flow selector styles removed - only direct_sales flow is supported */
        
        .steps-container {
            padding: 30px;
            display: none; /* Hidden by default */
        }
        
        .steps-container.visible {
            display: block;
        }
        
        .step-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .step-section.completed {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .step-section.active {
            border-color: #1a1a1a;
            box-shadow: 0 4px 12px rgba(26, 26, 26, 0.15);
        }
        
        .step-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            transition: background 0.2s;
        }
        
        .step-section.active .step-header {
            background: #f5f7fa;
        }
        
        .step-section.completed .step-header {
            background: #f8fff9;
        }
        
        .step-header:hover {
            background: #f5f5f5;
        }
        
        .step-title {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .step-section.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-section.active .step-number {
            background: #1a1a1a;
            color: #fff;
        }
        
        .step-info {
            flex: 1;
        }
        
        .step-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .step-detail {
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        
        .step-chevron {
            font-size: 20px;
            color: #999;
            transition: transform 0.3s;
        }
        
        .step-section.active .step-chevron {
            transform: rotate(180deg);
            color: #1a1a1a;
        }
        
        .step-content {
            position: relative;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .step-section.active .step-content {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        
        .step-body {
            padding: 0 20px 20px 20px;
            background: white;
        }
        
        .step-body.completed-view {
            padding: 20px;
            background: #f8fff9;
        }
        
        .answer-display {
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            font-size: 15px;
            color: #333;
        }
        
        .completed-questions-section {
            background: #f8fff9;
            border: 1px solid #d4edda;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .completed-question-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #28a745;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .completed-question-item:last-child {
            margin-bottom: 0;
        }
        
        .edit-icon {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            color: #FFC107;
            font-size: 16px;
            transition: all 0.2s;
            opacity: 0.7;
        }
        
        .edit-icon:hover {
            opacity: 1;
            background: #f0f0f0;
        }
        
        .answer-content {
            flex: 1;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 16px 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .checkbox-label:hover {
            border-color: #6c63ff;
            background: #f5f4ff;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #6c63ff;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 16px 0;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .radio-label:hover {
            border-color: #6c63ff;
            background: #f5f4ff;
        }
        
        .radio-label input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-label input[type="radio"]:checked + span {
            font-weight: 600;
            color: #6c63ff;
        }
        
        .radio-label:has(input[type="radio"]:checked) {
            border-color: #6c63ff;
            background: #f5f4ff;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 8px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6c63ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        
        .question-text {
            font-size: 15px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }
        
        .option-card:hover {
            border-color: #FFC107;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            border-color: #FFC107;
            background: #f8f9ff;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #1a1a1a;
        }
        
        .dimensions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .submit-btn {
            padding: 12px 24px;
            background: #000;
            color: #FFC107;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .submit-btn:hover:not(:disabled) {
            background: #333;
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .draft-order-success {
            padding: 30px;
            text-align: center;
            background: #FFC107;
            color: #000;
        }
        
        .draft-order-success h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .draft-order-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .draft-order-links a {
            padding: 12px 24px;
            background: white;
            color: #FFC107;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .draft-order-links a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Inventory Table Styles */
        .inventory-section {
            padding: 30px;
            background: white;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .inventory-section h2 {
            margin-bottom: 25px;
            color: #333;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .inventory-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        .inventory-table thead {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
        }
        
        .inventory-table th {
            padding: 15px;
            text-align: right;
            font-weight: 700;
            font-size: 14px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        html[lang="en"] .inventory-table th {
            text-align: left;
        }
        
        .inventory-table th:last-child,
        .inventory-table td:last-child {
            text-align: center;
        }
        
        .inventory-table td {
            padding: 15px;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .inventory-table tbody tr {
            transition: all 0.2s;
        }
        
        .inventory-table tbody tr:hover {
            background: #f5f7fa;
        }
        
        .product-photo, .package-photo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #e8ecf1;
        }
        
        .photo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 20px;
        }
        
        .store-source {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .store-source-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        
        .restock-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }
        
        .restock-available {
            background: #d4edda;
            color: #155724;
        }
        
        .restock-out {
            background: #f8d7da;
            color: #721c24;
        }
        
        .design-btn {
            padding: 10px 20px;
            background: #1a1a1a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .design-btn:hover {
            background: #2d2d2d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .linked-badge {
            color: #28a745;
            font-weight: 600;
            font-size: 14px;
        }
        
        .no-products-message {
            text-align: center;
            padding: 50px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .no-products-message p {
            color: #666;
            font-size: 18px;
            margin-bottom: 25px;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 16px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .inventory-section {
                padding: 20px 15px;
            }
            
            .inventory-section h2 {
                font-size: 18px;
            }
            
            .inventory-table {
                font-size: 13px;
            }
            
            .inventory-table th,
            .inventory-table td {
                padding: 10px 8px;
            }
            
            .dimensions-row {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .steps-container {
                padding: 15px;
            }
            
            .design-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .inventory-table {
                font-size: 11px;
            }
            
            .inventory-table th,
            .inventory-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1 data-ar="ÿ®ŸÉÿ¨Ÿáÿß - ÿ™ÿµŸÖŸäŸÖ ÿ£ÿ∫ŸÑŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™" data-en="Packageha - Product Package Design">ÿ®ŸÉÿ¨Ÿáÿß - ÿ™ÿµŸÖŸäŸÖ ÿ£ÿ∫ŸÑŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h1>
                <div class="lang-toggle">
                    <button onclick="setLanguage('ar')" id="langAr" class="active">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
                    <button onclick="setLanguage('en')" id="langEn">English</button>
                </div>
            </div>
            <div class="config-section" style="display: none;">
                <input type="text" id="apiUrl" placeholder="Worker URL" value="https://packageha-ai.akhodary-006.workers.dev">
            </div>
        </div>
        
        <!-- User Account & Store Management Section -->
        <div class="account-section collapsed" id="accountSection">
            <div class="account-header" onclick="toggleStoresSection()">
                <h2>
                    <span class="account-header-chevron">‚ñº</span>
                    <span data-ar="ŸÖÿ™ÿßÿ¨ÿ±Ÿä" data-en="My Stores">ŸÖÿ™ÿßÿ¨ÿ±Ÿä</span>
                </h2>
            </div>
            <div class="stores-container">
                <div id="storesList" class="stores-list">
                    <!-- Connected stores will be rendered here -->
                    <div style="position: relative;" onclick="event.stopPropagation();">
                        <button onclick="toggleConnectMenu()" class="connect-store-btn">
                            <span>+</span>
                            <span data-ar="ÿ±ÿ®ÿ∑ ŸÖÿ™ÿ¨ÿ±" data-en="Connect Store">ÿ±ÿ®ÿ∑ ŸÖÿ™ÿ¨ÿ±</span>
                        </button>
                        <div id="connectMenu" class="connect-menu">
                            <div class="connect-menu-item" onclick="connectStore('salla')">
                                <div class="connect-menu-item-icon" style="background: #f5f7fa;">üõçÔ∏è</div>
                                <div class="connect-menu-item-text" data-ar="ÿ≥ŸÑÿ©" data-en="Salla">ÿ≥ŸÑÿ©</div>
                            </div>
                            <div class="connect-menu-item" onclick="connectStore('shopify')" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
                                <div class="connect-menu-item-icon" style="background: #f5f7fa;">üõí</div>
                                <div class="connect-menu-item-text" data-ar="Shopify" data-en="Shopify">Shopify</div>
                            </div>
                            <div class="connect-menu-item" onclick="connectStore('zed')" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;">
                                <div class="connect-menu-item-icon" style="background: #f5f7fa;">üì¶</div>
                                <div class="connect-menu-item-text" data-ar="Zed" data-en="Zed">Zed</div>
                            </div>
                            <div class="connect-menu-item" onclick="connectStore('custom')">
                                <div class="connect-menu-item-icon" style="background: #f5f7fa;">‚öôÔ∏è</div>
                                <div class="connect-menu-item-text" data-ar="ŸÖÿÆÿµÿµ" data-en="Custom">ŸÖÿÆÿµÿµ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Inventory Table Section -->
        <div id="inventorySection" class="inventory-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;" data-ar="üì¶ ŸÖÿÆÿ≤ŸàŸÜŸä" data-en="üì¶ My Inventory">üì¶ ŸÖÿÆÿ≤ŸàŸÜŸä</h2>
                <button onclick="showAddProductDialog()" class="design-btn" style="padding: 14px 28px; font-size: 15px;" data-ar="ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨" data-en="Add Product">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨</button>
            </div>
            <div class="inventory-table-wrapper">
                <table id="inventoryTable" class="inventory-table">
                    <thead>
                        <tr>
                            <th data-ar="ÿßŸÑŸÖŸÜÿ™ÿ¨" data-en="Product" class="inventory-th">ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                            <th data-ar="ÿßŸÑÿ∫ŸÑÿßŸÅ" data-en="Package" class="inventory-th">ÿßŸÑÿ∫ŸÑÿßŸÅ</th>
                            <th data-ar="ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸàÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™" data-en="Stock & Actions" class="inventory-th">ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸàÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Demo products will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="noProductsMessage" class="no-products-message" style="display: none;">
                <p data-ar="ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÖÿ™ÿ¨ÿ±ŸÉ ÿ®ÿπÿØ" data-en="No products in your store yet">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÖÿ™ÿ¨ÿ±ŸÉ ÿ®ÿπÿØ</p>
                <button onclick="startDesignFlow()" class="design-btn" data-ar="ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ ÿßŸÑÿ¢ŸÜ" data-en="Design Package Now">ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ ÿßŸÑÿ¢ŸÜ</button>
            </div>
        </div>
        
        <!-- Add Product Dialog -->
        <div id="addProductModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="margin: 0; color: #1a1a1a;" data-ar="ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ" data-en="Add New Product">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ</h2>
                    <button onclick="closeAddProductDialog()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; line-height: 1;">&times;</button>
                </div>
                
                <!-- Product Photo Upload -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;" data-ar="ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨" data-en="Product Photo">ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨</label>
                    <div style="border: 2px dashed #e0e0e0; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;" 
                         onclick="document.getElementById('newProductPhotoInput').click()"
                         onmouseover="this.style.borderColor='#1a1a1a'"
                         onmouseout="this.style.borderColor='#e0e0e0'">
                        <div id="newProductPhotoPreview" style="display: none; margin-bottom: 15px;">
                            <img id="newProductPhotoImg" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        </div>
                        <div id="newProductPhotoPlaceholder">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                            <div style="color: #666;" data-ar="ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨" data-en="Click to upload product photo">ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨</div>
                        </div>
                        <input type="file" id="newProductPhotoInput" accept="image/*" style="display: none;" onchange="handleNewProductPhotoUpload(event)">
                    </div>
                </div>
                
                <!-- Product Details Form -->
                <div id="productDetailsForm" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;" data-ar="ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨" data-en="Product Details">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨</h3>
                    
                    <!-- Product Description -->
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label data-ar="ÿ£ŸàŸÑÿßŸãÿå ÿ£ÿÆÿ®ÿ±ŸÜŸä ÿπŸÜ ŸÖŸÜÿ™ÿ¨ŸÉ. ŸÖÿß ŸáŸàÿü ŸÖÿßÿ∞ÿß ŸäŸÅÿπŸÑÿü" data-en="First, tell me about your product. What is it? What does it do?">ÿ£ŸàŸÑÿßŸãÿå ÿ£ÿÆÿ®ÿ±ŸÜŸä ÿπŸÜ ŸÖŸÜÿ™ÿ¨ŸÉ. ŸÖÿß ŸáŸàÿü ŸÖÿßÿ∞ÿß ŸäŸÅÿπŸÑÿü</label>
                        <textarea id="newProductDescription" data-ar-placeholder="ÿµŸÅ ŸÖŸÜÿ™ÿ¨ŸÉ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ..." data-en-placeholder="Describe your product in detail..." placeholder="Describe your product in detail..." style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Product Dimensions - 3 separate fields -->
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ÿ£ÿ®ÿπÿßÿØ ŸÖŸÜÿ™ÿ¨ŸÉ (ÿ®ÿßŸÑÿ≥ŸÖ)" data-en="Product Dimensions (in cm)">ÿ£ÿ®ÿπÿßÿØ ŸÖŸÜÿ™ÿ¨ŸÉ (ÿ®ÿßŸÑÿ≥ŸÖ)</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #666; font-size: 12px;" data-ar="ÿßŸÑÿ∑ŸàŸÑ (L)" data-en="Length (L)">Length (L)</label>
                                <input type="number" id="productLength" step="0.1" min="0" data-ar-placeholder="ÿ≥ŸÖ" data-en-placeholder="cm" placeholder="cm" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #666; font-size: 12px;" data-ar="ÿßŸÑÿπÿ±ÿ∂ (W)" data-en="Width (W)">Width (W)</label>
                                <input type="number" id="productWidth" step="0.1" min="0" data-ar-placeholder="ÿ≥ŸÖ" data-en-placeholder="cm" placeholder="cm" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #666; font-size: 12px;" data-ar="ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ (H)" data-en="Height (H)">Height (H)</label>
                                <input type="number" id="productHeight" step="0.1" min="0" data-ar-placeholder="ÿ≥ŸÖ" data-en-placeholder="cm" placeholder="cm" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Weight -->
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label data-ar="ŸÖÿß ŸáŸà ÿßŸÑŸàÿ≤ŸÜ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ®Ÿä ŸÑŸÖŸÜÿ™ÿ¨ŸÉÿü (ÿ¨ÿ±ÿßŸÖ ÿ£Ÿà ÿ£ŸàŸÜÿµÿ©)" data-en="Approximately how much does your product weigh? (grams or ounces)">ŸÖÿß ŸáŸà ÿßŸÑŸàÿ≤ŸÜ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ®Ÿä ŸÑŸÖŸÜÿ™ÿ¨ŸÉÿü (ÿ¨ÿ±ÿßŸÖ ÿ£Ÿà ÿ£ŸàŸÜÿµÿ©)</label>
                        <input type="text" id="newProductWeight" data-ar-placeholder="ŸÖÿ´ÿßŸÑ: 200 ÿ¨ÿ±ÿßŸÖ ÿ£Ÿà 7 ÿ£ŸàŸÜÿµÿ©" data-en-placeholder="e.g., 200 grams or 7 ounces" placeholder="e.g., 200 grams or 7 ounces" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <!-- Fragility -->
                    <div class="input-group" style="margin-bottom: 15px;">
                        <label data-ar="ŸáŸÑ ŸÖŸÜÿ™ÿ¨ŸÉ Ÿáÿ¥ÿü ŸáŸÑ Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ≠ŸÖÿßŸäÿ© ÿÆÿßÿµÿ©ÿü" data-en="Is your product fragile? Does it need special protection?">ŸáŸÑ ŸÖŸÜÿ™ÿ¨ŸÉ Ÿáÿ¥ÿü ŸáŸÑ Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ≠ŸÖÿßŸäÿ© ÿÆÿßÿµÿ©ÿü</label>
                        <select id="newProductFragility" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            <option value="" data-ar="ÿßÿÆÿ™ÿ±..." data-en="Select...">ÿßÿÆÿ™ÿ±...</option>
                            <option value="Not fragile" data-ar="ŸÑŸäÿ≥ Ÿáÿ¥ÿßŸã" data-en="Not fragile">Not fragile</option>
                            <option value="Somewhat fragile" data-ar="Ÿáÿ¥ ŸÇŸÑŸäŸÑÿßŸã" data-en="Somewhat fragile">Somewhat fragile</option>
                            <option value="Very fragile" data-ar="Ÿáÿ¥ ÿ¨ÿØÿßŸã" data-en="Very fragile">Very fragile</option>
                            <option value="Needs cushioning/protection" data-ar="Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ Ÿàÿ≥ÿßÿØÿ©/ÿ≠ŸÖÿßŸäÿ©" data-en="Needs cushioning/protection">Needs cushioning/protection</option>
                        </select>
                    </div>
                    
                    <!-- Budget -->
                    <div class="input-group">
                        <label data-ar="ŸÖÿß ŸáŸä ŸÜÿ∑ÿßŸÇ ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉ ŸÑŸÑÿ™ÿ∫ŸÑŸäŸÅÿü (ŸÑŸÉŸÑ Ÿàÿ≠ÿØÿ© ÿ£Ÿà ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä)" data-en="What's your budget range for packaging? (per unit or total)">ŸÖÿß ŸáŸä ŸÜÿ∑ÿßŸÇ ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉ ŸÑŸÑÿ™ÿ∫ŸÑŸäŸÅÿü (ŸÑŸÉŸÑ Ÿàÿ≠ÿØÿ© ÿ£Ÿà ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä)</label>
                        <select id="newProductBudget" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            <option value="" data-ar="ÿßÿÆÿ™ÿ±..." data-en="Select...">ÿßÿÆÿ™ÿ±...</option>
                            <option value="Under 1 SAR/unit" data-ar="ÿ£ŸÇŸÑ ŸÖŸÜ 1 ÿ±ŸäÿßŸÑ/Ÿàÿ≠ÿØÿ©" data-en="Under 1 SAR/unit">Under 1 SAR/unit</option>
                            <option value="1-5 SAR/unit" data-ar="1-5 ÿ±ŸäÿßŸÑ/Ÿàÿ≠ÿØÿ©" data-en="1-5 SAR/unit">1-5 SAR/unit</option>
                            <option value="5-10 SAR/unit" data-ar="5-10 ÿ±ŸäÿßŸÑ/Ÿàÿ≠ÿØÿ©" data-en="5-10 SAR/unit">5-10 SAR/unit</option>
                            <option value="10-20 SAR/unit" data-ar="10-20 ÿ±ŸäÿßŸÑ/Ÿàÿ≠ÿØÿ©" data-en="10-20 SAR/unit">10-20 SAR/unit</option>
                            <option value="20+ SAR/unit" data-ar="20+ ÿ±ŸäÿßŸÑ/Ÿàÿ≠ÿØÿ©" data-en="20+ SAR/unit">20+ SAR/unit</option>
                            <option value="Budget flexible" data-ar="ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ŸÖÿ±ŸÜÿ©" data-en="Budget flexible">Budget flexible</option>
                            <option value="Will discuss" data-ar="ÿ≥ÿ£ŸÜÿßŸÇÿ¥" data-en="Will discuss">Will discuss</option>
                        </select>
                    </div>
                </div>
                
                <!-- Store Linkages Section -->
                <div style="margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333; font-size: 16px;" data-ar="ÿ±ÿ®ÿ∑ ÿßŸÑŸÖÿ™ÿ¨ÿ±" data-en="Store Linkages">Store Linkages</h3>
                        <button onclick="addStoreLinkage()" disabled style="padding: 8px 16px; background: #e0e0e0; color: #999; border: none; border-radius: 6px; font-weight: 600; cursor: not-allowed; font-size: 14px; opacity: 0.5;" data-ar="+ ÿ•ÿ∂ÿßŸÅÿ©" data-en="+ Add">+ Add</button>
                    </div>
                    
                    <!-- Store Linkages Table -->
                    <div id="storeLinkagesTable" style="margin-bottom: 20px; border: 1px solid #e8ecf1; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f5f7fa;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #666;" data-ar="ÿßŸÑŸÖŸÜÿ™ÿ¨/ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©" data-en="Linked product(s)">Linked product(s)</th>
                                </tr>
                            </thead>
                            <tbody id="storeLinkagesTableBody">
                                <tr>
                                    <td style="padding: 20px; text-align: center; color: #999;" data-ar="Store connection required" data-en="Store connection required">Store connection required</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Dialog Actions -->
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeAddProductDialog()" style="padding: 12px 24px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;" data-ar="ÿ•ŸÑÿ∫ÿßÿ°" data-en="Cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button onclick="saveNewProduct()" style="padding: 12px 24px; background: #1a1a1a; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;" data-ar="ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨" data-en="Save Product">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨</button>
                </div>
            </div>
        </div>
        
        <!-- Design Package Dialog -->
        <div id="designPackageModal" class="modal-overlay" style="display: none; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px);">
            <div class="modal-content" style="max-width: 900px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e8ecf1;">
                    <h2 style="margin: 0; color: #1a1a1a; font-size: 24px; font-weight: 700; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;" data-ar="ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ" data-en="Design Package">ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ</h2>
                    <button onclick="closeDesignPackageDialog()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: #999; line-height: 1; transition: color 0.2s; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" onmouseover="this.style.color='#1a1a1a'; this.style.background='#f0f0f0'" onmouseout="this.style.color='#999'; this.style.background='transparent'">&times;</button>
                </div>
                
                <!-- Package Selection Section -->
                <div id="packageSelectionForm" style="margin-bottom: 30px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                    <h3 style="margin-bottom: 20px; color: #1a1a1a; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üì¶</span>
                        <span data-ar="ŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑÿ∫ŸÑÿßŸÅ" data-en="Package Specifications">ŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑÿ∫ŸÑÿßŸÅ</span>
                    </h3>
                    
                    <!-- Material -->
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ŸáŸÑ ŸÑÿØŸäŸÉ ÿ™ŸÅÿ∂ŸäŸÑ ŸÑŸÑŸÖÿßÿØÿ©ÿü" data-en="Do you have a preference for Material?">ŸáŸÑ ŸÑÿØŸäŸÉ ÿ™ŸÅÿ∂ŸäŸÑ ŸÑŸÑŸÖÿßÿØÿ©ÿü</label>
                        <select id="packageMaterial" style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; background: white; transition: all 0.3s; cursor: pointer;" onfocus="this.style.borderColor='#FFC107'; this.style.boxShadow='0 0 0 3px rgba(255, 193, 7, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            <option value="" data-ar="ÿßÿÆÿ™ÿ±..." data-en="Select...">ÿßÿÆÿ™ÿ±...</option>
                            <option value="Corrugated" data-ar="ŸÖŸÖŸàÿ¨" data-en="Corrugated">Corrugated</option>
                            <option value="Folding Carton" data-ar="ÿµŸÜÿØŸàŸÇ ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ∑Ÿä" data-en="Folding Carton">Folding Carton</option>
                            <option value="Rigid Box" data-ar="ÿµŸÜÿØŸàŸÇ ÿµŸÑÿ®" data-en="Rigid Box">Rigid Box</option>
                            <option value="Paperboard" data-ar="Ÿàÿ±ŸÇ ŸÖŸÇŸàŸâ" data-en="Paperboard">Paperboard</option>
                            <option value="Kraft" data-ar="ŸÉÿ±ÿßŸÅÿ™" data-en="Kraft">Kraft</option>
                            <option value="White Cardboard" data-ar="ŸÉÿ±ÿ™ŸàŸÜ ÿ£ÿ®Ÿäÿ∂" data-en="White Cardboard">White Cardboard</option>
                        </select>
                    </div>
                    
                    <!-- Printing/Finish -->
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ÿ£ÿÆÿ®ÿ±ŸÜŸä ÿπŸÜ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©/ÿßŸÑŸÑŸÖÿ≥ÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©." data-en="Tell me about the Printing/Finish.">ÿ£ÿÆÿ®ÿ±ŸÜŸä ÿπŸÜ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©/ÿßŸÑŸÑŸÖÿ≥ÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©.</label>
                        
                        <!-- Printing Type (Radio - mutually exclusive) -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;" data-ar="ŸÜŸàÿπ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© (ÿßÿÆÿ™ÿ± Ÿàÿßÿ≠ÿØÿßŸã)" data-en="Printing Type (Select one)">ŸÜŸàÿπ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© (ÿßÿÆÿ™ÿ± Ÿàÿßÿ≠ÿØÿßŸã)</div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'; this.style.transform='translateX(4px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'; this.style.transform='translateX(0)'">
                                    <input type="radio" name="packagePrintType" value="Full color printing" id="printFullColor" style="margin: 0; width: 20px; height: 20px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333;" data-ar="ÿ∑ÿ®ÿßÿπÿ© ŸÖŸÑŸàŸÜÿ© ŸÉÿßŸÖŸÑÿ©" data-en="Full color printing">Full color printing</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'; this.style.transform='translateX(4px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'; this.style.transform='translateX(0)'">
                                    <input type="radio" name="packagePrintType" value="Logo only" id="printLogoOnly" style="margin: 0; width: 20px; height: 20px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333;" data-ar="ÿßŸÑÿ¥ÿπÿßÿ± ŸÅŸÇÿ∑" data-en="Logo only">Logo only</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'; this.style.transform='translateX(4px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'; this.style.transform='translateX(0)'">
                                    <input type="radio" name="packagePrintType" value="No printing" id="printNone" style="margin: 0; width: 20px; height: 20px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333;" data-ar="ÿ®ÿØŸàŸÜ ÿ∑ÿ®ÿßÿπÿ©" data-en="No printing">No printing</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Finishing Options (Checkboxes - can select multiple) -->
                        <div>
                            <div style="font-weight: 600; margin-bottom: 12px; color: #666; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;" data-ar="ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÑŸÖÿ≥ÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© (ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿπÿØÿ© ÿÆŸäÿßÿ±ÿßÿ™)" data-en="Finishing Options (Select multiple)">ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÑŸÖÿ≥ÿßÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© (ŸäŸÖŸÉŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿπÿØÿ© ÿÆŸäÿßÿ±ÿßÿ™)</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="Gold foil" id="finishGoldFoil" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ÿ±ŸÇÿßÿ¶ŸÇ ÿ∞Ÿáÿ®Ÿäÿ©" data-en="Gold foil">Gold foil</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="Silver foil" id="finishSilverFoil" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ÿ±ŸÇÿßÿ¶ŸÇ ŸÅÿ∂Ÿäÿ©" data-en="Silver foil">Silver foil</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="Matte lamination" id="finishMatte" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ÿ™ÿ∫ŸÑŸäŸÅ ÿ∫Ÿäÿ± ŸÑÿßŸÖÿπ" data-en="Matte lamination">Matte lamination</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="Glossy lamination" id="finishGlossy" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ÿ™ÿ∫ŸÑŸäŸÅ ŸÑÿßŸÖÿπ" data-en="Glossy lamination">Glossy lamination</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="UV coating" id="finishUV" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ÿ∑ŸÑÿßÿ° UV" data-en="UV coating">UV coating</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="Embossing" id="finishEmboss" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ŸÜŸÇÿ¥ ÿ®ÿßÿ±ÿ≤" data-en="Embossing">Embossing</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; background: white;" onmouseover="this.style.borderColor='#FFC107'; this.style.background='#FFF9E6'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                    <input type="checkbox" value="Debossing" id="finishDeboss" style="margin: 0; width: 18px; height: 18px; accent-color: #FFC107;">
                                    <span style="font-weight: 500; color: #333; font-size: 14px;" data-ar="ŸÜŸÇÿ¥ ÿ∫ÿßÿ¶ÿ±" data-en="Debossing">Debossing</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Package Matches Section (hidden initially) -->
                <div id="packageMatchesSection" style="display: none; margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1a1a1a; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üéØ</span>
                            <span data-ar="ÿßŸÑÿ£ÿ∫ŸÑŸÅÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©" data-en="Matching Packages">ÿßŸÑÿ£ÿ∫ŸÑŸÅÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©</span>
                        </h3>
                        <div id="sortControlsContainer" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <!-- Sort controls will be inserted here -->
                        </div>
                    </div>
                    <div id="packageMatchesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Package match cards will be rendered here -->
                    </div>
                </div>
                
                <!-- Generated Image Preview Section (hidden initially) -->
                <div id="generatedImageSection" style="display: none; margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1; text-align: center;">
                    <h3 style="margin-bottom: 20px; color: #1a1a1a; font-size: 18px; font-weight: 700;" data-ar="ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ™ÿµŸÖŸäŸÖ" data-en="Design Preview">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ™ÿµŸÖŸäŸÖ</h3>
                    <div id="generatedImageContainer" style="margin-bottom: 20px;">
                        <img id="generatedPackageImage" src="" alt="Generated Package Design" style="max-width: 100%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                    </div>
                    <button onclick="confirmPackageSelection()" style="padding: 14px 32px; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: #FFC107; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)'" data-ar="ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±" data-en="Confirm Selection">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±</button>
                </div>
                
                <!-- Dialog Actions -->
                <div style="margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1; display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeDesignPackageDialog()" style="padding: 14px 28px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.3s;" onmouseover="this.style.background='#d0d0d0'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#e0e0e0'; this.style.transform='translateY(0)'" data-ar="ÿ•ŸÑÿ∫ÿßÿ°" data-en="Cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button id="startDesignBtn" onclick="submitDesignPackage()" style="padding: 14px 32px; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: #FFC107; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)'" data-ar="ÿ®ÿØÿ° ÿßŸÑÿ™ÿµŸÖŸäŸÖ" data-en="Start Design">ÿ®ÿØÿ° ÿßŸÑÿ™ÿµŸÖŸäŸÖ</button>
                </div>
            </div>
        </div>
        
        <!-- Order Package Dialog -->
        <div id="orderPackageModal" class="modal-overlay" style="display: none; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px);">
            <div class="modal-content" style="max-width: 900px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e8ecf1;">
                    <h2 style="margin: 0; color: #1a1a1a; font-size: 24px; font-weight: 700; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;" data-ar="ÿ∑ŸÑÿ® ÿ∫ŸÑÿßŸÅ" data-en="Order Package">ÿ∑ŸÑÿ® ÿ∫ŸÑÿßŸÅ</h2>
                    <button onclick="closeOrderPackageDialog()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: #999; line-height: 1; transition: color 0.2s; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" onmouseover="this.style.color='#1a1a1a'; this.style.background='#f0f0f0'" onmouseout="this.style.color='#999'; this.style.background='transparent'">&times;</button>
                </div>
                
                <!-- Product & Package Info Section -->
                <div id="orderProductInfo" style="margin-bottom: 30px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                    <h3 style="margin-bottom: 20px; color: #1a1a1a; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üì¶</span>
                        <span data-ar="ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸàÿßŸÑÿ∫ŸÑÿßŸÅ" data-en="Product & Package Information">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸàÿßŸÑÿ∫ŸÑÿßŸÅ</span>
                    </h3>
                    <div id="orderProductDetails" style="color: #666; line-height: 1.8;">
                        <!-- Product and package info will be populated here -->
                    </div>
                </div>
                
                <!-- Fulfillment Specs Section -->
                <div id="orderFulfillmentSpecsForm" style="margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                    <h3 style="margin-bottom: 20px; color: #1a1a1a; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üöö</span>
                        <span data-ar="ŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞" data-en="Fulfillment Specifications">ŸÖŸàÿßÿµŸÅÿßÿ™ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞</span>
                    </h3>
                    
                    <!-- Quantity -->
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ŸÉŸÖ ÿπÿØÿØ ÿßŸÑŸàÿ≠ÿØÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ÿ∑ŸÑÿ®Ÿáÿßÿü" data-en="How many units would you like to order?">ŸÉŸÖ ÿπÿØÿØ ÿßŸÑŸàÿ≠ÿØÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ÿ∑ŸÑÿ®Ÿáÿßÿü</label>
                        <input type="number" id="orderQuantity" min="1" value="1" style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; font-family: inherit; transition: all 0.3s;" onfocus="this.style.borderColor='#FFC107'; this.style.boxShadow='0 0 0 3px rgba(255, 193, 7, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>
                    
                    <!-- Timeline -->
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ŸÖÿ™Ÿâ ŸáŸà ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖÿü" data-en="When is your deadline for delivery?">ŸÖÿ™Ÿâ ŸáŸà ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖÿü</label>
                        <select id="orderFulfillmentTimeline" style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; background: white; transition: all 0.3s; cursor: pointer;" onfocus="this.style.borderColor='#FFC107'; this.style.boxShadow='0 0 0 3px rgba(255, 193, 7, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            <option value="" data-ar="ÿßÿÆÿ™ÿ±..." data-en="Select...">ÿßÿÆÿ™ÿ±...</option>
                            <option value="1-2 weeks" data-ar="1-2 ÿ£ÿ≥ÿßÿ®Ÿäÿπ" data-en="1-2 weeks">1-2 weeks</option>
                            <option value="2-4 weeks" data-ar="2-4 ÿ£ÿ≥ÿßÿ®Ÿäÿπ" data-en="2-4 weeks">2-4 weeks</option>
                            <option value="1-2 months" data-ar="1-2 ÿ£ÿ¥Ÿáÿ±" data-en="1-2 months">1-2 months</option>
                            <option value="2-3 months" data-ar="2-3 ÿ£ÿ¥Ÿáÿ±" data-en="2-3 months">2-3 months</option>
                            <option value="3+ months" data-ar="3+ ÿ£ÿ¥Ÿáÿ±" data-en="3+ months">3+ months</option>
                            <option value="Flexible" data-ar="ŸÖÿ±ŸÜ" data-en="Flexible">Flexible</option>
                        </select>
                    </div>
                    
                    <!-- Shipping Address with Google Maps Autocomplete -->
                    <div class="input-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ÿ£ŸäŸÜ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸÜÿ≥ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®ÿü (Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÇÿØŸäŸÖ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ£Ÿà ÿßŸÑŸÖÿØŸäŸÜÿ©/ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©)" data-en="Where should we deliver the order? (Please provide shipping address or city/region)">ÿ£ŸäŸÜ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸÜÿ≥ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®ÿü (Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÇÿØŸäŸÖ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ£Ÿà ÿßŸÑŸÖÿØŸäŸÜÿ©/ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©)</label>
                        <input type="text" id="orderFulfillmentShippingAddress" data-ar-placeholder="ÿßÿ®ÿØÿ£ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿπŸÜŸàÿßŸÜ..." data-en-placeholder="Start typing to search for address..." placeholder="Start typing to search for address..." style="width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; font-family: inherit; transition: all 0.3s;" onfocus="this.style.borderColor='#FFC107'; this.style.boxShadow='0 0 0 3px rgba(255, 193, 7, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                    </div>
                    
                    <!-- Special Instructions -->
                    <div class="input-group">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 14px;" data-ar="ÿ£Ÿä ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ™ŸÜŸÅŸäÿ∞ ÿÆÿßÿµÿ© ÿ£Ÿà ŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ÿü (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä - ÿßŸÉÿ™ÿ® 'ŸÑÿß ÿ¥Ÿäÿ°' ŸÑŸÑÿ™ÿÆÿ∑Ÿä)" data-en="Any special fulfillment instructions or requirements? (optional - type 'none' to skip)">ÿ£Ÿä ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ™ŸÜŸÅŸäÿ∞ ÿÆÿßÿµÿ© ÿ£Ÿà ŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ÿü (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä - ÿßŸÉÿ™ÿ® 'ŸÑÿß ÿ¥Ÿäÿ°' ŸÑŸÑÿ™ÿÆÿ∑Ÿä)</label>
                        <textarea id="orderFulfillmentSpecialInstructions" data-ar-placeholder="ÿ£ÿØÿÆŸÑ ÿ£Ÿä ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿÆÿßÿµÿ© ÿ£Ÿà ÿßŸÉÿ™ÿ® 'ŸÑÿß ÿ¥Ÿäÿ°'..." data-en-placeholder="Enter any special instructions or type 'none'..." placeholder="Enter any special instructions or type 'none'..." style="width: 100%; min-height: 100px; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; font-family: inherit; resize: vertical; transition: all 0.3s;" onfocus="this.style.borderColor='#FFC107'; this.style.boxShadow='0 0 0 3px rgba(255, 193, 7, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                    </div>
                </div>
                
                <!-- Order Result Section (hidden initially) -->
                <div id="orderResultSection" style="display: none; margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); text-align: center;">
                    <h3 style="margin-bottom: 20px; color: #28a745; font-size: 18px; font-weight: 700;" data-ar="ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!" data-en="Order Created Successfully!">ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!</h3>
                    <div id="orderResultLinks" style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                        <!-- Order links will be populated here -->
                    </div>
                </div>
                
                <!-- Dialog Actions -->
                <div style="margin-top: 30px; padding-top: 25px; border-top: 2px solid #e8ecf1; display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeOrderPackageDialog()" style="padding: 14px 28px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.3s;" onmouseover="this.style.background='#d0d0d0'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#e0e0e0'; this.style.transform='translateY(0)'" data-ar="ÿ•ŸÑÿ∫ÿßÿ°" data-en="Cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button id="submitOrderBtn" onclick="submitOrder()" style="padding: 14px 32px; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: #FFC107; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)'" data-ar="ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®" data-en="Submit Order">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®</button>
                </div>
            </div>
        </div>
        
        <div class="steps-container" id="stepsContainer">
            <!-- Steps will be dynamically generated -->
        </div>
    </div>
    
    <script>
        // Salla Integration State
        let sallaAccessToken = null;
        let sallaStoreId = null;
        
        let currentFlow = 'direct_sales';
        let flowState = {
            productDetails: {}, // Product details answers
            package: null, // Package name
            variant: null, // Variant name
            packageImageUrl: null, // Package image URL for display in saved answers
            packageSpecs: {}, // Package specifications (material, dimensions, print)
            fulfillmentSpecs: {}, // Fulfillment specifications
            launchKit: {}, // Launch kit services
            draftOrder: null, // Draft order result
            backendStep: null, // Track backend step for step completion logic
            previousBackendStep: null, // Track previous backend step to detect transitions
            productMatches: [], // Auto-generated matches based on product details
            queryMatches: [], // User search query matches
            queryMatchesQuery: '' // The query string for query matches
        };
        let isLoading = false; // Track loading state
        
        const steps = [
            { id: 'product_details', name: 'Product Details', key: 'productDetails' },
            { id: 'package_selection', name: 'Package Selection', key: 'package' }, // Includes variant as substep
            { id: 'fulfillment_specs', name: 'Fulfilment Specs', key: 'fulfillmentSpecs' },
            { id: 'launch_kit', name: 'Launch Kit', key: 'launchKit' },
            { id: 'order', name: 'Draft Order', key: 'order' }
        ];
        
        // Flow selector removed - only direct_sales flow is supported
        // function selectFlow() removed - not needed for single flow
        
        function resetFlow() {
            flowState = {
                productDetails: {},
                package: null,
                variant: null,
                packageImageUrl: null,
                packageSpecs: {},
                fulfillmentSpecs: {},
                launchKit: {},
                draftOrder: null,
                backendStep: null,
                previousBackendStep: null
            };
            renderSteps();
        }
        
        function renderSteps() {
            const container = document.getElementById('stepsContainer');
            let html = '';
            
            steps.forEach((step, index) => {
                const isCompleted = isStepCompleted(step.id);
                const isActive = isStepActive(step.id);
                const stepData = getStepData(step.id);
                
                html += `
                    <div class="step-section ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}" data-step="${step.id}">
                        <div class="step-header" onclick="toggleStep('${step.id}')">
                            <div class="step-title">
                                <div class="step-number">${isCompleted ? '‚úì' : (index + 1)}</div>
                                <div class="step-info">
                                    <div class="step-name">${step.name}</div>
                                    <div class="step-detail">${getStepDetail(step.id, stepData)}</div>
                                </div>
                            </div>
                            <div class="step-chevron">‚ñº</div>
                        </div>
                        <div class="step-content">
                            ${isActive ? renderStepContent(step.id, stepData) : (isCompleted ? renderCompletedView(step.id, stepData) : '')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Expand active step and focus input
            steps.forEach(step => {
                const isActive = isStepActive(step.id);
                if (isActive) {
                    const stepEl = document.querySelector(`[data-step="${step.id}"]`);
                    if (stepEl) {
                        stepEl.classList.add('active');
                        autoFocusInput(step.id);
                    }
                }
            });
        }
        
        function isStepCompleted(stepId) {
            if (stepId === 'product_details') {
                // Check if backend has moved past this step
                const backendStep = flowState.backendStep || '';
                if (backendStep === 'select_package' || backendStep === 'select_package_discovery' || 
                    backendStep === 'select_package_variant' || backendStep === 'select_package_specs' ||
                    backendStep === 'fulfillment_specs' || backendStep === 'launch_kit' || backendStep === 'draft_order') {
                    // Backend has moved past product_details, so it's completed
                    return true;
                }
                // Otherwise check if all required questions are answered
                const hasDescription = flowState.productDetails?.product_description;
                const hasBudget = flowState.productDetails?.budget;
                return hasDescription && hasBudget;
            }
            if (stepId === 'package_selection') {
                // Package selection is completed when package and variant are selected, and package specs are done
                // OR if package specs exist (even if package is null during edit)
                const hasPackage = !!flowState.package;
                const hasVariant = !!(flowState.variant || flowState.variant === 'Default');
                const hasSpecs = Object.keys(flowState.packageSpecs || {}).length > 0;
                const completed = (hasPackage && hasVariant && hasSpecs) || hasSpecs; // Completed if full selection OR just specs exist
                
                console.log(`[isStepCompleted] package_selection:`, completed, {
                    hasPackage: hasPackage,
                    package: flowState.package,
                    hasVariant: hasVariant,
                    variant: flowState.variant,
                    hasSpecs: hasSpecs,
                    packageSpecs: flowState.packageSpecs,
                    packageSpecsKeys: flowState.packageSpecs ? Object.keys(flowState.packageSpecs) : []
                });
                
                return completed;
            }
            if (stepId === 'fulfillment_specs') {
                return Object.keys(flowState.fulfillmentSpecs || {}).length > 0 && flowState.fulfillmentSpecs.quantity;
            }
            if (stepId === 'launch_kit') {
                // Launch kit is optional, so it's completed if answered or if we moved to order
                return flowState.draftOrder || Object.keys(flowState.launchKit || {}).length > 0;
            }
            if (stepId === 'order') return !!flowState.draftOrder;
            return false;
        }
        
        function isStepActive(stepId) {
            const result = (() => {
                if (flowState.draftOrder) return stepId === 'order';
                
                // CRITICAL: Use backend step to determine active step, not just completion status
                // This ensures we wait for the backend to actually transition before showing the step
                const backendStep = flowState.backendStep || '';
                
                // Map backend steps to frontend steps
                const stepMapping = {
                    'start': 'product_details', // 'start' step maps to product_details
                    'product_details': 'product_details',
                    'select_package': 'package_selection',
                    'select_package_discovery': 'package_selection',
                    'select_package_variant': 'package_selection',
                    'select_package_specs': 'package_selection', // Package specs is part of package_selection
                    'fulfillment_specs': 'fulfillment_specs',
                    'launch_kit': 'launch_kit',
                    'draft_order': 'order'
                };
                
                // If we have a backend step, use it to determine active step
                if (backendStep) {
                    const mappedStep = stepMapping[backendStep];
                    if (mappedStep) {
                        return stepId === mappedStep;
                    }
                    // If backendStep exists but isn't in mapping, fall through to completion-based logic
                }
                
                // Fallback: Determine which step should be active based on completion state
                // This is used when backend step is not yet set (initial load) or doesn't map to a step
                // On initial load, product_details should be active
                if (!backendStep || backendStep === 'start') {
                    return stepId === 'product_details';
                }
                if (!isStepCompleted('product_details')) return stepId === 'product_details';
                if (!isStepCompleted('package_selection')) return stepId === 'package_selection';
                if (!isStepCompleted('fulfillment_specs')) return stepId === 'fulfillment_specs';
                if (!isStepCompleted('launch_kit')) return stepId === 'launch_kit';
                
                return stepId === 'order';
            })();
            
            console.log(`[isStepActive] ${stepId}:`, result, 'backendStep:', flowState.backendStep);
            return result;
        }
        
        function getStepData(stepId) {
            console.log(`[getStepData] Getting data for ${stepId}, backendStep:`, flowState.backendStep);
            
            if (stepId === 'product_details') {
                console.log(`[getStepData] Returning productDetailsData:`, flowState.productDetailsData);
                return flowState.productDetailsData;
            }
            
            if (stepId === 'package_selection') {
                // Package selection step can show either packageData (for product search/selection)
                // or packageSpecsData (for package specs questions)
                // Prefer packageSpecsData if it has a currentQuestion, otherwise use packageData
                const backendStep = flowState.backendStep || '';
                
                // If backend is in package specs, use packageSpecsData
                if (backendStep === 'select_package_specs') {
                    console.log(`[getStepData] Backend in select_package_specs, returning packageSpecsData:`, flowState.packageSpecsData);
                    return flowState.packageSpecsData;
                }
                
                // Otherwise use packageData for search/selection
                console.log(`[getStepData] Returning packageData:`, flowState.packageData);
                return flowState.packageData;
            }
            
            if (stepId === 'fulfillment_specs') {
                console.log(`[getStepData] Returning fulfillmentSpecsData:`, flowState.fulfillmentSpecsData);
                return flowState.fulfillmentSpecsData;
            }
            
            if (stepId === 'launch_kit') {
                console.log(`[getStepData] Returning launchKitData:`, flowState.launchKitData);
                return flowState.launchKitData;
            }
            
            console.log(`[getStepData] No data found for ${stepId}`);
            return null;
        }
        
        // Alias for backward compatibility
        
        function getStepDetail(stepId, stepData) {
            if (stepId === 'product_details') {
                const count = Object.keys(flowState.productDetails || {}).filter(k => flowState.productDetails[k] && flowState.productDetails[k] !== 'undefined').length;
                return count > 0 ? `${count} question(s) answered` : 'Pending';
            }
            if (stepId === 'package_selection') {
                if (flowState.package) {
                    let detail = flowState.package;
                    if (flowState.variant && flowState.variant !== 'Default') {
                        detail += ' | Variant: ' + flowState.variant;
                    } else if (flowState.variant === 'Default') {
                        detail += ' | Default';
                    }
                    const specsCount = Object.keys(flowState.packageSpecs || {}).length;
                    if (specsCount > 0) detail += ` | ${specsCount} spec(s)`;
                    return detail;
                }
                return 'Pending';
            }
            if (stepId === 'fulfillment_specs') {
                const count = Object.keys(flowState.fulfillmentSpecs || {}).filter(k => flowState.fulfillmentSpecs[k] && flowState.fulfillmentSpecs[k] !== 'undefined').length;
                return count > 0 ? `${count} question(s) answered` : 'Pending';
            }
            if (stepId === 'launch_kit') {
                const count = Object.keys(flowState.launchKit || {}).filter(k => flowState.launchKit[k] && flowState.launchKit[k] !== 'undefined').length;
                return count > 0 ? `${count} question(s) answered` : 'Pending';
            }
            if (stepId === 'order' && flowState.draftOrder) return 'Order created successfully';
            return 'Pending';
        }
        
        function toggleStep(stepId) {
            const stepEl = document.querySelector(`[data-step="${stepId}"]`);
            if (stepEl) {
                stepEl.classList.toggle('active');
            }
        }
        
        function renderStepContent(stepId, stepData) {
            const backendStep = flowState.backendStep || '';
            console.log(`[renderStepContent] Rendering ${stepId}, backendStep: ${backendStep}, stepData:`, stepData);
            
            // Product Details step
            if (stepId === 'product_details') {
                // Only render if backend is in product_details or we're initializing
                if (backendStep && backendStep !== 'product_details' && backendStep !== 'start') {
                    console.warn(`[renderStepContent] Backend step (${backendStep}) doesn't match product_details, but step is active`);
                }
                return renderConsultationStep('product_details', flowState.productDetails, stepData);
            }
            
            // Package Selection step
            if (stepId === 'package_selection') {
                console.log('[renderStepContent] Rendering package_selection');
                console.log('[renderStepContent] flowState.package:', flowState.package);
                console.log('[renderStepContent] flowState.packageSpecs:', flowState.packageSpecs);
                console.log('[renderStepContent] flowState.packageSpecsData:', flowState.packageSpecsData);
                console.log('[renderStepContent] stepData:', stepData);
                console.log('[renderStepContent] backendStep:', backendStep);
                
                // CRITICAL: If backend is in discovery mode, show search UI AND matches if available
                // This handles the case when editing package - show both search box and existing matches
                if (backendStep === 'select_package_discovery' || backendStep === 'select_package') {
                    let html = '<div class="step-body">';
                    // Always show search box when in discovery mode (empty initially)
                    html += renderProductSearch();
                    
                    // Show loading indicator if we're waiting for auto-search results
                    // Check if we have product details but no product matches yet (search in progress)
                    const hasProductDetails = flowState.productDetails && Object.keys(flowState.productDetails).length > 0;
                    const hasNoMatches = (!flowState.productMatches || flowState.productMatches.length === 0) &&
                                        (!flowState.queryMatches || flowState.queryMatches.length === 0);
                    if (hasProductDetails && hasNoMatches && backendStep === 'select_package_discovery') {
                        html += '<div style="margin-top: 20px; padding: 20px; text-align: center; color: #666;">';
                        html += '<div class="loading-spinner" style="margin: 0 auto 10px; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>';
                        html += '<div>Searching for packages that match your product...</div>';
                        html += '</div>';
                    }
                    
                    // Show query matches first (user searches) if they exist
                    if (flowState.queryMatches && flowState.queryMatches.length > 0) {
                        const queryTitle = flowState.queryMatchesQuery 
                            ? `Query Matches: "${flowState.queryMatchesQuery}"` 
                            : 'Query Matches';
                        html += renderCollapsibleMatchSection(queryTitle, flowState.queryMatches, 'queryMatchesSection', false, 'queryMatches');
                    }
                    
                    // Show product matches (auto-generated) below query matches
                    if (flowState.productMatches && flowState.productMatches.length > 0) {
                        html += renderCollapsibleMatchSection('Product Matches', flowState.productMatches, 'productMatchesSection', false, 'productMatches');
                    }
                    
                    html += '</div>';
                    return html;
                }
                
                // If we have package specs question, render that with package/variant shown as completed
                // BUT only if we're NOT in discovery mode
                if (flowState.packageSpecsData && flowState.packageSpecsData.currentQuestion) {
                    console.log('[renderStepContent] Rendering package_specs consultation step');
                    // Create a combined answers object that includes package, variant, and package specs
                    const combinedAnswers = { ...flowState.packageSpecs };
                    if (flowState.package) {
                        combinedAnswers['_package'] = flowState.package; // Use _package to distinguish from package specs
                    }
                    if (flowState.variant) {
                        combinedAnswers['_variant'] = flowState.variant; // Use _variant to distinguish
                    }
                    return renderConsultationStep('package_specs', combinedAnswers, flowState.packageSpecsData, true);
                }
                // Otherwise show product search/selection
                if (stepData && stepData.matches && stepData.matches.length > 0) {
                    console.log('[renderStepContent] Rendering product selection with matches');
                    return renderProductSelection(stepData.matches);
                }
                console.log('[renderStepContent] Rendering product search');
                return renderProductSearch();
            }
            
            // Fulfillment Specs step
            if (stepId === 'fulfillment_specs') {
                // CRITICAL: Only render if backend has actually transitioned to fulfillment_specs
                if (backendStep && backendStep !== 'fulfillment_specs') {
                    console.warn(`[renderStepContent] Backend step (${backendStep}) doesn't match fulfillment_specs!`);
                    console.warn(`[renderStepContent] Waiting for backend to transition to fulfillment_specs...`);
                    return '<div class="step-body"><p style="color: #666;">‚è≥ Waiting for backend to transition to this step...</p></div>';
                }
                return renderConsultationStep('fulfillment_specs', flowState.fulfillmentSpecs, stepData);
            }
            
            // Launch Kit step
            if (stepId === 'launch_kit') {
                // Only render if backend is in launch_kit
                if (backendStep && backendStep !== 'launch_kit') {
                    console.warn(`[renderStepContent] Backend step (${backendStep}) doesn't match launch_kit!`);
                    return '<div class="step-body"><p style="color: #666;">‚è≥ Waiting for backend to transition to this step...</p></div>';
                }
                return renderConsultationStep('launch_kit', flowState.launchKit, stepData);
            }
            
            // Order step
            if (stepId === 'order') {
                if (flowState.draftOrder) {
                    return renderDraftOrder(flowState.draftOrder);
                }
                return '<div class="step-body"><p>Generating draft order...</p></div>';
            }
            return '';
        }
        
        // Helper function to get question order for a step (maintains original order from charter)
        function getQuestionOrder(stepId) {
            // Define question order based on SALES_CHARTER structure
            const orderMap = {
                'product_details': ['product_description', 'product_dimensions', 'product_weight', 'fragility', 'budget'],
                'package_specs': ['material', 'print'],
                'fulfillment_specs': ['quantity', 'timeline', 'shipping_address', 'special_instructions'],
                'launch_kit': ['service_selection', 'service_timeline', 'service_notes']
            };
            return orderMap[stepId] || [];
        }
        
        // Helper function to render consultation-style steps
        function renderConsultationStep(stepId, answers, stepData, includePackageVariant = false) {
            console.log(`[renderConsultationStep] ========== START Rendering ${stepId} ==========`);
            console.log(`[renderConsultationStep] answers:`, answers);
            console.log(`[renderConsultationStep] answers keys:`, answers ? Object.keys(answers) : 'null');
            console.log(`[renderConsultationStep] stepData:`, stepData);
            console.log(`[renderConsultationStep] hasAnswers:`, !!(answers && Object.keys(answers).length > 0));
            console.log(`[renderConsultationStep] hasStepData:`, !!stepData);
            console.log(`[renderConsultationStep] hasCurrentQuestion:`, !!(stepData && stepData.currentQuestion));
            console.log(`[renderConsultationStep] currentQuestion:`, stepData?.currentQuestion);
            console.log(`[renderConsultationStep] includePackageVariant:`, includePackageVariant);
            
            let html = '';
            
            // Show completed questions first - in the correct order
            if (answers && Object.keys(answers).length > 0) {
                html += '<div class="completed-questions-section">';
                html += '<div style="font-weight: 600; margin-bottom: 12px; color: #28a745;">‚úì Completed Questions:</div>';
                
                // For package_specs step, show package and variant first if they exist
                if (includePackageVariant && stepId === 'package_specs') {
                    if (answers['_package']) {
                        const packageImageUrl = flowState.packageImageUrl || flowState.packageData?.selectedImageUrl;
                        const imageHtml = packageImageUrl 
                            ? `<img src="${packageImageUrl}" alt="${answers['_package']}" style="width: 100%; max-width: 200px; height: auto; border-radius: 6px; margin-top: 8px; margin-bottom: 8px; object-fit: cover;">`
                            : '';
                        html += `<div class="completed-question-item">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">Package</div>
                                <div style="color: #333;">${answers['_package']}</div>
                                ${imageHtml}
                            </div>
                            <span class="edit-icon" onclick="editPackageSelection()" title="Change package">‚úèÔ∏è</span>
                        </div>`;
                    }
                    if (answers['_variant']) {
                        html += `<div class="completed-question-item" style="margin-top: 10px;">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">Variant</div>
                                <div style="color: #333;">${answers['_variant'] === 'Default' ? 'Default' : answers['_variant']}</div>
                            </div>
                        </div>`;
                    }
                }
                
                // Get the correct question order for this step
                const questionOrder = getQuestionOrder(stepId);
                
                // Render questions in the correct order (excluding _package and _variant)
                questionOrder.forEach(questionId => {
                    const answer = answers[questionId];
                    if (answer && answer !== 'undefined' && answer !== undefined) {
                        html += `<div class="completed-question-item" ${includePackageVariant && stepId === 'package_specs' ? 'style="margin-top: 10px;"' : ''}>
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(questionId)}</div>
                                <div style="color: #333;">${answer}</div>
                            </div>
                            <span class="edit-icon" onclick="editQuestion('${stepId}', '${questionId}')" title="Edit this answer">‚úèÔ∏è</span>
                        </div>`;
                    }
                });
                
                // Also render any questions that aren't in the order map (fallback, excluding _package and _variant)
                Object.entries(answers).forEach(([questionId, answer]) => {
                    if (questionId !== '_package' && questionId !== '_variant' && 
                        !questionOrder.includes(questionId) && answer && answer !== 'undefined' && answer !== undefined) {
                        html += `<div class="completed-question-item" ${includePackageVariant && stepId === 'package_specs' ? 'style="margin-top: 10px;"' : ''}>
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(questionId)}</div>
                                <div style="color: #333;">${answer}</div>
                            </div>
                            <span class="edit-icon" onclick="editQuestion('${stepId}', '${questionId}')" title="Edit this answer">‚úèÔ∏è</span>
                        </div>`;
                    }
                });
                
                html += '</div>';
            }
            
            // Show current question
            if (stepData && stepData.currentQuestion) {
                console.log(`[renderConsultationStep] Rendering question for ${stepId}:`, stepData.currentQuestion.id);
                html += renderQuestion(stepData.currentQuestion);
            } else {
                // Check if this step is supposed to be active (backend step matches)
                const backendStep = flowState.backendStep || '';
                const expectedBackendSteps = {
                    'product_details': 'product_details',
                    'package_specs': 'select_package_specs',
                    'fulfillment_specs': 'fulfillment_specs',
                    'launch_kit': 'launch_kit'
                };
                const expectedBackendStep = expectedBackendSteps[stepId];
                
                // Only show loading if backend step matches (meaning we're waiting for question)
                // Otherwise, it might be that the step isn't active yet
                if (expectedBackendStep && backendStep === expectedBackendStep) {
                    console.warn(`[renderConsultationStep] NO currentQuestion for ${stepId} but backend step matches!`);
                    console.warn(`[renderConsultationStep] stepData:`, stepData);
                    console.warn(`[renderConsultationStep] flowState.backendStep:`, flowState.backendStep);
                    html += '<div class="step-body"><p style="color: #666;">Loading...</p></div>';
                } else {
                    // Step might not be active yet, or we're in a transition
                    console.log(`[renderConsultationStep] No currentQuestion for ${stepId}, backend step: ${backendStep}, expected: ${expectedBackendStep}`);
                    // Don't show error if step isn't supposed to be active
                    if (backendStep && expectedBackendStep && backendStep !== expectedBackendStep) {
                        html += '<div class="step-body"><p style="color: #666;">Loading...</p></div>';
                    } else {
                        html += '<div class="step-body"><p style="color: #666;">Loading...</p></div>';
                    }
                }
            }
            
            return html;
        }
        
        function renderCompletedView(stepId, stepData) {
            if (stepId === 'product_details' && flowState.productDetails) {
                let html = '<div class="step-body completed-view">';
                Object.entries(flowState.productDetails).forEach(([key, value]) => {
                    if (value && value !== 'undefined') {
                        html += `<div class="completed-question-item">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(key)}</div>
                                <div style="color: #333;">${value}</div>
                            </div>
                            <span class="edit-icon" onclick="editQuestion('product_details', '${key}')" title="Edit this answer">‚úèÔ∏è</span>
                        </div>`;
                    }
                });
                html += '</div>';
                return html;
            }
            // Package selection completed view - show even if package is null (during edit) if we have package specs
            if (stepId === 'package_selection') {
                console.log('[renderCompletedView] Rendering package_selection completed view');
                console.log('[renderCompletedView] flowState.package:', flowState.package);
                console.log('[renderCompletedView] flowState.variant:', flowState.variant);
                console.log('[renderCompletedView] flowState.packageSpecs:', flowState.packageSpecs);
                console.log('[renderCompletedView] flowState.packageSpecs keys:', flowState.packageSpecs ? Object.keys(flowState.packageSpecs) : 'null');
                console.log('[renderCompletedView] Should render?', flowState.package || (flowState.packageSpecs && Object.keys(flowState.packageSpecs).length > 0));
                
                if (flowState.package || (flowState.packageSpecs && Object.keys(flowState.packageSpecs).length > 0)) {
                    let html = `<div class="step-body completed-view">`;
                    
                    // Show package if it exists (with image if available)
                    if (flowState.package) {
                        console.log('[renderCompletedView] Rendering package:', flowState.package);
                        const packageImageUrl = flowState.packageImageUrl || flowState.packageData?.selectedImageUrl;
                        const imageHtml = packageImageUrl 
                            ? `<img src="${packageImageUrl}" alt="${flowState.package}" style="width: 100%; max-width: 200px; height: auto; border-radius: 6px; margin-top: 8px; margin-bottom: 8px; object-fit: cover;">`
                            : '';
                        html += `<div class="completed-question-item">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">Package</div>
                                <div style="color: #333;">${flowState.package}</div>
                                ${imageHtml}
                            </div>
                            <span class="edit-icon" onclick="editPackageSelection()" title="Change package">‚úèÔ∏è</span>
                        </div>`;
                    } else {
                        console.log('[renderCompletedView] Package is null, skipping package display');
                    }
                    
                    // Show variant if it exists
                    if (flowState.variant) {
                        console.log('[renderCompletedView] Rendering variant:', flowState.variant);
                        html += `<div class="completed-question-item" style="margin-top: 10px;">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">Variant</div>
                                <div style="color: #333;">${flowState.variant === 'Default' ? 'Default' : flowState.variant}</div>
                            </div>
                        </div>`;
                    }
                    
                    // CRITICAL: Always show package specs if they exist, even if package is null (during edit)
                    if (flowState.packageSpecs && Object.keys(flowState.packageSpecs).length > 0) {
                        console.log('[renderCompletedView] Rendering packageSpecs:', Object.keys(flowState.packageSpecs).length, 'items');
                        Object.entries(flowState.packageSpecs).forEach(([key, value]) => {
                            console.log('[renderCompletedView] Rendering packageSpec:', key, '=', value);
                            if (value && value !== 'undefined') {
                                html += `<div class="completed-question-item" style="margin-top: 10px;">
                                    <div class="answer-content">
                                        <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(key)}</div>
                                        <div style="color: #333;">${value}</div>
                                    </div>
                                    <span class="edit-icon" onclick="editQuestion('package_specs', '${key}')" title="Edit this answer">‚úèÔ∏è</span>
                                </div>`;
                            }
                        });
                    } else {
                        console.log('[renderCompletedView] No packageSpecs to render');
                    }
                    html += '</div>';
                    console.log('[renderCompletedView] Returning completed view HTML');
                    return html;
                } else {
                    console.log('[renderCompletedView] Not rendering - no package and no packageSpecs');
                    return '';
                }
            }
            if (stepId === 'fulfillment_specs' && flowState.fulfillmentSpecs) {
                let html = '<div class="step-body completed-view">';
                Object.entries(flowState.fulfillmentSpecs).forEach(([key, value]) => {
                    if (value && value !== 'undefined') {
                        html += `<div class="completed-question-item">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(key)}</div>
                                <div style="color: #333;">${value}</div>
                            </div>
                            <span class="edit-icon" onclick="editQuestion('fulfillment_specs', '${key}')" title="Edit this answer">‚úèÔ∏è</span>
                        </div>`;
                    }
                });
                html += '</div>';
                return html;
            }
            if (stepId === 'launch_kit' && flowState.launchKit) {
                let html = '<div class="step-body completed-view">';
                Object.entries(flowState.launchKit).forEach(([key, value]) => {
                    if (value && value !== 'undefined') {
                        html += `<div class="completed-question-item">
                            <div class="answer-content">
                                <div style="font-weight: 500; color: #666; font-size: 14px; margin-bottom: 4px;">${getQuestionLabel(key)}</div>
                                <div style="color: #333;">${value}</div>
                            </div>
                            <span class="edit-icon" onclick="editQuestion('launch_kit', '${key}')" title="Edit this answer">‚úèÔ∏è</span>
                        </div>`;
                    }
                });
                html += '</div>';
                return html;
            }
            return '';
        }
        
        // Function to handle editing a question
        function editQuestion(stepId, questionId) {
            console.log(`[editQuestion] Editing ${stepId}.${questionId}`);
            
            // Determine which consultation state to use
            let consultationKey = 'fulfillmentSpecs';
            let dataKey = 'fulfillmentSpecsData';
            let backendStepName = 'fulfillment_specs';
            
            if (stepId === 'product_details') {
                consultationKey = 'productDetails';
                dataKey = 'productDetailsData';
                backendStepName = 'product_details';
            } else if (stepId === 'package_specs') {
                consultationKey = 'packageSpecs';
                dataKey = 'packageSpecsData';
                backendStepName = 'select_package_specs';
            } else if (stepId === 'launch_kit') {
                consultationKey = 'launchKit';
                dataKey = 'launchKitData';
                backendStepName = 'launch_kit';
            }
            
            // CRITICAL: Initialize step data structure if it doesn't exist
            if (!flowState[dataKey]) {
                flowState[dataKey] = {};
            }
            
            // CRITICAL: Set backend step BEFORE sending edit request
            // This ensures the step is activated immediately
            flowState.backendStep = backendStepName;
            
            // CRITICAL: DO NOT delete the answer yet - wait for backend confirmation
            // The backend will handle clearing the answer from memory
            // We only clear currentQuestion to trigger re-fetch
            flowState[dataKey].currentQuestion = null;
            
            // Ensure the consultation answers object exists (for displaying other completed questions)
            if (!flowState[consultationKey]) {
                flowState[consultationKey] = {};
            }
            
            console.log(`[editQuestion] Prepared edit for ${stepId}.${questionId}, backendStep set to: ${backendStepName}`);
            
            // Send a message to re-ask this question
            sendSelection(`edit:${questionId}`, { 
                type: 'edit', 
                stepId: stepId,
                questionId: questionId 
            });
        }
        
        function editPackageSelection() {
            console.log('[editPackageSelection] ========== START ==========');
            console.log('[editPackageSelection] Current flowState:', JSON.parse(JSON.stringify({
                package: flowState.package,
                variant: flowState.variant,
                packageSpecs: flowState.packageSpecs,
                packageSpecsData: flowState.packageSpecsData,
                packageData: flowState.packageData,
                backendStep: flowState.backendStep
            })));
            
            // Clear only package and variant selection (not package specs)
            // Package specs should be preserved unless the new package requires different specs
            const preservedPackageSpecs = flowState.packageSpecs ? JSON.parse(JSON.stringify(flowState.packageSpecs)) : null;
            const preservedPackageSpecsData = flowState.packageSpecsData ? JSON.parse(JSON.stringify(flowState.packageSpecsData)) : null;
            
            console.log('[editPackageSelection] Preserving packageSpecs:', preservedPackageSpecs);
            console.log('[editPackageSelection] Preserving packageSpecsData:', preservedPackageSpecsData);
            
            flowState.package = null;
            flowState.variant = null;
            // DO NOT clear flowState.packageSpecs - preserve existing answers
            // DO NOT clear productMatches and queryMatches - preserve both lists when editing
            // Clear packageSpecsData so it doesn't interfere with showing search UI during edit
            flowState.packageSpecsData = null;
            flowState.packageData = null; // Clear package search/selection data
            // Preserve both match lists - don't clear them
            console.log('[editPackageSelection] Preserving productMatches:', flowState.productMatches?.length || 0);
            console.log('[editPackageSelection] Preserving queryMatches:', flowState.queryMatches?.length || 0);
            
            console.log('[editPackageSelection] After clearing - flowState:', JSON.parse(JSON.stringify({
                package: flowState.package,
                variant: flowState.variant,
                packageSpecs: flowState.packageSpecs,
                packageSpecsData: flowState.packageSpecsData,
                packageData: flowState.packageData
            })));
            
            // Set backend step to package selection/discovery to trigger edit mode
            flowState.backendStep = 'select_package_discovery';
            
            // Send a special edit message that backend can recognize
            // Just send "edit package:" without any query - backend should handle edit mode without triggering a new search
            const editMessage = 'edit package:';
            
            console.log('[editPackageSelection] Sending edit message:', editMessage);
            console.log('[editPackageSelection] Backend step set to: select_package_discovery');
            console.log('[editPackageSelection] ========== END ==========');
            
            sendSelection(editMessage, { 
                type: 'product_search', 
                stepId: 'package_selection',
                isEdit: true // Mark as edit request
            });
            
            // Ensure search input is empty when editing
            setTimeout(() => {
                const searchInput = document.getElementById('productSearchInput');
                if (searchInput) {
                    searchInput.value = '';
                }
            }, 100);
        }
        
        function renderProductSearch() {
            // Search box should be empty initially to allow user to enter their own query
            return `
                <div class="question-text">What package are you looking for?</div>
                <div class="input-group">
                    <input type="text" id="productSearchInput" placeholder="e.g., Custom Boxes, Bags, Printing Services..." 
                           value=""
                           onkeydown="if(event.key==='Enter') searchProducts()">
                </div>
                <button class="submit-btn" onclick="searchProducts()">Search Packages</button>
                <div id="searchFallbackMessage" style="display: none; margin-top: 12px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404;">
                    No packages found. Try a simpler search like "box" or "packaging", or use the "Custom Package" option in the search results.
                </div>
            `;
        }
        
        function renderCollapsibleMatchSection(title, matches, sectionId, isExpanded = false, matchSource = 'unknown') {
            if (!matches || matches.length === 0) return '';
            
            const expandedClass = isExpanded ? 'expanded' : '';
            const displayStyle = isExpanded ? 'block' : 'none';
            const icon = isExpanded ? '‚ñº' : '‚ñ∂';
            
            return `
                <div class="match-section" style="margin-top: 20px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                    <div class="match-section-header" onclick="toggleMatchSection('${sectionId}')" style="padding: 12px 16px; background: #f8f9fa; cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none;">
                        <div style="font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 12px; color: #666;">${icon}</span>
                            <span>${title}</span>
                            <span style="font-size: 12px; font-weight: normal; color: #666;">(${matches.length})</span>
                        </div>
                    </div>
                    <div id="${sectionId}" class="match-section-content" style="display: ${displayStyle}; padding: 16px;">
                        ${renderProductSelection(matches, matchSource)}
                    </div>
                </div>
            `;
        }
        
        function toggleMatchSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('span');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }
        
        function showCustomPackageForm() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('customPackageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customPackageModal';
                modal.className = 'modal-overlay';
                modal.style.display = 'none';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2 style="margin-bottom: 20px; color: #333;">Custom Package - Enter Dimensions</h2>
                        <div class="dimensions-row" style="margin-bottom: 20px;">
                            <div class="input-group">
                                <label>Length (cm)</label>
                                <input type="number" id="customLength" placeholder="e.g., 20" min="1" step="0.1" oninput="calculateCustomPrice()">
                            </div>
                            <div class="input-group">
                                <label>Width (cm)</label>
                                <input type="number" id="customWidth" placeholder="e.g., 15" min="1" step="0.1" oninput="calculateCustomPrice()">
                            </div>
                            <div class="input-group">
                                <label>Height (cm)</label>
                                <input type="number" id="customHeight" placeholder="e.g., 10" min="1" step="0.1" oninput="calculateCustomPrice()">
                            </div>
                        </div>
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 6px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #666;">Calculated Price:</div>
                            <div id="customPriceDisplay" style="font-size: 24px; font-weight: 700; color: #FFC107;">0.00 SAR</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Formula: (L √ó W √ó H) √∑ 10</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="submit-btn" onclick="confirmCustomPackage()" style="flex: 1;">Confirm Custom Package</button>
                            <button class="submit-btn" onclick="closeCustomPackageModal()" style="flex: 1; background: #6c757d;">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            modal.style.display = 'flex';
            // Reset inputs
            document.getElementById('customLength').value = '';
            document.getElementById('customWidth').value = '';
            document.getElementById('customHeight').value = '';
            document.getElementById('customPriceDisplay').textContent = '0.00 SAR';
        }
        
        function closeCustomPackageModal() {
            const modal = document.getElementById('customPackageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function calculateCustomPrice() {
            const length = parseFloat(document.getElementById('customLength').value) || 0;
            const width = parseFloat(document.getElementById('customWidth').value) || 0;
            const height = parseFloat(document.getElementById('customHeight').value) || 0;
            
            // Price = L √ó W √ó H / 10
            const price = (length * width * height) / 10;
            document.getElementById('customPriceDisplay').textContent = price.toFixed(2) + ' SAR';
        }
        
        function confirmCustomPackage() {
            const length = parseFloat(document.getElementById('customLength').value) || 0;
            const width = parseFloat(document.getElementById('customWidth').value) || 0;
            const height = parseFloat(document.getElementById('customHeight').value) || 0;
            
            if (!length || !width || !height) {
                alert('Please enter all dimensions (Length, Width, and Height)');
                return;
            }
            
            const dimensions = `${length} x ${width} x ${height} cm`;
            const price = ((length * width * height) / 10).toFixed(2);
            
            console.log('[confirmCustomPackage] Custom package confirmed:', { dimensions, price });
            
            // Store custom package info
            flowState.package = 'Custom Package';
            flowState.variant = 'Custom';
            flowState.packageSpecs = flowState.packageSpecs || {};
            flowState.packageSpecs.dimensions = dimensions;
            flowState.packageSpecs.custom_price = price;
            
            // Close modal
            closeCustomPackageModal();
            
            // Move to fulfillment specs (skip package specs for custom)
            sendSelection(`custom package: ${dimensions}`, { 
                type: 'custom_package', 
                questionId: 'package_selection',
                answer: 'custom',
                dimensions: dimensions,
                price: price
            });
        }
        
        function renderProductSelection(matches, matchSource = 'unknown') {
            // Note: This function is called from within collapsible sections, so don't add step-body wrapper
            // matchSource indicates which list these matches come from ('productMatches' or 'queryMatches')
            let html = '<div class="options-grid">';
            matches.forEach((match, index) => {
                const imageHtml = match.imageUrl 
                    ? `<img src="${match.imageUrl}" alt="${match.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">`
                    : '<div style="width: 100%; height: 150px; background: #f0f0f0; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: #999;">No Image</div>';
                
                const priceHtml = match.price 
                    ? `<div style="font-size: 16px; font-weight: 700; color: #FFC107; margin-top: 8px;">${parseFloat(match.price).toFixed(2)} SAR</div>`
                    : '';
                
                // Use the matchSource passed in, or try to detect it
                let actualMatchSource = matchSource;
                if (matchSource === 'unknown') {
                    // Fallback detection: check which array contains this match by comparing IDs
                    if (flowState.productMatches && flowState.productMatches.some(m => m.id === match.id && m.packageId === match.packageId)) {
                        actualMatchSource = 'productMatches';
                    } else if (flowState.queryMatches && flowState.queryMatches.some(m => m.id === match.id && m.packageId === match.packageId)) {
                        actualMatchSource = 'queryMatches';
                    }
                }
                
                html += `
                    <div class="option-card" onclick="selectProduct(${index}, '${match.name.replace(/'/g, "\\'")}', '${actualMatchSource}')">
                        ${imageHtml}
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">${match.name}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${match.reason}</div>
                        ${priceHtml}
                    </div>
                `;
            });
            html += `
                <div class="option-card" onclick="showCustomPackageForm()" style="border: 2px dashed #FFC107;">
                    <div style="width: 100%; height: 150px; background: #FFF9E6; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                        <div style="font-size: 12px; color: #FFC107; font-weight: 600;">Custom Package</div>
                    </div>
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">Custom Package</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Enter dimensions to calculate price</div>
                    <div id="customPackagePrice" style="font-size: 16px; color: #FFC107; font-weight: 700; margin-top: 8px; display: none;">Price: <span id="calculatedPrice">0</span> SAR</div>
                </div>
            `;
            
            // Custom package modal will be added to body, not here
            html += '</div>';
            return html;
        }
        
        // renderVariantSelection() removed - variants are handled via backend response
        // Variant selection is now integrated into package selection step
        
        function getQuestionLabel(questionId) {
            const labels = {
                // Product Details
                'product_description': 'Product Description',
                'product_dimensions': 'Product Dimensions',
                'product_weight': 'Product Weight',
                'fragility': 'Fragility',
                'budget': 'Budget',
                // Package Specs
                'material': 'Material',
                'dimensions': 'Package Dimensions',
                'print': 'Printing/Finish',
                // Fulfillment Specs
                'quantity': 'Quantity',
                'timeline': 'Timeline',
                'shipping_address': 'Shipping Address',
                'special_instructions': 'Special Instructions',
                // Launch Kit
                'service_selection': 'Services',
                'service_timeline': 'Service Timeline',
                'service_notes': 'Service Notes',
                // Custom Package
                'custom_package': 'Custom Package'
            };
            return labels[questionId] || questionId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function renderQuestion(question) {
            let html = '<div class="step-body"><div class="question-text">' + question.question + '</div>';
            
            if (question.options && question.options.length > 0) {
                const isMultiple = question.multiple !== false; // Default to true (checkboxes) unless explicitly false
                const isGrouped = question.multiple === "grouped";
                
                if (isGrouped && Array.isArray(question.options) && question.options.length > 0 && Array.isArray(question.options[0])) {
                    // Grouped mode: first group is radio buttons, rest are checkboxes
                    html += '<div id="option-group-' + question.id + '">';
                    
                    // First group: mutually exclusive (radio buttons)
                    if (question.options[0] && question.options[0].length > 0) {
                        html += '<div style="margin-bottom: 20px;"><div style="font-weight: 600; margin-bottom: 12px; color: #666;">Printing Type (choose one):</div>';
                        html += '<div class="radio-group" id="radio-group-' + question.id + '">';
                        question.options[0].forEach((option, index) => {
                            html += `
                                <label class="radio-label">
                                    <input type="radio" name="radio-${question.id}" value="${String(option).replace(/"/g, '&quot;')}" 
                                           id="radio-${question.id}-${index}">
                                    <span>${option}</span>
                                </label>
                            `;
                        });
                        html += '</div></div>';
                    }
                    
                    // Second group: combinable options (checkboxes)
                    if (question.options[1] && question.options[1].length > 0) {
                        // Further split: lamination is mutually exclusive, others can combine
                        const laminationOptions = [];
                        const otherOptions = [];
                        question.options[1].forEach(opt => {
                            if (opt.includes('lamination')) {
                                laminationOptions.push(opt);
                            } else {
                                otherOptions.push(opt);
                            }
                        });
                        
                        // Lamination options as radio (mutually exclusive)
                        if (laminationOptions.length > 0) {
                            html += '<div style="margin-bottom: 20px;"><div style="font-weight: 600; margin-bottom: 12px; color: #666;">Lamination (choose one):</div>';
                            html += '<div class="radio-group" id="lamination-radio-' + question.id + '">';
                            laminationOptions.forEach((option, index) => {
                                html += `
                                    <label class="radio-label">
                                        <input type="radio" name="lamination-radio-${question.id}" value="${String(option).replace(/"/g, '&quot;')}" 
                                               id="lamination-${question.id}-${index}">
                                        <span>${option}</span>
                                    </label>
                                `;
                            });
                            html += '</div></div>';
                        }
                        
                        // Other options as checkboxes (can combine)
                        if (otherOptions.length > 0) {
                            html += '<div style="margin-bottom: 20px;"><div style="font-weight: 600; margin-bottom: 12px; color: #666;">Additional Finishing (select all that apply):</div>';
                            html += '<div class="checkbox-group" id="checkbox-group-' + question.id + '">';
                            otherOptions.forEach((option, index) => {
                                html += `
                                    <label class="checkbox-label">
                                        <input type="checkbox" value="${String(option).replace(/"/g, '&quot;')}" 
                                               id="checkbox-${question.id}-${index}">
                                        <span>${option}</span>
                                    </label>
                                `;
                            });
                            html += '</div></div>';
                        }
                    }
                    
                    html += '</div>';
                    
                    // Additional notes field
                    html += `
                        <div class="input-group" style="margin-top: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #666;">Additional notes (optional):</label>
                            <input type="text" id="notes-${question.id}" placeholder="Any additional details or custom requirements...">
                        </div>
                        <button class="submit-btn" onclick="submitGroupedAnswer('${question.id}')">Submit</button>
                    `;
                } else if (isMultiple) {
                    // Render as checkboxes with notes field (for multiple selections)
                    html += '<div class="checkbox-group" id="option-group-' + question.id + '">';
                    question.options.forEach((option, index) => {
                        html += `
                            <label class="checkbox-label">
                                <input type="checkbox" value="${String(option).replace(/"/g, '&quot;')}" 
                                       id="option-${question.id}-${index}">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                    html += '</div>';
                    
                    // Additional notes field
                    html += `
                        <div class="input-group" style="margin-top: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #666;">Additional notes (optional):</label>
                            <input type="text" id="notes-${question.id}" placeholder="Any additional details or custom requirements...">
                        </div>
                        <button class="submit-btn" onclick="submitCheckboxAnswer('${question.id}')">Submit</button>
                    `;
                } else {
                    // Render as radio buttons (single selection)
                    html += '<div class="radio-group" id="option-group-' + question.id + '">';
                    question.options.forEach((option, index) => {
                        html += `
                            <label class="radio-label">
                                <input type="radio" name="radio-${question.id}" value="${String(option).replace(/"/g, '&quot;')}" 
                                       id="option-${question.id}-${index}">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                    html += '</div>';
                    
                    // Additional notes field
                    html += `
                        <div class="input-group" style="margin-top: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #666;">Additional notes (optional):</label>
                            <input type="text" id="notes-${question.id}" placeholder="Any additional details or custom requirements...">
                        </div>
                        <button class="submit-btn" onclick="submitRadioAnswer('${question.id}')">Submit</button>
                    `;
                }
            } else {
                // Render as input field(s)
                if (question.id === 'dimensions' || question.id === 'product_dimensions') {
                    // Special handling for dimensions - 3 separate inputs
                    html += `
                        <div class="dimensions-row">
                            <div class="input-group">
                                <label>Length</label>
                                <input type="text" id="dim_length" placeholder="e.g., 20 cm">
                            </div>
                            <div class="input-group">
                                <label>Width</label>
                                <input type="text" id="dim_width" placeholder="e.g., 15 cm">
                            </div>
                            <div class="input-group">
                                <label>Height</label>
                                <input type="text" id="dim_height" placeholder="e.g., 10 cm">
                            </div>
                        </div>
                        <button class="submit-btn" onclick="submitDimensions('${question.id}')">Submit</button>
                    `;
                } else if (question.id === 'quantity') {
                    // Number input for quantity
                    html += `
                        <div class="input-group">
                            <input type="number" id="questionInput" value="${question.defaultValue || '1'}" min="1" placeholder="Enter quantity">
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                } else if (question.id === 'shipping_address') {
                    // Special handling for shipping address with Google Maps autocomplete
                    html += `
                        <div class="input-group">
                            <input type="text" id="questionInput" data-question-id="shipping_address" value="${question.defaultValue || ''}" placeholder="Start typing your address in Saudi Arabia..." autocomplete="off">
                            <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">üìç Address autocomplete enabled for Saudi Arabia</small>
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                } else {
                    // Regular text input
                    html += `
                        <div class="input-group">
                            <input type="text" id="questionInput" value="${question.defaultValue || ''}" placeholder="Enter your answer...">
                        </div>
                        <button class="submit-btn" onclick="submitAnswer('${question.id}')">Submit</button>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function renderDraftOrder(draftOrder) {
            return `
                <div class="draft-order-success">
                    <h2>‚úÖ Draft Order Created!</h2>
                    <div class="draft-order-links">
                        ${draftOrder.adminUrl ? `<a href="${draftOrder.adminUrl}" target="_blank">üìã View Draft Order</a>` : ''}
                        ${draftOrder.invoiceUrl ? `<a href="${draftOrder.invoiceUrl}" target="_blank">üí≥ View Invoice & Pay</a>` : ''}
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <p style="color: #666; margin-bottom: 12px; font-size: 14px;">
                            Made changes to your answers? Regenerate the draft order with your updated information.
                        </p>
                        <button class="submit-btn" onclick="regenerateDraftOrder()" style="background: #FFC107; color: #000;">
                            üîÑ Regenerate Draft Order
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function regenerateDraftOrder() {
            if (!confirm('Are you sure you want to regenerate the draft order? This will create a new draft order with your current answers.')) {
                return;
            }
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                alert('Please enter a Worker URL');
                return;
            }
            
            try {
                showLoadingIndicator('order');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: 'regenerate_order',
                        regenerateOrder: true,
                        flow: currentFlow 
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[regenerateDraftOrder] Response error:', errorText);
                    alert('Error regenerating draft order. Please try again.');
                    hideLoadingIndicator();
                    return;
                }
                
                const data = await response.json();
                console.log('[regenerateDraftOrder] Response:', data);
                
                // Update draft order in state
                if (data.draftOrder) {
                    flowState.draftOrder = data.draftOrder;
                }
                
                // Process the response
                handleResponse(data, { type: 'regenerate_order' });
            } catch (error) {
                console.error('[regenerateDraftOrder] Error:', error);
                alert('Error regenerating draft order. Please try again.');
                hideLoadingIndicator();
            }
        }
        
        function searchProducts() {
            const input = document.getElementById('productSearchInput');
            if (input && input.value.trim()) {
                const query = input.value.trim();
                console.log('[searchProducts] User search query:', query);
                // Mark as user search (not auto-search) - explicitly set isAutoSearch to false
                sendSelection(query, { type: 'product_search', originalQuery: query, message: query, isAutoSearch: false });
            } else {
                // If empty, don't search - just show existing matches
                console.log('[searchProducts] Empty query - not searching');
            }
        }
        
        function selectProduct(index, name, matchSource = 'unknown') {
            // Determine which match list this came from
            let selectedMatch = null;
            if (matchSource === 'productMatches' && flowState.productMatches && flowState.productMatches[index]) {
                selectedMatch = flowState.productMatches[index];
            } else if (matchSource === 'queryMatches' && flowState.queryMatches && flowState.queryMatches[index]) {
                selectedMatch = flowState.queryMatches[index];
            } else {
                // Fallback: try to find in either list
                if (flowState.productMatches && flowState.productMatches[index]) {
                    selectedMatch = flowState.productMatches[index];
                } else if (flowState.queryMatches && flowState.queryMatches[index]) {
                    selectedMatch = flowState.queryMatches[index];
                }
            }
            
            if (!selectedMatch) {
                console.error('[selectProduct] Could not find selected match!', { index, matchSource, productMatches: flowState.productMatches?.length, queryMatches: flowState.queryMatches?.length });
                return;
            }
            
            // Store package image URL from the match before sending
            if (selectedMatch.imageUrl) {
                flowState.packageImageUrl = selectedMatch.imageUrl;
                console.log('[selectProduct] Stored package image URL:', flowState.packageImageUrl);
            }
            
            // Send the actual packageId instead of index to avoid confusion with multiple match lists
            // Backend will use packageId to find the product directly
            const packageId = selectedMatch.packageId || selectedMatch.id;
            console.log('[selectProduct] Selecting product:', { name, packageId, matchSource, index });
            
            // Send packageId as the selection (backend will handle it)
            sendSelection(String(packageId), { 
                type: 'product', 
                name, 
                matchSource,
                packageId: packageId,
                selectedIndex: index
            });
        }
        
        function selectVariant(index, title, id) {
            sendSelection(title, { type: 'variant', title, id });
        }
        
        // selectOption() removed - not used, options are handled via submit functions
        
        function submitCheckboxAnswer(questionId) {
            const checkboxes = document.querySelectorAll(`#option-group-${questionId} input[type="checkbox"]:checked`);
            const notesInput = document.getElementById(`notes-${questionId}`);
            const notes = notesInput ? notesInput.value.trim() : '';
            
            const selectedOptions = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedOptions.length === 0 && !notes) {
                alert('Please select at least one option or add notes.');
                return;
            }
            
            let answer = selectedOptions.join(', ');
            if (notes) {
                answer += (answer ? ' | Notes: ' : 'Notes: ') + notes;
            }
            
            sendSelection(answer, { type: 'answer', questionId, answer: answer });
        }
        
        function submitRadioAnswer(questionId) {
            const radio = document.querySelector(`#option-group-${questionId} input[type="radio"]:checked`);
            const notesInput = document.getElementById(`notes-${questionId}`);
            const notes = notesInput ? notesInput.value.trim() : '';
            
            if (!radio && !notes) {
                alert('Please select an option or add notes.');
                return;
            }
            
            let answer = radio ? radio.value : '';
            if (notes) {
                answer += (answer ? ' | Notes: ' : 'Notes: ') + notes;
            }
            
            sendSelection(answer, { type: 'answer', questionId, answer: answer });
        }
        
        function submitGroupedAnswer(questionId) {
            // Get printing type (radio)
            const printingRadio = document.querySelector(`#radio-group-${questionId} input[type="radio"]:checked`);
            // Get lamination (radio)
            const laminationRadio = document.querySelector(`#lamination-radio-${questionId} input[type="radio"]:checked`);
            // Get additional finishing (checkboxes)
            const checkboxes = document.querySelectorAll(`#checkbox-group-${questionId} input[type="checkbox"]:checked`);
            const notesInput = document.getElementById(`notes-${questionId}`);
            const notes = notesInput ? notesInput.value.trim() : '';
            
            const selectedOptions = [];
            if (printingRadio) selectedOptions.push(printingRadio.value);
            if (laminationRadio) selectedOptions.push(laminationRadio.value);
            Array.from(checkboxes).forEach(cb => selectedOptions.push(cb.value));
            
            if (selectedOptions.length === 0 && !notes) {
                alert('Please select at least one option or add notes.');
                return;
            }
            
            let answer = selectedOptions.join(', ');
            if (notes) {
                answer += (answer ? ' | Notes: ' : 'Notes: ') + notes;
            }
            
            sendSelection(answer, { type: 'answer', questionId, answer: answer });
        }
        
        function submitAnswer(questionId) {
            const input = document.getElementById('questionInput');
            if (input && input.value.trim()) {
                const answer = input.value.trim();
                sendSelection(answer, { type: 'answer', questionId, answer: answer });
            }
        }
        
        function submitDimensions(questionId) {
            const length = document.getElementById('dim_length')?.value.trim() || '';
            const width = document.getElementById('dim_width')?.value.trim() || '';
            const height = document.getElementById('dim_height')?.value.trim() || '';
            
            if (!length || !width || !height) {
                alert('Please fill in all dimension fields (Length, Width, and Height)');
                return;
            }
            
            const dimensions = `${length} x ${width} x ${height}`;
            sendSelection(dimensions, { type: 'answer', questionId, answer: dimensions });
        }
        
        // Auto-focus input when step becomes active
        function autoFocusInput(stepId) {
            setTimeout(() => {
                if (stepId === 'package_selection') {
                    const input = document.getElementById('productSearchInput');
                    if (input) input.focus();
                } else {
                    const input = document.getElementById('questionInput');
                    if (input) {
                        input.focus();
                        
                        // Initialize Google Maps autocomplete for shipping address
                        if (input.getAttribute('data-question-id') === 'shipping_address') {
                            // Delay to ensure input is fully rendered
                            setTimeout(() => {
                                initializeAddressAutocomplete(input);
                            }, 200);
                        }
                    }
                }
            }, 100);
        }
        
        // Initialize Google Maps autocomplete for address input
        // Handles API errors gracefully and allows manual input as fallback
        function initializeAddressAutocomplete(input) {
            if (!input) {
                console.warn('[initializeAddressAutocomplete] Input element not found');
                return;
            }
            
            // Check if already initialized (avoid duplicate initialization)
            if (input.dataset.autocompleteInitialized === 'true') {
                console.log('[initializeAddressAutocomplete] Already initialized, skipping');
                return;
            }
            
            let retryCount = 0;
            const maxRetries = 10; // Try for 5 seconds (10 * 500ms)
            
            // Wait for Google Maps API to load
            const initAutocomplete = () => {
                retryCount++;
                
                // Check if Google Maps is loaded
                if (typeof google === 'undefined' || !google.maps) {
                    if (retryCount < maxRetries) {
                        setTimeout(initAutocomplete, 500);
                        return;
                    } else {
                        console.warn('[initializeAddressAutocomplete] Google Maps API failed to load after retries');
                        showAutocompleteError(input, 'Google Maps API failed to load. Please enter your address manually.');
                        return;
                    }
                }
                
                // Check if Places API is available
                if (!google.maps.places) {
                    console.error('[initializeAddressAutocomplete] Places API library not loaded');
                    showAutocompleteError(input, 'Places API not available. Please enter your address manually.');
                    return;
                }
                
                try {
                    // Try to use the legacy Autocomplete API
                    // Note: This requires "Places API" (not "Places API (New)") to be enabled in Google Cloud Console
                    const autocomplete = new google.maps.places.Autocomplete(input, {
                        componentRestrictions: { country: ['sa'] }, // Restrict to Saudi Arabia
                        fields: ['formatted_address', 'geometry', 'address_components'],
                        types: ['address']
                    });
                    
                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                        if (place && place.formatted_address) {
                            input.value = place.formatted_address;
                            console.log('[initializeAddressAutocomplete] Address selected:', place.formatted_address);
                            
                            // Remove any error messages
                            const errorMsg = input.parentNode.querySelector('.autocomplete-error');
                            if (errorMsg) errorMsg.remove();
                        }
                    });
                    
                    // Mark as initialized
                    input.dataset.autocompleteInitialized = 'true';
                    console.log('[initializeAddressAutocomplete] Autocomplete initialized successfully');
                    
                    // Update the help text to indicate it's working
                    const helpText = input.parentNode.querySelector('small');
                    if (helpText) {
                        helpText.textContent = 'üìç Address autocomplete is active. Start typing your address in Saudi Arabia...';
                        helpText.style.color = '#28a745';
                    }
                    
                } catch (error) {
                    console.error('[initializeAddressAutocomplete] Error initializing autocomplete:', error);
                    
                    // Check if it's an API not enabled error
                    if (error.message && error.message.includes('not enabled')) {
                        showAutocompleteError(input, '‚ö†Ô∏è Places API is not enabled for this API key. Please enable "Places API" in Google Cloud Console, or enter your address manually.');
                    } else {
                        showAutocompleteError(input, '‚ö†Ô∏è Address autocomplete unavailable. Please enter your address manually.');
                    }
                }
            };
            
            // Start initialization
            initAutocomplete();
        }
        
        // Helper function to show autocomplete error message
        function showAutocompleteError(input, message) {
            // Remove any existing error messages
            const existingError = input.parentNode.querySelector('.autocomplete-error');
            if (existingError) existingError.remove();
            
            // Create error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'autocomplete-error';
            errorMsg.style.cssText = 'margin-top: 8px; padding: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404; font-size: 12px;';
            errorMsg.textContent = message;
            input.parentNode.appendChild(errorMsg);
            
            // Update help text
            const helpText = input.parentNode.querySelector('small');
            if (helpText) {
                helpText.textContent = 'üìç Please enter your address manually';
                helpText.style.color = '#856404';
            }
        }
        
        async function sendSelection(message, metadata) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                console.error('[sendSelection] No API URL provided');
                return;
            }
            
            // Prevent multiple simultaneous requests
            if (isLoading) {
                console.log('[sendSelection] Already loading, ignoring request');
                return;
            }
            
            isLoading = true;
            updateLoadingState(true, metadata);
            
            // Ensure metadata includes the message for answer extraction
            if (metadata && !metadata.message) {
                metadata.message = message;
            }
            
            console.log('[sendSelection] Sending request:', { message, metadata, flow: currentFlow });
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, flow: currentFlow })
                });
                
                console.log('[sendSelection] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[sendSelection] Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('[sendSelection] Response data:', data);
                console.log('[sendSelection] Backend step:', data.flowState?.step);
                console.log('[sendSelection] Has currentQuestion:', !!data.currentQuestion);
                console.log('[sendSelection] CurrentQuestion ID:', data.currentQuestion?.id);
                
                handleResponse(data, metadata);
            } catch (error) {
                console.error('[sendSelection] Error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                isLoading = false;
                updateLoadingState(false);
            }
        }
        
        function updateLoadingState(loading, metadata) {
            isLoading = loading;
            
            // Disable/enable all submit buttons
            document.querySelectorAll('.submit-btn').forEach(btn => {
                btn.disabled = loading;
                if (loading) {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            
            // Show/hide loading indicator in the active step
            if (loading) {
                showLoadingIndicator(metadata);
            } else {
                hideLoadingIndicator();
            }
        }
        
        function showLoadingIndicator(metadata) {
            // Determine which step is loading based on metadata
            let stepId = 'fulfillment_specs'; // default
            if (metadata) {
                if (metadata.type === 'product_search' || metadata.type === 'product') {
                    stepId = 'package_selection';
                } else if (metadata.type === 'variant') {
                    stepId = 'package_selection'; // variant is part of package selection step now
                } else if (metadata.type === 'answer' || metadata.type === 'option') {
                    // Default to fulfillment_specs, but this will be determined by backend step in handleResponse
                    stepId = 'fulfillment_specs';
                }
            }
            
            const stepEl = document.querySelector(`[data-step="${stepId}"]`);
            if (stepEl) {
                // Check if step content area exists
                const contentEl = stepEl.querySelector('.step-content');
                if (contentEl) {
                    // Add loading overlay
                    let loader = contentEl.querySelector('.loading-overlay');
                    if (!loader) {
                        loader = document.createElement('div');
                        loader.className = 'loading-overlay';
                        loader.innerHTML = `
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Processing...</div>
                        `;
                        contentEl.appendChild(loader);
                    }
                    loader.style.display = 'flex';
                }
            }
        }
        
        function hideLoadingIndicator() {
            document.querySelectorAll('.loading-overlay').forEach(overlay => {
                overlay.style.display = 'none';
            });
        }
        
        // Helper function to get the current consultation state property based on backend step
        function getCurrentConsultationState(backendStep) {
            const mapping = {
                'start': 'productDetails', // 'start' step should show product details questions
                'product_details': 'productDetails',
                'select_package_specs': 'packageSpecs',
                'fulfillment_specs': 'fulfillmentSpecs',
                'launch_kit': 'launchKit'
            };
            const result = mapping[backendStep] || 'productDetails'; // Default to productDetails for initial state
            console.log(`[getCurrentConsultationState] Backend step: ${backendStep} -> Consultation key: ${result}`);
            return result;
        }
        
        function handleResponse(data, metadata) {
            console.log('[handleResponse] ========== START ==========');
            console.log('[handleResponse] Metadata:', metadata);
            console.log('[handleResponse] Response data:', data);
            console.log('[handleResponse] Backend step:', data.flowState?.step);
            console.log('[handleResponse] Has package:', data.flowState?.hasPackage);
            console.log('[handleResponse] Has variant:', data.flowState?.hasVariant);
            console.log('[handleResponse] Current question:', data.currentQuestion);
            console.log('[handleResponse] Product matches:', data.productMatches?.length || 0);
            console.log('[handleResponse] Variants:', data.variants?.length || 0);
            console.log('[handleResponse] Draft order:', data.draftOrder);
            
            const backendStep = data.flowState?.step || '';
            // Store the message from metadata for answer extraction (fallback)
            const messageFromMetadata = metadata && metadata.message ? metadata.message : null;
            
            // Store backend step in flowState early so other logic can use it
            flowState.backendStep = backendStep;
            console.log('[handleResponse] Set backendStep to:', backendStep);
            
            // Note: Auto-search now happens synchronously in getNextStepPrompt
            // No need to trigger a second request
            
            // CRITICAL: Check for variant auto-skip FIRST (before any other logic)
            // If backend is in package specs (currentQuestion present) but no variant is selected,
            // it means variant step was auto-skipped (single variant or no variants)
            if (data.currentQuestion && !flowState.variant && flowState.package && backendStep === 'select_package_specs') {
                if (data.flowState && data.flowState.hasVariant && data.flowState.variantName) {
                    flowState.variant = data.flowState.variantName;
                } else {
                    flowState.variant = 'Default';
                }
                flowState.packageData = null; // Clear package data since we're auto-completing
            }
            
            // Handle package search - show matches
            // IMPORTANT: Don't return early - continue processing to update backend step
            // Check for product matches in response OR if this is a product_search request
            if (data.productMatches || (metadata && metadata.type === 'product_search')) {
                // Ensure search box is empty when rendering
                setTimeout(() => {
                    const searchInput = document.getElementById('productSearchInput');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }, 0);
                console.log('[handleResponse] Processing product_search response');
                console.log('[handleResponse] data.productMatches:', data.productMatches?.length || 0);
                console.log('[handleResponse] data.isAutoSearch:', data.isAutoSearch);
                console.log('[handleResponse] metadata.type:', metadata?.type);
                console.log('[handleResponse] metadata.originalQuery:', metadata?.originalQuery);
                console.log('[handleResponse] data.flowState.hasPackage:', data.flowState?.hasPackage);
                console.log('[handleResponse] backendStep:', backendStep);
                console.log('[handleResponse] data.currentQuestion:', data.currentQuestion);
                console.log('[handleResponse] flowState.packageSpecs BEFORE:', flowState.packageSpecs);
                
                // If this is an edit request, ensure we show the search UI even if no matches
                const isEditRequest = metadata && metadata.isEdit === true;
                // Determine if this is an auto-search or user search
                // Priority: backend's data.isAutoSearch > metadata.isAutoSearch
                // If backend says isAutoSearch === true, it's auto-search
                // If backend says isAutoSearch === false, it's user search
                // If backend doesn't set it, check metadata
                let isAutoSearch = false;
                if (data.isAutoSearch === true) {
                    isAutoSearch = true;
                } else if (data.isAutoSearch === false) {
                    isAutoSearch = false;
                } else if (metadata && metadata.isAutoSearch === true) {
                    isAutoSearch = true;
                } else if (metadata && metadata.isAutoSearch === false) {
                    isAutoSearch = false;
                }
                const userQuery = metadata && (metadata.originalQuery || metadata.message) || '';
                
                if (data.productMatches && data.productMatches.length > 0) {
                    console.log('[handleResponse] Showing product matches');
                    console.log('[handleResponse] data.isAutoSearch:', data.isAutoSearch, 'metadata.isAutoSearch:', metadata?.isAutoSearch);
                    console.log('[handleResponse] Determined isAutoSearch:', isAutoSearch, 'userQuery:', userQuery);
                    if (isAutoSearch) {
                        // Store as product matches (auto-generated from product details)
                        // Always update product matches when auto-search completes
                        flowState.productMatches = data.productMatches;
                        console.log('[handleResponse] Stored as productMatches (auto-search):', data.productMatches.length, 'matches');
                    } else {
                        // Store as query matches (user search) - always create/update query matches separately
                        // Use the actual user query from the input, not from metadata
                        const actualQuery = userQuery || (metadata && metadata.message) || '';
                        flowState.queryMatches = data.productMatches;
                        flowState.queryMatchesQuery = actualQuery;
                        console.log('[handleResponse] Stored as queryMatches (user search):', actualQuery, '-', data.productMatches.length, 'matches');
                        console.log('[handleResponse] Product matches still exist:', flowState.productMatches?.length || 0);
                    }
                    // Hide fallback message if matches found
                    const fallbackMsg = document.getElementById('searchFallbackMessage');
                    if (fallbackMsg) fallbackMsg.style.display = 'none';
                } else if (isEditRequest && backendStep === 'select_package_discovery') {
                    // For edit requests, ensure we show the search UI even if no matches yet
                    console.log('[handleResponse] Edit request - ensuring search UI is shown');
                    flowState.packageData = flowState.packageData || {};
                    flowState.packageData.matches = []; // Empty matches to trigger search UI
                } else if (data.flowState && data.flowState.hasPackage) {
                    console.log('[handleResponse] Package found directly, updating flowState');
                    // If no matches but we have a reply, the package was found directly
                    flowState.package = data.flowState.packageName;
                    flowState.packageData = null;
                    // Hide fallback message
                    const fallbackMsg = document.getElementById('searchFallbackMessage');
                    if (fallbackMsg) fallbackMsg.style.display = 'none';
                    
                    // Check if variant was auto-skipped immediately after package selection
                    if (data.currentQuestion && backendStep === 'select_package_specs') {
                        console.log('[handleResponse] Backend moved to select_package_specs, preserving packageSpecs');
                        flowState.variant = data.flowState?.variantName || 'Default';
                        flowState.packageData = null;
                        
                        // CRITICAL: Preserve existing packageSpecs - don't clear them
                        if (!flowState.packageSpecs) {
                            flowState.packageSpecs = {};
                        }
                        
                        // CRITICAL: Set packageSpecsData
                        if (!flowState.packageSpecsData) {
                            flowState.packageSpecsData = {};
                        }
                        flowState.packageSpecsData.currentQuestion = data.currentQuestion;
                        console.log('[handleResponse] flowState.packageSpecs AFTER:', flowState.packageSpecs);
                        console.log('[handleResponse] flowState.packageSpecsData AFTER:', flowState.packageSpecsData);
                    }
                } else {
                    console.log('[handleResponse] No matches found, showing fallback');
                    // No matches found - show fallback message
                    const fallbackMsg = document.getElementById('searchFallbackMessage');
                    if (fallbackMsg) {
                        fallbackMsg.style.display = 'block';
                    }
                }
            }
            
            // Handle edit requests - backend returns the question to edit
            if (metadata && metadata.type === 'edit') {
                console.log('[handleResponse] Handling edit response for question:', metadata.questionId);
                
                // Determine which consultation state this question belongs to
                let consultationKey = 'fulfillmentSpecs';
                let dataKey = 'fulfillmentSpecsData';
                let backendStepName = 'fulfillment_specs';
                
                if (metadata.stepId === 'product_details') {
                    consultationKey = 'productDetails';
                    dataKey = 'productDetailsData';
                    backendStepName = 'product_details';
                } else if (metadata.stepId === 'package_specs') {
                    consultationKey = 'packageSpecs';
                    dataKey = 'packageSpecsData';
                    backendStepName = 'select_package_specs';
                } else if (metadata.stepId === 'launch_kit') {
                    consultationKey = 'launchKit';
                    dataKey = 'launchKitData';
                    backendStepName = 'launch_kit';
                }
                
                // CRITICAL: Initialize all data structures if they don't exist
                if (!flowState[consultationKey]) {
                    flowState[consultationKey] = {};
                }
                if (!flowState[dataKey]) {
                    flowState[dataKey] = {};
                }
                
                // CRITICAL: Update backend step FIRST to ensure step activation
                flowState.backendStep = backendStepName;
                
                // CRITICAL: Only remove the specific answer being edited AFTER backend confirms
                // The backend has already deleted it from memory, so we should remove it from frontend state
                // BUT: Only if we have a currentQuestion (meaning backend successfully processed the edit)
                if (data.currentQuestion) {
                    // Backend successfully processed edit - remove the answer from frontend state
                    if (flowState[consultationKey][metadata.questionId]) {
                        delete flowState[consultationKey][metadata.questionId];
                        console.log(`[handleResponse] Removed answer for ${metadata.questionId} from frontend state`);
                    }
                    
                    // Set the current question data
                    flowState[dataKey].currentQuestion = data.currentQuestion;
                    console.log(`[handleResponse] Set currentQuestion for edit: ${data.currentQuestion.id}`);
                } else {
                    // Backend didn't return currentQuestion - this is an error
                    console.error('[handleResponse] Edit request failed - no currentQuestion in response');
                    console.error('[handleResponse] Backend step:', backendStep);
                    console.error('[handleResponse] Reply:', data.reply);
                    
                    // Try to restore the step data structure
                    if (!flowState[dataKey].currentQuestion) {
                        // If we don't have a currentQuestion, show error but keep the step active
                        flowState[dataKey].currentQuestion = null;
                    }
                }
                
                console.log('[handleResponse] Edit response processed, step activated:', backendStepName);
            }
            
            // Handle custom package selection
            if (metadata && metadata.type === 'custom_package') {
                console.log('[handleResponse] Custom package selected');
                flowState.package = 'Custom Package';
                flowState.variant = 'Custom';
                flowState.packageData = null;
                
                // Store custom package dimensions and price
                if (metadata.dimensions) {
                    flowState.packageSpecs = flowState.packageSpecs || {};
                    flowState.packageSpecs.dimensions = metadata.dimensions;
                }
                if (metadata.price) {
                    flowState.packageSpecs = flowState.packageSpecs || {};
                    flowState.packageSpecs.custom_price = metadata.price;
                }
                
                // Custom package skips to fulfillment_specs
                if (backendStep === 'fulfillment_specs' && data.currentQuestion) {
                    if (!flowState.fulfillmentSpecsData) {
                        flowState.fulfillmentSpecsData = {};
                    }
                    flowState.fulfillmentSpecsData.currentQuestion = data.currentQuestion;
                }
            }
            
            // Update flow state based on metadata and response
            if (metadata && metadata.type === 'product' && data.flowState && data.flowState.hasPackage) {
                console.log('[handleResponse] Processing product selection');
                console.log('[handleResponse] Before update - flowState.packageSpecs:', flowState.packageSpecs);
                console.log('[handleResponse] Before update - flowState.packageSpecsData:', flowState.packageSpecsData);
                console.log('[handleResponse] Backend step:', backendStep);
                console.log('[handleResponse] Has package:', data.flowState.hasPackage);
                console.log('[handleResponse] Package name:', data.flowState.packageName);
                
                flowState.package = data.flowState.packageName || metadata.name;
                // Store package image URL if available from productMatches
                if (data.productMatches && data.productMatches.length > 0) {
                    const selectedMatch = data.productMatches.find(m => m.name === flowState.package) || data.productMatches[0];
                    if (selectedMatch && selectedMatch.imageUrl) {
                        flowState.packageImageUrl = selectedMatch.imageUrl;
                        console.log('[handleResponse] Stored package image URL:', flowState.packageImageUrl);
                    }
                } else if (flowState.packageData && flowState.packageData.matches) {
                    // Try to find image from existing matches
                    const selectedMatch = flowState.packageData.matches.find(m => m.name === flowState.package);
                    if (selectedMatch && selectedMatch.imageUrl) {
                        flowState.packageImageUrl = selectedMatch.imageUrl;
                        console.log('[handleResponse] Stored package image URL from existing matches:', flowState.packageImageUrl);
                    }
                }
                flowState.packageData = null;
                
                // CRITICAL: When product is selected and backend moved to select_package_specs, 
                // we need to clear package selection and set packageSpecsData
                // IMPORTANT: Preserve existing packageSpecs when selecting a new package
                if (backendStep === 'select_package_specs') {
                    console.log('[handleResponse] Backend moved to select_package_specs - preserving packageSpecs');
                    flowState.variant = data.flowState?.variantName || 'Default';
                    flowState.packageData = null;
                    
                    // CRITICAL: Preserve existing packageSpecs - don't clear them when selecting new package
                    // Only initialize if it doesn't exist
                    if (!flowState.packageSpecs) {
                        console.log('[handleResponse] Initializing new packageSpecs object');
                        flowState.packageSpecs = {};
                    } else {
                        console.log('[handleResponse] Preserving existing packageSpecs:', flowState.packageSpecs);
                    }
                    
                    // Set packageSpecsData with currentQuestion
                    if (!flowState.packageSpecsData) {
                        console.log('[handleResponse] Initializing new packageSpecsData object');
                        flowState.packageSpecsData = {};
                    } else {
                        console.log('[handleResponse] Preserving existing packageSpecsData:', flowState.packageSpecsData);
                    }
                    if (data.currentQuestion) {
                        flowState.packageSpecsData.currentQuestion = data.currentQuestion;
                        console.log('[handleResponse] Set currentQuestion:', data.currentQuestion.id);
                    }
                    
                    console.log('[handleResponse] After update - flowState.packageSpecs:', flowState.packageSpecs);
                    console.log('[handleResponse] After update - flowState.packageSpecsData:', flowState.packageSpecsData);
                } else if (data.flowState.hasVariant && data.flowState.variantName) {
                    flowState.variant = data.flowState.variantName;
                    flowState.packageData = null;
                }
            }
            
            if (metadata && metadata.type === 'variant' && data.flowState && data.flowState.hasVariant) {
                flowState.variant = data.flowState.variantName || metadata.title;
                flowState.packageData = null;
            }
            
            // Check if this response indicates an edit was completed (backend returns success message)
            const isEditComplete = data.reply && (
                data.reply.includes('Answer updated') || 
                data.reply.includes('‚úì Answer updated')
            );
            
            if (isEditComplete && metadata && metadata.questionId) {
                console.log('[handleResponse] Edit answer completed for question:', metadata.questionId);
                
                // Update the answer in frontend state (backend already updated it in memory)
                let consultationKey = 'fulfillmentSpecs';
                let dataKey = 'fulfillmentSpecsData';
                
                if (metadata.questionId && (
                    metadata.questionId === 'product_description' ||
                    metadata.questionId === 'product_dimensions' ||
                    metadata.questionId === 'product_weight' ||
                    metadata.questionId === 'fragility' ||
                    metadata.questionId === 'budget'
                )) {
                    consultationKey = 'productDetails';
                    dataKey = 'productDetailsData';
                } else if (metadata.questionId && (
                    metadata.questionId === 'material' ||
                    metadata.questionId === 'dimensions' ||
                    metadata.questionId === 'print'
                )) {
                    consultationKey = 'packageSpecs';
                    dataKey = 'packageSpecsData';
                } else if (metadata.questionId && (
                    metadata.questionId === 'service_selection' ||
                    metadata.questionId === 'service_timeline' ||
                    metadata.questionId === 'service_notes'
                )) {
                    consultationKey = 'launchKit';
                    dataKey = 'launchKitData';
                }
                
                // Update answer in frontend state
                if (!flowState[consultationKey]) {
                    flowState[consultationKey] = {};
                }
                const answerValue = metadata.answer || metadata.message || messageFromMetadata;
                if (answerValue && answerValue !== 'undefined' && answerValue !== 'null' && answerValue.trim() !== '') {
                    flowState[consultationKey][metadata.questionId] = answerValue;
                    console.log(`[handleResponse] Updated answer in frontend: ${consultationKey}[${metadata.questionId}] = ${answerValue}`);
                }
                
                // Clear currentQuestion for the edited step (so edit form disappears)
                if (flowState[dataKey]) {
                    flowState[dataKey].currentQuestion = null;
                }
                
                // Restore backend step from response
                if (data.flowState && data.flowState.step) {
                    flowState.backendStep = data.flowState.step;
                    console.log('[handleResponse] Restored backendStep to:', data.flowState.step);
                }
                
                // Mark that we've processed this as an edit, so we don't process it again as a regular answer
                // Continue processing to handle currentQuestion if present
                console.log('[handleResponse] Edit completed, continuing to process currentQuestion if present');
            }
            
            // Store answers in the appropriate consultation state based on questionId
            // We can't rely on backendStep because it may have changed after processing the answer
            // Skip if this was already processed as an edit
            if (metadata && (metadata.type === 'answer' || metadata.type === 'option') && !isEditComplete) {
                console.log('[handleResponse] Processing answer/option:', metadata.questionId);
                // Determine which consultation phase this question belongs to based on questionId
                let consultationKey = 'fulfillmentSpecs'; // default
                if (metadata.questionId && (
                    metadata.questionId === 'product_description' ||
                    metadata.questionId === 'product_dimensions' ||
                    metadata.questionId === 'product_weight' ||
                    metadata.questionId === 'fragility' ||
                    metadata.questionId === 'budget'
                )) {
                    consultationKey = 'productDetails';
                } else if (metadata.questionId && (
                    metadata.questionId === 'material' ||
                    metadata.questionId === 'dimensions' ||
                    metadata.questionId === 'print'
                )) {
                    consultationKey = 'packageSpecs';
                } else if (metadata.questionId && (
                    metadata.questionId === 'service_selection' ||
                    metadata.questionId === 'service_timeline' ||
                    metadata.questionId === 'service_notes'
                )) {
                    consultationKey = 'launchKit';
                }
                
                console.log('[handleResponse] Determined consultation key:', consultationKey, 'for question:', metadata.questionId);
                
                if (!flowState[consultationKey]) flowState[consultationKey] = {};
                // Get answer value - prioritize metadata.answer, then metadata.option, then metadata.message
                const answerValue = metadata.answer || metadata.option || metadata.message || messageFromMetadata;
                if (answerValue && answerValue !== 'undefined' && answerValue !== 'null' && answerValue.trim() !== '') {
                    flowState[consultationKey][metadata.questionId] = answerValue;
                    console.log(`[handleResponse] Stored answer: ${consultationKey}[${metadata.questionId}] = ${answerValue}`);
                } else {
                    console.warn(`[handleResponse] Could not extract answer value for ${metadata.questionId}`);
                }
            }
            
            // Update step data - handle productMatches and variants
            // NOTE: This should happen AFTER product_search handler, but we check here too for safety
            if (data.productMatches) {
                flowState.packageData = flowState.packageData || {};
                flowState.packageData.matches = data.productMatches;
            }
            if (data.variants) {
                flowState.packageData = flowState.packageData || {};
                flowState.packageData.variants = data.variants;
            }
            // Handle step transitions - clear old consultation currentQuestion when moving to a new step
            // BUT DO NOT clear the answers - they should persist for display in completed view
            if (backendStep === 'select_package' || backendStep === 'select_package_discovery') {
                // Moving to package selection - clear product details currentQuestion only
                if (flowState.productDetailsData) {
                    flowState.productDetailsData.currentQuestion = null;
                }
                // DO NOT clear flowState.productDetails - answers should persist
            } else if (backendStep === 'select_package_specs') {
                // Moving to package specs - clear package selection data if needed
                // (package selection doesn't have consultation data, so nothing to clear)
            } else if (backendStep === 'fulfillment_specs') {
                // Moving to fulfillment specs - clear package specs question only
                if (flowState.packageSpecsData) {
                    flowState.packageSpecsData.currentQuestion = null;
                }
                // DO NOT clear flowState.packageSpecs - answers should persist
            } else if (backendStep === 'launch_kit') {
                // Moving to launch kit - clear fulfillment specs question only
                if (flowState.fulfillmentSpecsData) {
                    flowState.fulfillmentSpecsData.currentQuestion = null;
                }
                // DO NOT clear flowState.fulfillmentSpecs - answers should persist
            }
            
            if (data.currentQuestion) {
                console.log('[handleResponse] Processing currentQuestion:', data.currentQuestion.id);
                const consultationKey = getCurrentConsultationState(backendStep);
                const dataKey = consultationKey + 'Data';
                console.log('[handleResponse] Consultation key:', consultationKey, 'Data key:', dataKey);
                
                if (!flowState[dataKey]) {
                    flowState[dataKey] = {};
                    console.log('[handleResponse] Created new', dataKey);
                }
                flowState[dataKey].currentQuestion = data.currentQuestion;
                console.log('[handleResponse] Set currentQuestion in', dataKey, ':', data.currentQuestion.id);
                
                // CRITICAL: If we just moved to select_package_specs after product selection,
                // ensure packageData is cleared so we don't show product selection UI
                if (backendStep === 'select_package_specs' && metadata && metadata.type === 'product') {
                    flowState.packageData = null;
                }
            } else {
                console.warn('[handleResponse] NO currentQuestion in response!');
                console.warn('[handleResponse] Backend step:', backendStep);
                console.warn('[handleResponse] Reply:', data.reply);
                console.warn('[handleResponse] This might indicate an issue with the backend response');
                
                // Fallback: If we're in product_details or start step and have a reply but no currentQuestion,
                // try to create a basic currentQuestion from the reply
                // This handles the case where backend transitions from "start" to "product_details" 
                // but doesn't include currentQuestion in the response
                if ((backendStep === 'product_details' || backendStep === 'start') && data.reply) {
                    console.log('[handleResponse] Creating fallback currentQuestion for product_details from reply');
                    const consultationKey = getCurrentConsultationState(backendStep);
                    const dataKey = consultationKey + 'Data';
                    
                    if (!flowState[dataKey]) {
                        flowState[dataKey] = {};
                    }
                    
                    // Create a basic currentQuestion from the reply
                    // The first product details question is typically "product_description"
                    flowState[dataKey].currentQuestion = {
                        id: 'product_description',
                        question: data.reply,
                        options: null,
                        multiple: false,
                        defaultValue: null
                    };
                    console.log('[handleResponse] Created fallback currentQuestion:', flowState[dataKey].currentQuestion.id);
                }
                
                // No currentQuestion means we're in a non-consultation step (like select_package)
                // Make sure we clear any old consultation data
                if (backendStep === 'select_package' || backendStep === 'select_package_discovery') {
                    if (flowState.productDetailsData) {
                        flowState.productDetailsData.currentQuestion = null;
                    }
                }
            }
            
            if (data.draftOrder) {
                console.log('[handleResponse] Draft order created:', data.draftOrder.id);
                flowState.draftOrder = data.draftOrder;
            }
            
            console.log('[handleResponse] Final flowState:', JSON.parse(JSON.stringify(flowState)));
            console.log('[handleResponse] ========== END ==========');
            
            // Re-render steps
            renderSteps();
        }
        
        // Salla Integration Functions
        function connectSalla() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                alert('Please enter your Worker URL first');
                return;
            }
            
            // Ensure API URL has protocol
            let baseUrl = apiUrl;
            if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                baseUrl = 'https://' + baseUrl;
            }
            
            // Remove trailing slash if present
            baseUrl = baseUrl.replace(/\/$/, '');
            
            // Get Salla OAuth URL - in production, this should come from your backend
            // IMPORTANT: This Client ID must match your Salla app
            const clientId = '0154f184-9ad8-4d2f-97c2-6beaf2334ed6'; // From your Salla app
            
            // Construct redirect URI - MUST match exactly what's registered in Salla Partners portal
            // Format: https://your-worker.workers.dev/api/salla/callback
            const redirectUri = `${baseUrl}/api/salla/callback`;
            
            // IMPORTANT: The redirect_uri must be EXACTLY registered in your Salla app settings
            // Go to: https://portal.salla.partners/apps/357944659
            // Add this exact URL to your app's redirect URIs: ${redirectUri}
            console.log('[connectSalla] Redirect URI:', redirectUri);
            console.log('[connectSalla] Make sure this URL is registered in your Salla app settings!');
            
            // Generate a longer, more secure state parameter (Salla requires sufficient length)
            // Format: random string + timestamp to ensure uniqueness and length
            const randomPart = Array.from(crypto.getRandomValues(new Uint8Array(16)))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            const timestamp = Date.now().toString(36);
            const state = `${randomPart}${timestamp}`;
            
            console.log('[connectSalla] Generated state:', state, 'Length:', state.length);
            
            // Build OAuth URL with properly encoded redirect_uri
            const authUrl = `https://accounts.salla.sa/oauth2/auth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=offline_access&state=${state}`;
            
            // Store state in sessionStorage
            sessionStorage.setItem('salla_oauth_state', state);
            
            // Debug information
            console.log('=== Salla OAuth Debug Info ===');
            console.log('[connectSalla] Base URL:', baseUrl);
            console.log('[connectSalla] Redirect URI:', redirectUri);
            console.log('[connectSalla] Encoded Redirect URI:', encodeURIComponent(redirectUri));
            console.log('[connectSalla] Client ID:', clientId);
            console.log('[connectSalla] Full OAuth URL:', authUrl);
            console.log('================================');
            
            // Open OAuth in new window or redirect
            window.location.href = authUrl;
        }
        
        // Update redirect URI display (if element exists)
        function updateRedirectUriDisplay() {
            const redirectUriDisplay = document.getElementById('redirectUriDisplay');
            if (!redirectUriDisplay) return; // Element doesn't exist, skip
            
            const apiUrl = document.getElementById('apiUrl');
            if (!apiUrl) return;
            
            const apiUrlValue = apiUrl.value.trim();
            if (!apiUrlValue) {
                redirectUriDisplay.textContent = 'Enter Worker URL above';
                return;
            }
            
            let baseUrl = apiUrlValue;
            if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                baseUrl = 'https://' + baseUrl;
            }
            baseUrl = baseUrl.replace(/\/$/, '');
            
            const redirectUri = `${baseUrl}/api/salla/callback`;
            redirectUriDisplay.textContent = redirectUri;
            redirectUriDisplay.setAttribute('data-uri', redirectUri);
        }
        
        // Check for OAuth callback or pre-existing connection
        function checkSallaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const state = urlParams.get('state');
            const oauthError = urlParams.get('oauth_error');
            const errorDescription = urlParams.get('error_description');
            const connected = urlParams.get('connected'); // Flag from /app endpoint
            const storeId = urlParams.get('store_id');
            
            // Handle OAuth errors
            if (oauthError) {
                console.error('[checkSallaCallback] OAuth error:', oauthError, errorDescription);
                const errorMsg = errorDescription || oauthError;
                
                // Show error notification and expand stores section
                const accountSection = document.getElementById('accountSection');
                if (accountSection) {
                    accountSection.classList.remove('collapsed');
                }
                
                // Show error message
                alert(currentLang === 'ar' 
                    ? `ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿ≥ŸÑÿ©: ${errorMsg}\n\nŸäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`
                    : `Salla connection error: ${errorMsg}\n\nPlease try again.`);
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            // Handle successful connection (from OAuth or app context)
            if (accessToken) {
                sallaAccessToken = accessToken;
                if (storeId) {
                    sallaStoreId = storeId;
                }
                
                // Add store to connected stores list
                const storeName = storeId ? `Salla Store ${storeId}` : 'Salla Store';
                const existingStore = connectedStores.find(s => s.host === 'salla' && s.id === parseInt(storeId));
                
                if (!existingStore) {
                    connectedStores.push({
                        id: storeId ? parseInt(storeId) : Date.now(),
                        name: storeName,
                        host: 'salla',
                        logo: null
                    });
                    renderStores();
                }
                
                // Expand stores section to show the new connection
                const accountSection = document.getElementById('accountSection');
                if (accountSection) {
                    accountSection.classList.remove('collapsed');
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        async function showProductSelector() {
            if (!sallaAccessToken) {
                alert('Please connect to Salla first');
                return;
            }
            
            const modal = document.getElementById('productSelectorModal');
            const productList = document.getElementById('productList');
            modal.style.display = 'flex';
            productList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading products...</div>';
            
            try {
                const apiUrl = document.getElementById('apiUrl').value.trim();
                const response = await fetch(`${apiUrl}/api/salla/products?access_token=${sallaAccessToken}`);
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    productList.innerHTML = data.products.map(product => `
                        <div onclick="selectSallaProduct(${product.id})" 
                             style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#FFC107'; this.style.transform='translateY(-2px)'"
                             onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'">
                            ${product.images && product.images.length > 0 ? 
                                `<img src="${product.images[0].url}" alt="${product.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">` : 
                                '<div style="width: 100%; height: 150px; background: #f0f0f0; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: #999;">No Image</div>'
                            }
                            <div style="font-weight: 600; margin-bottom: 5px;">${product.name}</div>
                            ${product.description ? `<div style="font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.description}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    productList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No products found in your store</div>';
                }
            } catch (error) {
                console.error('[showProductSelector] Error:', error);
                productList.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading products. Please try again.</div>';
            }
        }
        
        function closeProductSelector() {
            document.getElementById('productSelectorModal').style.display = 'none';
        }
        
        async function selectSallaProduct(productId) {
            closeProductSelector();
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            
            // Start the flow with Salla product
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flow: 'direct_sales',
                        sallaAccessToken: sallaAccessToken,
                        sallaProductId: productId,
                        message: 'Start package design'
                    })
                });
                
                const data = await response.json();
                handleResponse(data, { type: 'salla_product_selection' });
                
                // Show steps container
                const stepsContainer = document.getElementById('stepsContainer');
                if (stepsContainer) {
                    stepsContainer.classList.add('visible');
                }
            } catch (error) {
                console.error('[selectSallaProduct] Error:', error);
                alert(currentLang === 'ar' ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.' : 'An error occurred. Please try again.');
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                // imageData is base64 string
                startWithImage(imageData);
            };
            reader.readAsDataURL(file);
        }
        
        async function startWithImage(imageBase64) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flow: 'direct_sales',
                        productImageBase64: imageBase64.split(',')[1], // Remove data:image/... prefix
                        message: 'Start package design with image'
                    })
                });
                
                const data = await response.json();
                handleResponse(data, { type: 'image_upload' });
                
                // Show steps container
                const stepsContainer = document.getElementById('stepsContainer');
                if (stepsContainer) {
                    stepsContainer.classList.add('visible');
                }
            } catch (error) {
                console.error('[startWithImage] Error:', error);
                alert(currentLang === 'ar' ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.' : 'An error occurred. Please try again.');
            }
        }
        
        function showTextInput() {
            document.getElementById('textInputModal').style.display = 'flex';
        }
        
        function closeTextInput() {
            document.getElementById('textInputModal').style.display = 'none';
            document.getElementById('productDescriptionText').value = '';
        }
        
        async function submitTextDescription() {
            const description = document.getElementById('productDescriptionText').value.trim();
            if (!description) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨' : 'Please enter a product description');
                return;
            }
            
            closeTextInput();
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        flow: 'direct_sales',
                        message: description
                    })
                });
                
                const data = await response.json();
                handleResponse(data, { type: 'text_description' });
                
                // Show steps container
                const stepsContainer = document.getElementById('stepsContainer');
                if (stepsContainer) {
                    stepsContainer.classList.add('visible');
                }
            } catch (error) {
                console.error('[submitTextDescription] Error:', error);
                alert('Error starting package design. Please try again.');
            }
        }
        
        async function loadAvailableModels() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                alert('Please enter a Worker URL');
                return;
            }
            
            try {
                const response = await fetch(`${apiUrl}?list=models`);
                const data = await response.json();
                if (data.selected) {
                    alert(`Selected Model: ${data.selected}\n\nAvailable: ${data.models.length} models`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function resetSession() {
            if (!confirm('Are you sure you want to reset the session? This will clear all progress and start fresh.')) {
                return;
            }
            
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (apiUrl) {
                try {
                    // Send reset request to backend to clear Durable Object memory
                    await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reset: true, flow: currentFlow })
                    });
                } catch (error) {
                    console.error('[resetSession] Error resetting backend:', error);
                }
            }
            
            // Reset frontend state
            flowState = {
                productDetails: {},
                package: null,
                variant: null,
                packageImageUrl: null,
                packageSpecs: {},
                fulfillmentSpecs: {},
                launchKit: {},
                draftOrder: null,
                backendStep: null,
                previousBackendStep: null,
                productDetailsData: null,
                packageData: null,
                packageSpecsData: null,
                fulfillmentSpecsData: null,
                launchKitData: null,
                productMatches: [],
                queryMatches: [],
                queryMatchesQuery: ''
            };
            
            // Re-initialize the flow
            await initializeFlow();
        }
        
        // Initialize - make initial API call to get first question
        async function initializeFlow() {
            console.log('[initializeFlow] Initializing flow...');
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                console.log('[initializeFlow] No API URL, skipping initialization');
                renderSteps();
                return;
            }
            
            try {
                // Check if we should reset (e.g., if there's a URL parameter)
                const urlParams = new URLSearchParams(window.location.search);
                const shouldReset = urlParams.get('reset') === 'true';
                
                // Send empty message to trigger start step
                // If reset is needed, send reset parameter to clear stale Durable Object data
                console.log('[initializeFlow] Sending initial request to:', apiUrl, shouldReset ? '(with reset)' : '');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: shouldReset ? 'reset' : '', 
                        flow: currentFlow,
                        reset: shouldReset
                    })
                });
                
                console.log('[initializeFlow] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[initializeFlow] Response error:', errorText);
                    renderSteps();
                    return;
                }
                
                const data = await response.json();
                console.log('[initializeFlow] Initial response:', data);
                console.log('[initializeFlow] Backend step:', data.flowState?.step);
                console.log('[initializeFlow] Current question:', data.currentQuestion);
                
                // Use handleResponse to process the initial response properly
                handleResponse(data, { type: 'init' });
            } catch (error) {
                console.error('[initializeFlow] Error:', error);
                renderSteps();
            }
        }
        
        // Language Management
        let currentLang = 'ar';
        
        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.setAttribute('lang', lang);
            document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            
            // Update language toggle buttons
            document.getElementById('langAr').classList.toggle('active', lang === 'ar');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            // Update all elements with data-ar and data-en attributes
            document.querySelectorAll('[data-ar][data-en]').forEach(el => {
                const text = el.getAttribute(`data-${lang}`);
                if (text) {
                    el.textContent = text;
                }
            });
            
            // Re-render stores and inventory table with new language
            renderStores();
            renderInventoryTable();
        }
        
        // Store Management
        const connectedStores = [
            {
                id: 1,
                name: 'Demo Store',
                host: 'custom',
                logo: null
            }
        ];
        
        const hostConfig = {
            salla: { name: 'Salla', icon: 'üõçÔ∏è', color: '#00A859' },
            custom: { name: 'Custom', icon: '‚öôÔ∏è', color: '#6c757d' },
            shopify: { name: 'Shopify', icon: 'üõí', color: '#96bf48' },
            zed: { name: 'Zed', icon: 'üì¶', color: '#ff6b35' }
        };
        
        function renderStores() {
            const storesList = document.getElementById('storesList');
            if (!storesList) return;
            
            if (connectedStores.length === 0) {
                storesList.innerHTML = `<div style="width: 100%; text-align: center; padding: 40px; color: #999;" data-ar="ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ™ÿßÿ¨ÿ± ŸÖÿ™ÿµŸÑÿ©" data-en="No connected stores">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ™ÿßÿ¨ÿ± ŸÖÿ™ÿµŸÑÿ©</div>`;
                return;
            }
            
            const disconnectText = currentLang === 'ar' ? 'ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ' : 'Disconnect';
            
            storesList.innerHTML = connectedStores.map(store => {
                const host = hostConfig[store.host] || hostConfig.custom;
                const logoHtml = store.logo 
                    ? `<img src="${store.logo}" alt="${store.name}" class="store-logo">`
                    : `<div class="store-logo-placeholder">${host.icon}</div>`;
                
                return `
                    <div class="store-card">
                        <div class="store-logo-container">
                            ${logoHtml}
                            <div class="host-badge" style="background: ${host.color};">
                                <span style="color: white; font-size: 14px;">${host.icon}</span>
                            </div>
                        </div>
                        <div class="store-name">${store.name}</div>
                        <button onclick="disconnectStore(${store.id})" class="disconnect-btn">${disconnectText}</button>
                    </div>
                `;
            }).join('');
        }
        
        function toggleConnectMenu() {
            const menu = document.getElementById('connectMenu');
            if (menu) {
                menu.classList.toggle('visible');
            }
        }
        
        function connectStore(host) {
            toggleConnectMenu();
            // In production, this would open OAuth flow or store connection modal
            if (host === 'salla') {
                connectSalla();
            } else if (host === 'custom') {
                showCustomStoreDialog();
            } else if (host === 'shopify' || host === 'zed') {
                // Disabled - do nothing
                return;
            }
        }
        
        function orderPackageForProduct(productId) {
            const product = demoProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product has a package
            if (!product.hasPackage) {
                alert(currentLang === 'ar' 
                    ? 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ ÿ£ŸàŸÑÿßŸã ŸÑÿ±ÿ®ÿ∑Ÿá ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨'
                    : 'Please design a package first to associate it with this product');
                // Optionally trigger design flow
                designPackageForProduct(productId);
                return;
            }
            
            // If package exists, show the wizard to proceed with ordering
            designPackageForProduct(productId);
        }
        
        function showCustomStoreDialog() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('customStoreModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customStoreModal';
                modal.className = 'modal-overlay';
                modal.style.display = 'none';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; direction: ${currentLang === 'ar' ? 'rtl' : 'ltr'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="margin: 0; color: #1a1a1a;" data-ar="ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ™ÿ¨ÿ± ŸÖÿÆÿµÿµ" data-en="Add Custom Store">${currentLang === 'ar' ? 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ™ÿ¨ÿ± ŸÖÿÆÿµÿµ' : 'Add Custom Store'}</h2>
                            <button onclick="closeCustomStoreDialog()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; line-height: 1;">&times;</button>
                        </div>
                        
                        <!-- Store Logo Upload -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;" data-ar="ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±" data-en="Store Logo">${currentLang === 'ar' ? 'ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±' : 'Store Logo'}</label>
                            <div style="border: 2px dashed #e0e0e0; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s;" 
                                 onclick="document.getElementById('customStoreLogoInput').click()"
                                 onmouseover="this.style.borderColor='#1a1a1a'"
                                 onmouseout="this.style.borderColor='#e0e0e0'">
                                <div id="customStoreLogoPreview" style="display: none; margin-bottom: 15px;">
                                    <img id="customStoreLogoImg" src="" alt="Logo Preview" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                </div>
                                <div id="customStoreLogoPlaceholder">
                                    <div style="font-size: 48px; margin-bottom: 10px;">üñºÔ∏è</div>
                                    <div style="color: #666;" data-ar="ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±" data-en="Click to upload store logo">${currentLang === 'ar' ? 'ÿßŸÜŸÇÿ± ŸÑÿ±ŸÅÿπ ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±' : 'Click to upload store logo'}</div>
                                </div>
                                <input type="file" id="customStoreLogoInput" accept="image/*" style="display: none;" onchange="handleCustomStoreLogoUpload(event)">
                            </div>
                        </div>
                        
                        <!-- Store Name -->
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;" data-ar="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±" data-en="Store Name">${currentLang === 'ar' ? 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±' : 'Store Name'}</label>
                            <input type="text" id="customStoreName" data-ar-placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±" data-en-placeholder="Enter store name" placeholder="${currentLang === 'ar' ? 'ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±' : 'Enter store name'}" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; direction: ${currentLang === 'ar' ? 'rtl' : 'ltr'}; text-align: ${currentLang === 'ar' ? 'right' : 'left'};">
                        </div>
                        
                        <!-- Dialog Actions -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeCustomStoreDialog()" style="padding: 12px 24px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;" data-ar="ÿ•ŸÑÿ∫ÿßÿ°" data-en="Cancel">${currentLang === 'ar' ? 'ÿ•ŸÑÿ∫ÿßÿ°' : 'Cancel'}</button>
                            <button onclick="saveCustomStore()" style="padding: 12px 24px; background: #1a1a1a; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;" data-ar="ÿ≠ŸÅÿ∏" data-en="Save">${currentLang === 'ar' ? 'ÿ≠ŸÅÿ∏' : 'Save'}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Reset form
            document.getElementById('customStoreName').value = '';
            document.getElementById('customStoreLogoPreview').style.display = 'none';
            document.getElementById('customStoreLogoPlaceholder').style.display = 'block';
            window.customStoreLogoData = null;
            
            // Update language and direction
            updateLanguage();
            
            modal.style.display = 'flex';
        }
        
        function closeCustomStoreDialog() {
            const modal = document.getElementById('customStoreModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function handleCustomStoreLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿµŸàÿ±ÿ©' : 'Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('customStoreLogoPreview');
                const placeholder = document.getElementById('customStoreLogoPlaceholder');
                const img = document.getElementById('customStoreLogoImg');
                
                img.src = e.target.result;
                window.customStoreLogoData = e.target.result; // Store as base64
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        function saveCustomStore() {
            const storeName = document.getElementById('customStoreName').value.trim();
            if (!storeName) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ™ÿ¨ÿ±' : 'Please enter store name');
                return;
            }
            
            connectedStores.push({
                id: Date.now(),
                name: storeName,
                host: 'custom',
                logo: window.customStoreLogoData || null
            });
            renderStores();
            closeCustomStoreDialog();
        }
        
        function disconnectStore(storeId) {
            if (confirm(currentLang === 'ar' ? 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿ¨ÿ±ÿü' : 'Are you sure you want to disconnect this store?')) {
                const index = connectedStores.findIndex(s => s.id === storeId);
                if (index > -1) {
                    connectedStores.splice(index, 1);
                    renderStores();
                }
            }
        }
        
        // Close connect menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('connectMenu');
            const btn = document.querySelector('.connect-store-btn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('visible');
            }
        });
        
        // Inventory Management
        const demoProducts = [
            {
                id: 2,
                nameAr: 'ÿ¥ÿßŸÖÿ®Ÿà ÿπÿ∂ŸàŸä - 500 ŸÖŸÑ',
                nameEn: 'Organic Shampoo - 500ml',
                productPhoto: 'https://images.unsplash.com/photo-1556228720-195a672e8a03?w=200&h=200&fit=crop',
                packageAr: null,
                packageEn: null,
                packagePhoto: null,
                storeId: 1,
                storeName: 'Demo Store',
                host: 'custom',
                stockAmount: 0,
                hasPackage: false
            }
        ];
        
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            const noProductsMsg = document.getElementById('noProductsMessage');
            
            if (!tbody) return;
            
            if (demoProducts.length === 0) {
                tbody.innerHTML = '';
                if (noProductsMsg) noProductsMsg.style.display = 'block';
                return;
            }
            
            if (noProductsMsg) noProductsMsg.style.display = 'none';
            
                const isAr = currentLang === 'ar';
                const orderBtnText = isAr ? 'ÿ∑ŸÑÿ® ÿ∫ŸÑÿßŸÅ ÿßŸÑÿ¢ŸÜ' : 'Order Package Now';
                const designBtnText = isAr ? 'ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ' : 'Design Package';
                const noPackageMsg = isAr ? 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ ÿ£ŸàŸÑÿßŸã ŸÑÿ±ÿ®ÿ∑Ÿá ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨' : 'Please design a package first to associate it with this product';
                
                tbody.innerHTML = demoProducts.map(product => {
                    // Product column: Photo + Name
                    const productPhoto = product.productPhoto 
                        ? `<img src="${product.productPhoto}" alt="${isAr ? product.nameAr : product.nameEn}" class="product-photo" style="margin-bottom: 8px;">`
                        : `<div class="photo-placeholder" style="margin-bottom: 8px;">üì¶</div>`;
                    const productName = isAr ? product.nameAr : product.nameEn;
                    
                    // Store icons under product description
                    const host = hostConfig[product.host] || hostConfig.custom;
                    const storeIcons = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 8px;">
                            <div class="store-source-icon" style="background: ${host.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; width: 20px; height: 20px; border-radius: 4px;" title="${product.storeName}">
                                ${host.icon}
                            </div>
                            <span style="font-size: 11px; color: #666;">${product.storeName}</span>
                        </div>
                    `;
                    
                    const productCell = `
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            ${productPhoto}
                            <div style="font-weight: 600; color: #1a1a1a; text-align: center;">${productName}</div>
                            ${storeIcons}
                        </div>
                    `;
                    
                    // Package column: Package info + Photo OR Design Package button
                    let packageCell = '';
                    if (product.hasPackage && product.packagePhoto) {
                        // Use actual package name (Ar or En based on current language)
                        const packageName = currentLang === 'ar' ? (product.packageAr || product.packageEn || 'Custom Package') : (product.packageEn || product.packageAr || 'Custom Package');
                        packageCell = `
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <img src="${product.packagePhoto}" alt="${packageName}" class="package-photo">
                                <div style="font-weight: 600; color: #1a1a1a; text-align: center;">${packageName}</div>
                            </div>
                        `;
                    } else {
                        const noPreviewText = isAr ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿßŸäŸÜÿ©' : 'No Preview';
                        packageCell = `
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                <div style="color: #999; font-size: 13px; font-style: italic;">${noPreviewText}</div>
                                <button onclick="designPackageForProduct(${product.id})" class="design-btn" style="width: 100%; max-width: 200px;">
                                    ${designBtnText}
                                </button>
                            </div>
                        `;
                    }
                    
                    // Source column - now empty (moved to product cell)
                    const sourceHtml = '';
                    
                    // Stock & Actions column: Stock amount + Order button
                    const stockAmount = product.stockAmount || 0;
                    const stockDisplay = stockAmount > 0 
                        ? `<span style="color: #28a745; font-weight: 700; font-size: 16px;">${stockAmount}</span>`
                        : `<span style="color: #dc3545; font-weight: 700; font-size: 16px;">0</span>`;
                    
                    let stockActionCell = '';
                    if (product.hasPackage) {
                        stockActionCell = `
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                <div style="font-size: 14px; color: #666;" data-ar="ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ:" data-en="Stock:">${currentLang === 'ar' ? 'ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ:' : 'Stock:'} ${stockDisplay}</div>
                                <button onclick="orderPackageForProduct(${product.id})" class="design-btn" style="width: 100%; max-width: 200px;">
                                    ${orderBtnText}
                                </button>
                            </div>
                        `;
                    } else {
                        // Empty cell when no package is designed
                        stockActionCell = '';
                    }
                
                return `
                    <tr>
                        <td style="text-align: center; padding: 20px;">${productCell}</td>
                        <td style="text-align: center; padding: 20px;">${packageCell}</td>
                        <td style="text-align: center; padding: 20px;">${stockActionCell}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function orderPackageForProduct(productId) {
            const product = demoProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product has a package
            if (!product.hasPackage) {
                alert(currentLang === 'ar' 
                    ? 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿµŸÖŸäŸÖ ÿ∫ŸÑÿßŸÅ ÿ£ŸàŸÑÿßŸã ŸÑÿ±ÿ®ÿ∑Ÿá ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨'
                    : 'Please design a package first to associate it with this product');
                // Optionally trigger design flow
                designPackageForProduct(productId);
                return;
            }
            
            // Show the order package dialog (not design package dialog)
            showOrderPackageDialog(productId);
        }
        
        function designPackageForProduct(productId) {
            const product = demoProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Store product ID for later use
            window.currentDesignProductId = productId;
            
            // Show the design package dialog
            showDesignPackageDialog();
        }
        
        let shippingAddressAutocomplete = null;
        
        function showDesignPackageDialog() {
            const modal = document.getElementById('designPackageModal');
            if (modal) {
                modal.style.display = 'flex';
                // Reset form
                document.getElementById('packageMaterial').value = '';
                document.querySelectorAll('input[name="packagePrintType"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[type="checkbox"][id^="finish"]').forEach(checkbox => checkbox.checked = false);
                // Fulfillment fields removed - they're now in Order Package dialog
                
                // Hide sections that appear after submission
                document.getElementById('packageMatchesSection').style.display = 'none';
                document.getElementById('generatedImageSection').style.display = 'none';
                document.getElementById('startDesignBtn').style.display = 'block';
                
                // Initialize Google Maps autocomplete for shipping address
                setTimeout(() => {
                    initShippingAddressAutocomplete();
                }, 100);
            }
        }
        
        async function initShippingAddressAutocomplete() {
            const addressInput = document.getElementById('fulfillmentShippingAddress');
            if (!addressInput) return;
            
            // Wait for Google Maps to load
            try {
                await window.googleMapsReady;
            } catch (e) {
                console.warn('Google Maps API not available');
                return;
            }
            
            if (!window.google || !window.google.maps || !window.google.maps.places) {
                console.warn('Google Maps Places API not loaded');
                return;
            }
            
            // Remove existing autocomplete if any
            if (shippingAddressAutocomplete) {
                google.maps.event.clearInstanceListeners(shippingAddressAutocomplete);
                shippingAddressAutocomplete = null;
            }
            
            // Create new autocomplete
            shippingAddressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                types: ['address'],
                componentRestrictions: { country: ['sa', 'ae', 'kw', 'qa', 'bh', 'om'] }, // GCC countries
                fields: ['formatted_address', 'geometry', 'address_components']
            });
            
            shippingAddressAutocomplete.addListener('place_changed', function() {
                const place = shippingAddressAutocomplete.getPlace();
                if (place.formatted_address) {
                    addressInput.value = place.formatted_address;
                }
            });
        }
        
        function closeDesignPackageDialog() {
            const modal = document.getElementById('designPackageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function showOrderPackageDialog(productId) {
            const product = demoProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Store product ID for later use
            window.currentOrderProductId = productId;
            
            const modal = document.getElementById('orderPackageModal');
            if (modal) {
                modal.style.display = 'flex';
                
                // Populate product info
                const productDetailsDiv = document.getElementById('orderProductDetails');
                if (productDetailsDiv) {
                    const productName = currentLang === 'ar' ? product.nameAr : product.nameEn;
                    const packageName = currentLang === 'ar' ? (product.packageAr || product.packageEn) : (product.packageEn || product.packageAr);
                    productDetailsDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <strong data-ar="ÿßŸÑŸÖŸÜÿ™ÿ¨:" data-en="Product:">${currentLang === 'ar' ? 'ÿßŸÑŸÖŸÜÿ™ÿ¨:' : 'Product:'}</strong> ${productName}
                        </div>
                        <div>
                            <strong data-ar="ÿßŸÑÿ∫ŸÑÿßŸÅ:" data-en="Package:">${currentLang === 'ar' ? 'ÿßŸÑÿ∫ŸÑÿßŸÅ:' : 'Package:'}</strong> ${packageName}
                        </div>
                    `;
                }
                
                // Reset form
                document.getElementById('orderQuantity').value = '1';
                document.getElementById('orderFulfillmentTimeline').value = '';
                document.getElementById('orderFulfillmentShippingAddress').value = '';
                document.getElementById('orderFulfillmentSpecialInstructions').value = '';
                
                // Hide result section
                document.getElementById('orderResultSection').style.display = 'none';
                document.getElementById('submitOrderBtn').style.display = 'block';
                
                // Initialize Google Maps autocomplete for shipping address
                setTimeout(() => {
                    initOrderShippingAddressAutocomplete();
                }, 100);
            }
        }
        
        function closeOrderPackageDialog() {
            const modal = document.getElementById('orderPackageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function initOrderShippingAddressAutocomplete() {
            const addressInput = document.getElementById('orderFulfillmentShippingAddress');
            if (!addressInput) return;
            
            // Wait for Google Maps to load
            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                console.warn('Google Maps API not loaded yet');
                return;
            }
            
            try {
                const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                    types: ['address'],
                    componentRestrictions: { country: ['sa', 'ae', 'kw', 'bh', 'om', 'qa'] } // GCC countries
                });
                
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.formatted_address) {
                        addressInput.value = place.formatted_address;
                    }
                });
            } catch (error) {
                console.error('Error initializing address autocomplete:', error);
            }
        }
        
        async function submitOrder() {
            const productId = window.currentOrderProductId;
            if (!productId) {
                alert(currentLang === 'ar' ? 'ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨' : 'Error: Product not found');
                return;
            }
            
            const product = demoProducts.find(p => p.id === productId);
            if (!product || !product.hasPackage) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÑÿØŸäŸá ÿ∫ŸÑÿßŸÅ ŸÖÿ±ÿ™ÿ®ÿ∑' : 'Please ensure the product has a linked package');
                return;
            }
            
            // Collect form data
            const quantity = parseInt(document.getElementById('orderQuantity').value) || 1;
            const timeline = document.getElementById('orderFulfillmentTimeline').value;
            const shippingAddress = document.getElementById('orderFulfillmentShippingAddress').value;
            const specialInstructions = document.getElementById('orderFulfillmentSpecialInstructions').value;
            
            // Validate required fields
            if (!timeline || !shippingAddress) {
                alert(currentLang === 'ar' 
                    ? 'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© (ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸàÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿ≠ŸÜ)'
                    : 'Please fill in all required fields (timeline and shipping address)');
                return;
            }
            
            // Build note with fulfillment information
            const noteParts = [];
            noteParts.push(`Product: ${currentLang === 'ar' ? product.nameAr : product.nameEn}`);
            noteParts.push(`Package: ${currentLang === 'ar' ? (product.packageAr || product.packageEn) : (product.packageEn || product.packageAr)}`);
            noteParts.push(`Timeline: ${timeline}`);
            noteParts.push(`Shipping Address: ${shippingAddress}`);
            if (specialInstructions && specialInstructions.trim() && specialInstructions.trim().toLowerCase() !== 'none') {
                noteParts.push(`Special Instructions: ${specialInstructions}`);
            }
            const note = noteParts.join('\n');
            
            // Disable submit button
            const submitBtn = document.getElementById('submitOrderBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = currentLang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...' : 'Processing...';
            
            try {
                // First, get the variant ID from the product ID if we don't have it
                let variantId = product.packageVariantId;
                
                if (!variantId && product.packageId) {
                    console.log('[submitOrder] Fetching variant ID for product:', product.packageId);
                    const variantResponse = await fetch('/api/get-variant-id', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            productId: product.packageId
                        })
                    });
                    
                    if (!variantResponse.ok) {
                        const errorData = await variantResponse.json();
                        throw new Error(errorData.error || 'Failed to get variant ID');
                    }
                    
                    const variantData = await variantResponse.json();
                    variantId = variantData.variantId;
                    console.log('[submitOrder] Got variant ID:', variantId);
                    
                    // Store it for future use
                    product.packageVariantId = variantId;
                }
                
                if (!variantId) {
                    throw new Error(currentLang === 'ar' 
                        ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ŸÑŸÑÿ∫ŸÑÿßŸÅ'
                        : 'Variant ID not found for package');
                }
                
                // Call API to create draft order
                const response = await fetch('/api/create-draft-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        variantId: variantId,
                        quantity: quantity,
                        note: note
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create order');
                }
                
                const data = await response.json();
                
                // Show success message with links
                const resultSection = document.getElementById('orderResultSection');
                const resultLinks = document.getElementById('orderResultLinks');
                
                if (resultSection && resultLinks) {
                    resultLinks.innerHTML = '';
                    
                    if (data.adminUrl) {
                        const adminLink = document.createElement('a');
                        adminLink.href = data.adminUrl;
                        adminLink.target = '_blank';
                        adminLink.style.cssText = 'display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: #FFC107; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 16px; text-decoration: none; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);';
                        adminLink.textContent = currentLang === 'ar' ? 'ŸÅÿ™ÿ≠ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä Shopify' : 'Open Order in Shopify';
                        adminLink.onmouseover = function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.3)'; };
                        adminLink.onmouseout = function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)'; };
                        resultLinks.appendChild(adminLink);
                    }
                    
                    if (data.invoiceUrl) {
                        const invoiceLink = document.createElement('a');
                        invoiceLink.href = data.invoiceUrl;
                        invoiceLink.target = '_blank';
                        invoiceLink.style.cssText = 'display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 16px; text-decoration: none; transition: all 0.3s; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);';
                        invoiceLink.textContent = currentLang === 'ar' ? 'ŸÅÿ™ÿ≠ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿØŸÅÿπ' : 'Open Payment Form';
                        invoiceLink.onmouseover = function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 6px 20px rgba(40, 167, 69, 0.4)'; };
                        invoiceLink.onmouseout = function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 4px 15px rgba(40, 167, 69, 0.3)'; };
                        resultLinks.appendChild(invoiceLink);
                    }
                    
                    resultSection.style.display = 'block';
                    submitBtn.style.display = 'none';
                    
                    // Scroll to result section
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            } catch (error) {
                console.error('Error creating order:', error);
                
                // Parse error message for better user experience
                let errorMessage = error.message || 'Unknown error';
                
                // Check if it's a Shopify API error
                if (errorMessage.includes('Shopify API Error')) {
                    // Try to extract a more user-friendly message
                    if (errorMessage.includes('no longer available')) {
                        errorMessage = currentLang === 'ar' 
                            ? 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑŸÖÿ≠ÿØÿØ ŸÑŸÖ ŸäÿπÿØ ŸÖÿ™ÿßÿ≠ÿßŸã. Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫ŸÑÿßŸÅ ÿ¢ÿÆÿ±.'
                            : 'The selected product is no longer available. Please select a different package.';
                    } else if (errorMessage.includes('422')) {
                        errorMessage = currentLang === 'ar' 
                            ? 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫ŸÑÿßŸÅ ÿ¢ÿÆÿ±.'
                            : 'Invalid order data. Please try again or select a different package.';
                    } else {
                        errorMessage = currentLang === 'ar' 
                            ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Shopify. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                            : 'Error connecting to Shopify. Please try again.';
                    }
                }
                
                alert(currentLang === 'ar' 
                    ? `ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®: ${errorMessage}`
                    : `Error creating order: ${errorMessage}`);
                submitBtn.disabled = false;
                submitBtn.textContent = currentLang === 'ar' ? 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®' : 'Submit Order';
            }
        }
        
        async function submitDesignPackage() {
            console.log('[submitDesignPackage] ========== START ==========');
            console.log('[submitDesignPackage] Timestamp:', new Date().toISOString());
            
            // Collect form data (only package specs, no fulfillment - that's in Order Package dialog)
            const packageData = {
                material: document.getElementById('packageMaterial').value,
                printType: document.querySelector('input[name="packagePrintType"]:checked')?.value || '',
                finishing: Array.from(document.querySelectorAll('input[type="checkbox"][id^="finish"]:checked')).map(cb => cb.value)
            };
            
            console.log('[submitDesignPackage] Package data collected:', JSON.stringify(packageData, null, 2));
            
            // Validate required fields
            if (!packageData.material) {
                console.warn('[submitDesignPackage] Validation failed: Material not selected');
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿßÿØÿ©' : 'Please select a material');
                return;
            }
            
            if (!packageData.printType) {
                console.warn('[submitDesignPackage] Validation failed: Print type not selected');
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©' : 'Please select a printing type');
                return;
            }
            
            console.log('[submitDesignPackage] All validations passed');
            
            // Get product info
            const productId = window.currentDesignProductId;
            console.log('[submitDesignPackage] Product ID:', productId);
            const product = productId ? demoProducts.find(p => p.id === productId) : null;
            console.log('[submitDesignPackage] Product found:', product ? 'Yes' : 'No', product);
            const productName = product ? (currentLang === 'ar' ? product.nameAr : product.nameEn) : '';
            const productPhoto = product?.productPhoto || '';
            console.log('[submitDesignPackage] Product name:', productName);
            console.log('[submitDesignPackage] Product photo:', productPhoto ? 'Yes' : 'No');
            
            // Build product description (only product name for keyword matching)
            let productDescription = productName;
            
            // Get product dimensions from form fields (3 separate inputs)
            const length = parseFloat(document.getElementById('productLength')?.value || '0');
            const width = parseFloat(document.getElementById('productWidth')?.value || '0');
            const height = parseFloat(document.getElementById('productHeight')?.value || '0');
            
            // Build search message - ONLY product description and dimensions
            // NO package requirements (material, printing, finishing) - those come AFTER package selection
            let searchMessage = `Product: ${productDescription}`;
            if (length > 0 && width > 0 && height > 0) {
                searchMessage += `\nProduct Dimensions: Length ${length} cm √ó Width ${width} cm √ó Height ${height} cm`;
            }
            console.log('[submitDesignPackage] Search message prepared (product only):', searchMessage);
            console.log('[submitDesignPackage] Product dimensions:', { length, width, height });
            
            // Show loading state
            const startBtn = document.getElementById('startDesignBtn');
            const originalBtnText = startBtn.innerHTML;
            startBtn.disabled = true;
            startBtn.innerHTML = currentLang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...' : 'Searching...';
            
            try {
                // Call LLM to find matching packages
                const apiUrlInput = document.getElementById('apiUrl');
                let apiUrl = 'https://packageha-ai.akhodary-006.workers.dev';
                if (apiUrlInput && apiUrlInput.value.trim()) {
                    apiUrl = apiUrlInput.value.trim();
                }
                
                let finalUrl = apiUrl;
                if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                    finalUrl = 'https://' + finalUrl;
                }
                finalUrl = finalUrl.replace(/\/$/, '');
                
                console.log('[submitDesignPackage] API URL:', finalUrl);
                console.log('[submitDesignPackage] Request body:', JSON.stringify({
                    flow: 'direct_sales',
                    message: searchMessage,
                    reset: false
                }, null, 2));
                
                const requestStartTime = Date.now();
                console.log('[submitDesignPackage] Sending POST request...');
                
                // Use dedicated API endpoint to avoid static asset conflicts
                const response = await fetch(`${finalUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        flow: 'direct_sales',
                        message: searchMessage,
                        reset: false
                    })
                });
                
                const requestDuration = Date.now() - requestStartTime;
                console.log('[submitDesignPackage] Response received after', requestDuration, 'ms');
                console.log('[submitDesignPackage] Response status:', response.status);
                console.log('[submitDesignPackage] Response status text:', response.statusText);
                console.log('[submitDesignPackage] Response headers:', Object.fromEntries(response.headers.entries()));
                console.log('[submitDesignPackage] Response OK:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[submitDesignPackage] Response error details:');
                    console.error('[submitDesignPackage] Status:', response.status);
                    console.error('[submitDesignPackage] Status text:', response.statusText);
                    console.error('[submitDesignPackage] Error body:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const responseText = await response.text();
                console.log('[submitDesignPackage] Response text (raw):', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('[submitDesignPackage] Response data (parsed):', JSON.stringify(data, null, 2));
                } catch (parseError) {
                    console.error('[submitDesignPackage] JSON parse error:', parseError);
                    console.error('[submitDesignPackage] Response text that failed to parse:', responseText);
                    throw new Error('Invalid JSON response from server');
                }
                
                // Extract package matches from response
                console.log('[submitDesignPackage] Checking for productMatches...');
                console.log('[submitDesignPackage] data.productMatches:', data.productMatches);
                console.log('[submitDesignPackage] data.flowState:', data.flowState);
                console.log('[submitDesignPackage] data.reply:', data.reply);
                
                if (data.productMatches && data.productMatches.length > 0) {
                    console.log('[submitDesignPackage] Found', data.productMatches.length, 'package matches');
                    currentPackageMatches = data.productMatches;
                    displayPackageMatches(currentPackageMatches, productPhoto);
                } else if (data.reply) {
                    console.log('[submitDesignPackage] No productMatches, but got reply:', data.reply);
                    // If no matches but we got a reply, the LLM might be asking for more info
                    if (data.flowState && data.flowState.productMatches) {
                        console.log('[submitDesignPackage] Found matches in flowState:', data.flowState.productMatches.length);
                        currentPackageMatches = data.flowState.productMatches;
                        displayPackageMatches(currentPackageMatches, productPhoto);
                    } else {
                        console.warn('[submitDesignPackage] No matches found in response');
                        alert(currentLang === 'ar' 
                            ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ÿ∫ŸÑŸÅÿ© ŸÖŸÜÿßÿ≥ÿ®ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                            : 'No matching packages found. Please try again.');
                    }
                } else {
                    console.warn('[submitDesignPackage] No matches and no reply in response');
                    alert(currentLang === 'ar' 
                        ? 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ÿ∫ŸÑŸÅÿ© ŸÖŸÜÿßÿ≥ÿ®ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                        : 'No matching packages found. Please try again.');
                }
                
                console.log('[submitDesignPackage] ========== SUCCESS ==========');
            } catch (error) {
                console.error('[submitDesignPackage] ========== ERROR ==========');
                console.error('[submitDesignPackage] Error type:', error.constructor.name);
                console.error('[submitDesignPackage] Error message:', error.message);
                console.error('[submitDesignPackage] Error stack:', error.stack);
                console.error('[submitDesignPackage] Full error object:', error);
                alert(currentLang === 'ar' 
                    ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿ∫ŸÑŸÅÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                    : 'Error searching for packages. Please try again.');
            } finally {
                startBtn.disabled = false;
                startBtn.innerHTML = originalBtnText;
                console.log('[submitDesignPackage] ========== END ==========');
            }
        }
        
        let currentPackageMatches = [];
        let selectedPackageMatch = null;
        let generatedPackageImageUrl = null;
        let currentSortBy = 'combined'; // 'combined', 'fitness', 'price'
        
        function displayPackageMatches(matches, productPhoto) {
            const matchesSection = document.getElementById('packageMatchesSection');
            const matchesContainer = document.getElementById('packageMatchesContainer');
            const startBtn = document.getElementById('startDesignBtn');
            
            matchesSection.style.display = 'block';
            startBtn.style.display = 'none';
            
            // Store matches for sorting
            currentPackageMatches = matches;
            
            // Add sort-by controls to the header container
            const sortControlsContainer = document.getElementById('sortControlsContainer');
            if (sortControlsContainer) {
                sortControlsContainer.innerHTML = `
                    <span style="font-weight: 600; color: #666; font-size: 14px;" data-ar="ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ®:" data-en="Sort by:">${currentLang === 'ar' ? 'ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ®:' : 'Sort by:'}</span>
                    <button onclick="sortMatches('combined')" id="sortCombined" style="padding: 8px 16px; border: 2px solid ${currentSortBy === 'combined' ? '#FFC107' : '#e0e0e0'}; background: ${currentSortBy === 'combined' ? '#FFC107' : 'white'}; color: ${currentSortBy === 'combined' ? '#1a1a1a' : '#666'}; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px;" data-ar="ÿßŸÑÿ£ŸÅÿ∂ŸÑ" data-en="Best Match">${currentLang === 'ar' ? 'ÿßŸÑÿ£ŸÅÿ∂ŸÑ' : 'Best Match'}</button>
                    <button onclick="sortMatches('fitness')" id="sortFitness" style="padding: 8px 16px; border: 2px solid ${currentSortBy === 'fitness' ? '#FFC107' : '#e0e0e0'}; background: ${currentSortBy === 'fitness' ? '#FFC107' : 'white'}; color: ${currentSortBy === 'fitness' ? '#1a1a1a' : '#666'}; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px;" data-ar="ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇ" data-en="Relevance">${currentLang === 'ar' ? 'ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇ' : 'Relevance'}</button>
                    <button onclick="sortMatches('price')" id="sortPrice" style="padding: 8px 16px; border: 2px solid ${currentSortBy === 'price' ? '#FFC107' : '#e0e0e0'}; background: ${currentSortBy === 'price' ? '#FFC107' : 'white'}; color: ${currentSortBy === 'price' ? '#1a1a1a' : '#666'}; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px;" data-ar="ÿßŸÑÿ≥ÿπÿ±" data-en="Price">${currentLang === 'ar' ? 'ÿßŸÑÿ≥ÿπÿ±' : 'Price'}</button>
                `;
            }
            
            // Render matches
            const matchesHtml = renderMatches(matches);
            matchesContainer.innerHTML = matchesHtml;
            
            // Scroll to matches section
            matchesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function renderMatches(matches) {
            return matches.map((match, index) => {
                const imageHtml = match.imageUrl 
                    ? `<img src="${match.imageUrl}" alt="${match.name}" style="width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-bottom: 12px;">`
                    : '<div style="width: 100%; height: 180px; background: linear-gradient(135deg, #f5f7fa 0%, #e0e5ec 100%); border-radius: 10px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px;">No Image</div>';
                
                const priceHtml = match.price 
                    ? `<div style="font-size: 18px; font-weight: 700; color: #FFC107; margin-top: 10px;">${parseFloat(match.price).toFixed(2)} SAR</div>`
                    : '';
                
                // Show score info if available
                const scoreInfo = match.fitnessScore !== undefined 
                    ? `<div style="font-size: 11px; color: #999; margin-top: 5px;">Relevance: ${(match.fitnessScore * 100).toFixed(0)}%</div>`
                    : '';
                
                return `
                    <div class="option-card" onclick="selectPackageMatch(${index})" style="cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; background: white; transition: all 0.3s; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);" onmouseover="this.style.borderColor='#FFC107'; this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0, 0, 0, 0.05)'">
                        ${imageHtml}
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: #1a1a1a;">${match.name}</div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.5;">${match.reason || ''}</div>
                        ${scoreInfo}
                        ${priceHtml}
                    </div>
                `;
            }).join('');
        }
        
        function sortMatches(sortBy) {
            if (!currentPackageMatches || currentPackageMatches.length === 0) return;
            
            currentSortBy = sortBy;
            
            // Sort matches
            const sorted = [...currentPackageMatches].sort((a, b) => {
                if (sortBy === 'fitness') {
                    return (b.fitnessScore || 0) - (a.fitnessScore || 0);
                } else if (sortBy === 'price') {
                    const priceA = parseFloat(a.price || '999999');
                    const priceB = parseFloat(b.price || '999999');
                    return priceA - priceB;
                } else { // combined
                    return (b.combinedScore || 0) - (a.combinedScore || 0);
                }
            });
            
            // Update display - keep sort controls in header, only update matches
            const matchesContainer = document.getElementById('packageMatchesContainer');
            matchesContainer.innerHTML = renderMatches(sorted);
            
            // Update currentPackageMatches to reflect new order
            currentPackageMatches = sorted;
            
            // Update button styles
            ['combined', 'fitness', 'price'].forEach(btn => {
                const button = document.getElementById(`sort${btn.charAt(0).toUpperCase() + btn.slice(1)}`);
                if (button) {
                    if (btn === sortBy) {
                        button.style.borderColor = '#FFC107';
                        button.style.background = '#FFC107';
                        button.style.color = '#1a1a1a';
                    } else {
                        button.style.borderColor = '#e0e0e0';
                        button.style.background = 'white';
                        button.style.color = '#666';
                    }
                }
            });
        }
        
        async function selectPackageMatch(index) {
            console.log('[selectPackageMatch] ========== START ==========');
            console.log('[selectPackageMatch] Index:', index);
            
            const match = currentPackageMatches[index];
            if (!match) {
                console.warn('[selectPackageMatch] No match found at index:', index);
                return;
            }
            
            console.log('[selectPackageMatch] Selected match:', match);
            selectedPackageMatch = match;
            
            // Get product info
            const productId = window.currentDesignProductId;
            console.log('[selectPackageMatch] Product ID:', productId);
            const product = productId ? demoProducts.find(p => p.id === productId) : null;
            const productName = product ? (currentLang === 'ar' ? product.nameAr : product.nameEn) : '';
            const productPhoto = product?.productPhoto || '';
            console.log('[selectPackageMatch] Product name:', productName);
            console.log('[selectPackageMatch] Product photo:', productPhoto ? 'Yes' : 'No');
            
            // Show loading state - clear any previous images first
            const imageSection = document.getElementById('generatedImageSection');
            const imageContainer = document.getElementById('generatedImageContainer');
            const generatedImage = document.getElementById('generatedPackageImage');
            
            // Clear any previous image to prevent caching issues
            if (generatedImage) {
                generatedImage.src = '';
                generatedImage.removeAttribute('src');
            }
            generatedPackageImageUrl = null; // Clear cached URL
            
            imageSection.style.display = 'block';
            imageContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;"><div style="font-size: 48px; margin-bottom: 15px;">üé®</div><div>' + (currentLang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä...' : 'Generating design using AI...') + '</div></div>';
            imageSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            try {
                // Use Google Gemini (via backend) to generate image prompt
                const apiUrlInput = document.getElementById('apiUrl');
                let apiUrl = 'https://packageha-ai.akhodary-006.workers.dev';
                if (apiUrlInput && apiUrlInput.value.trim()) {
                    apiUrl = apiUrlInput.value.trim();
                }
                
                let finalUrl = apiUrl;
                if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                    finalUrl = 'https://' + finalUrl;
                }
                finalUrl = finalUrl.replace(/\/$/, '');
                
                // Build prompt for image generation
                const imagePromptRequest = `Generate a detailed image description for a product packaging visualization.

Product: ${productName}
Package: ${match.name}
Package Details: ${match.reason || ''}

Create a detailed, professional image description that combines:
1. The product (${productName})
2. The selected package (${match.name})
3. An elegant, luxurious background setting
4. Professional product photography style
5. High-quality lighting and composition

The description should be suitable for image generation AI (like DALL-E, Midjourney, or Stable Diffusion).
Return ONLY a detailed image description, no other text.`;

                console.log('[selectPackageMatch] Image prompt request:', imagePromptRequest);
                console.log('[selectPackageMatch] Calling image generation endpoint:', `${finalUrl}/api/generate-image-prompt`);
                
                // Get product photo if available
                const productPhotoUrl = product?.productPhoto || null;
                
                console.log('[selectPackageMatch] Product photo URL:', productPhotoUrl);
                console.log('[selectPackageMatch] Package image URL:', match.imageUrl);
                
                const requestStartTime = Date.now();
                const response = await fetch(`${finalUrl}/api/generate-image-prompt`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: imagePromptRequest,
                        productImageUrl: productPhotoUrl || undefined,
                        packageImageUrl: match.imageUrl || undefined
                    })
                });
                
                const requestDuration = Date.now() - requestStartTime;
                console.log('[selectPackageMatch] Response received after', requestDuration, 'ms');
                console.log('[selectPackageMatch] Response status:', response.status);
                console.log('[selectPackageMatch] Response OK:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[selectPackageMatch] Response error:', response.status, errorText);
                    
                    // Check for specific Gemini API errors
                    let errorMessage = currentLang === 'ar' 
                        ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                        : 'An error occurred while creating the image. Please try again.';
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error && errorData.error.includes('Interactions API')) {
                            errorMessage = currentLang === 'ar'
                                ? 'ÿÆÿ∑ÿ£ ŸÅŸä ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä. ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿ®ŸÜŸÖŸàÿ∞ÿ¨ ÿ®ÿØŸäŸÑ...'
                                : 'AI model error. Trying alternative model...';
                            console.warn('[selectPackageMatch] Interactions API error detected, backend should retry with fallback');
                        }
                    } catch (e) {
                        // Error text is not JSON, use default message
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('[selectPackageMatch] Response data:', data);
                
                const imagePrompt = data.imagePrompt || '';
                const generatedImageUrl = data.imageUrl || null;
                
                console.log('[selectPackageMatch] Generated image prompt length:', imagePrompt.length);
                console.log('[selectPackageMatch] Generated image URL:', generatedImageUrl ? 'Yes (from Gemini)' : 'No');
                
                let imageUrlToUse;
                
                // Use the AI-generated image if available (this shows product inside package)
                if (generatedImageUrl) {
                    imageUrlToUse = generatedImageUrl;
                    console.log('[selectPackageMatch] Using AI-generated image from Gemini:', imageUrlToUse.substring(0, 100) + '...');
                } else if (productPhotoUrl) {
                    // Fallback to product image if generation failed
                    const cacheBuster = Date.now();
                    try {
                        const url = new URL(productPhotoUrl);
                        url.searchParams.set('t', cacheBuster.toString());
                        imageUrlToUse = url.toString();
                    } catch (e) {
                        imageUrlToUse = `${productPhotoUrl}${productPhotoUrl.includes('?') ? '&' : '?'}t=${cacheBuster}`;
                    }
                    console.log('[selectPackageMatch] Using product image as fallback:', imageUrlToUse);
                } else if (match.imageUrl) {
                    // Fallback to package image if product image not available
                    const cacheBuster = Date.now();
                    try {
                        const url = new URL(match.imageUrl);
                        url.searchParams.set('t', cacheBuster.toString());
                        imageUrlToUse = url.toString();
                    } catch (e) {
                        imageUrlToUse = `${match.imageUrl}${match.imageUrl.includes('?') ? '&' : '?'}t=${cacheBuster}`;
                    }
                    console.log('[selectPackageMatch] Using package image as fallback:', imageUrlToUse);
                } else {
                    // Last resort: placeholder
                    const cacheBuster = Date.now();
                    const packageHash = match.name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const unsplashIds = [
                        '1606220945770', // Packaging box
                        '1541643600914', // Product packaging
                        '1556228720',   // Product display
                        '1560472354',   // Packaging design
                        '1606220945771' // Another packaging
                    ];
                    const photoId = unsplashIds[packageHash % unsplashIds.length];
                    imageUrlToUse = `https://images.unsplash.com/photo-${photoId}?w=800&h=600&fit=crop&q=80&t=${cacheBuster}`;
                    console.log('[selectPackageMatch] Using placeholder image:', imageUrlToUse);
                }
                
                generatedPackageImageUrl = imageUrlToUse;
                
                // Display generated image - update container directly instead of trying to set src on non-existent element
                // Clear container first to prevent showing old images
                imageContainer.innerHTML = '';
                
                // Validate image URL before using it
                let isValidImageUrl = false;
                if (imageUrlToUse) {
                    if (imageUrlToUse.startsWith('data:')) {
                        // Validate data URL format
                        const parts = imageUrlToUse.split(',');
                        if (parts.length === 2 && parts[1].length > 100) {
                            isValidImageUrl = true;
                        } else {
                            console.error('[selectPackageMatch] Invalid data URL format');
                        }
                    } else if (imageUrlToUse.startsWith('http://') || imageUrlToUse.startsWith('https://')) {
                        isValidImageUrl = true;
                    }
                }
                
                if (!isValidImageUrl) {
                    console.error('[selectPackageMatch] Invalid image URL, using fallback');
                    // Use a safe placeholder
                    imageUrlToUse = 'https://via.placeholder.com/800x600?text=Image+Generation+Failed';
                }
                
                // Add description and image
                imageContainer.innerHTML = `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #FFC107;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px; font-weight: 600;" data-ar="ŸàÿµŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ© (ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Gemini):" data-en="Generated Image Description (by Gemini):">${currentLang === 'ar' ? 'ŸàÿµŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ© (ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Gemini):' : 'Generated Image Description (by Gemini):'}</div>
                        <div style="font-size: 13px; color: #333; font-style: italic; line-height: 1.6;">${imagePrompt.substring(0, 300)}${imagePrompt.length > 300 ? '...' : ''}</div>
                    </div>
                    <img id="generatedPackageImage" src="${imageUrlToUse}" alt="Generated Package Design" style="max-width: 100%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);" onerror="console.error('Image load error:', this.src.substring(0, 100)); this.style.display='none'; const errorDiv = document.createElement('div'); errorDiv.style.cssText='padding: 40px; text-align: center; color: #dc3545;'; errorDiv.textContent='${currentLang === 'ar' ? 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©' : 'Image failed to load'}'; this.parentElement.appendChild(errorDiv);">
                `;
                
                console.log('[selectPackageMatch] Image URL set:', generatedPackageImageUrl);
                
            } catch (error) {
                console.error('[selectPackageMatch] ========== ERROR ==========');
                console.error('[selectPackageMatch] Error type:', error.constructor.name);
                console.error('[selectPackageMatch] Error message:', error.message);
                console.error('[selectPackageMatch] Error stack:', error.stack);
                alert(currentLang === 'ar' 
                    ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                    : 'Error generating image. Please try again.');
                imageContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #dc3545;">' + (currentLang === 'ar' ? 'ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ©' : 'Image generation failed') + '</div>';
            } finally {
                console.log('[selectPackageMatch] ========== END ==========');
            }
        }
        
        function confirmPackageSelection() {
            if (!selectedPackageMatch || !generatedPackageImageUrl) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫ŸÑÿßŸÅ ÿ£ŸàŸÑÿßŸã' : 'Please select a package first');
                return;
            }
            
            // Get product info
            const productId = window.currentDesignProductId;
            if (!productId) {
                alert(currentLang === 'ar' ? 'ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨' : 'Error: Product not found');
                return;
            }
            
            const product = demoProducts.find(p => p.id === productId);
            if (!product) return;
            
            // Update product with package information
            product.hasPackage = true;
            product.packageAr = selectedPackageMatch.name;
            product.packageEn = selectedPackageMatch.name;
            product.packagePhoto = generatedPackageImageUrl;
            product.packageId = selectedPackageMatch.packageId; // Store Shopify package ID
            product.packageVariantId = selectedPackageMatch.packageId; // For now, use packageId as variantId (will need to get actual variant ID later)
            
            // Update inventory table
            renderInventoryTable();
            
            // Close dialog
            closeDesignPackageDialog();
        }
        
        async function startDesignFlow() {
            // Show the design package dialog instead of directly starting the wizard
            window.currentDesignProductId = null; // No specific product
            showDesignPackageDialog();
        }
        
        async function initializeFlow() {
            // Alias for startDesignFlow - for backward compatibility
            await startDesignFlow();
        }
        
        let isRequestInProgress = false; // Flag to prevent multiple simultaneous requests
        
        async function startDesignFlowWithProduct(productName) {
            // Prevent multiple simultaneous requests
            if (isRequestInProgress) {
                console.log('[startDesignFlowWithProduct] Request already in progress, skipping...');
                return;
            }
            
            isRequestInProgress = true;
            
            try {
                // Get API URL - use default if input is hidden or empty
                const apiUrlInput = document.getElementById('apiUrl');
                let apiUrl = 'https://packageha-ai.akhodary-006.workers.dev'; // Default URL
                
                if (apiUrlInput && apiUrlInput.value.trim()) {
                    apiUrl = apiUrlInput.value.trim();
                }
                
                // Ensure URL has protocol and no trailing slash
                let finalUrl = apiUrl;
                if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                    finalUrl = 'https://' + finalUrl;
                }
                finalUrl = finalUrl.replace(/\/$/, ''); // Remove trailing slash
                
                console.log('[startDesignFlowWithProduct] Making POST request to:', finalUrl);
                console.log('[startDesignFlowWithProduct] Product name:', productName);
                
                // Make the POST request
                const response = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        flow: 'direct_sales',
                        message: productName || ''
                    })
                });
                
                console.log('[startDesignFlowWithProduct] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[startDesignFlowWithProduct] Response error:', response.status, errorText);
                    
                    // Show user-friendly error message
                    alert(currentLang === 'ar' 
                        ? `ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ (${response.status}). Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿÆÿßÿØŸÖ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`
                        : `Server connection error (${response.status}). Please check server settings and try again.`);
                    return;
                }
                
                const data = await response.json();
                console.log('[startDesignFlowWithProduct] Response data:', data);
                
                if (data && typeof handleResponse === 'function') {
                    handleResponse(data, { type: 'product_design_start' });
                } else {
                    console.error('[startDesignFlowWithProduct] handleResponse function not found');
                    alert(currentLang === 'ar' 
                        ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ.'
                        : 'Error processing server response.');
                }
            } catch (error) {
                console.error('[startDesignFlowWithProduct] Error:', error);
                alert(currentLang === 'ar' 
                    ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                    : 'Connection error. Please check your internet connection and try again.');
            } finally {
                isRequestInProgress = false;
            }
        }
        
        function toggleStoresSection() {
            const accountSection = document.getElementById('accountSection');
            if (accountSection) {
                accountSection.classList.toggle('collapsed');
            }
        }
        
        // Add Product Dialog Functions
        let newProductData = {
            photo: null,
            description: '',
            dimensions: '', // Single text field: "20x15x10 cm"
            weight: '', // Text field: "200 grams"
            fragility: '',
            budget: '',
            linkedProducts: []
        };
        
        function showAddProductDialog() {
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'flex';
                // Reset form
                newProductData = {
                    photo: null,
                    description: '',
                    dimensions: '',
                    weight: '',
                    fragility: '',
                    budget: '',
                    linkedProducts: []
                };
                document.getElementById('newProductDescription').value = '';
                const lengthField = document.getElementById('productLength');
                const widthField = document.getElementById('productWidth');
                const heightField = document.getElementById('productHeight');
                if (lengthField) lengthField.value = '';
                if (widthField) widthField.value = '';
                if (heightField) heightField.value = '';
                document.getElementById('newProductWeight').value = '';
                document.getElementById('newProductFragility').value = '';
                document.getElementById('newProductBudget').value = '';
                document.getElementById('newProductPhotoPreview').style.display = 'none';
                document.getElementById('newProductPhotoPlaceholder').style.display = 'block';
                document.getElementById('linkProductStoreSelect').value = '';
                document.getElementById('storeProductsList').style.display = 'none';
                updateLinkProductStoreSelect();
                renderLinkedProductsTable();
            }
        }
        
        function closeAddProductDialog() {
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function handleNewProductPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿµŸàÿ±ÿ©' : 'Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                newProductData.photo = e.target.result;
                document.getElementById('newProductPhotoImg').src = e.target.result;
                document.getElementById('newProductPhotoPreview').style.display = 'block';
                document.getElementById('newProductPhotoPlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        function updateLinkProductStoreSelect() {
            const select = document.getElementById('linkProductStoreSelect');
            if (!select) return;
            
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add connected stores
            connectedStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = `${store.name} (${hostConfig[store.host]?.name || store.host})`;
                option.setAttribute('data-host', store.host);
                select.appendChild(option);
            });
        }
        
        async function handleLinkProductStoreChange() {
            const select = document.getElementById('linkProductStoreSelect');
            const storeId = select.value;
            const store = connectedStores.find(s => s.id === parseInt(storeId));
            
            const productsList = document.getElementById('storeProductsList');
            const productsListContent = document.getElementById('storeProductsListContent');
            
            if (!storeId || !store) {
                productsList.style.display = 'none';
                return;
            }
            
            productsList.style.display = 'block';
            productsListContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading products...</div>';
            
            if (store.host === 'salla' && sallaAccessToken) {
                // Fetch Salla products
                try {
                    const apiUrlInput = document.getElementById('apiUrl');
                    const apiUrl = apiUrlInput ? apiUrlInput.value.trim() : 'https://packageha-ai.akhodary-006.workers.dev';
                    let finalUrl = apiUrl;
                    if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                        finalUrl = 'https://' + finalUrl;
                    }
                    finalUrl = finalUrl.replace(/\/$/, '');
                    
                    const response = await fetch(`${finalUrl}/api/salla/products?access_token=${sallaAccessToken}`);
                    const data = await response.json();
                    
                    if (data.products && data.products.length > 0) {
                        productsListContent.innerHTML = data.products.map(product => `
                            <div onclick="linkProductFromStore(${product.id}, '${store.host}', ${store.id})" 
                                 style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;"
                                 onmouseover="this.style.borderColor='#1a1a1a'; this.style.background='#f5f7fa'"
                                 onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                                <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px;">${product.name}</div>
                                ${product.description ? `<div style="font-size: 13px; color: #666;">${product.description.substring(0, 100)}${product.description.length > 100 ? '...' : ''}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        productsListContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No products found in this store</div>';
                    }
                } catch (error) {
                    console.error('[handleLinkProductStoreChange] Error:', error);
                    productsListContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading products</div>';
                }
            } else {
                productsListContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Store connection required</div>';
            }
        }
        
        function linkProductFromStore(productId, host, storeId) {
            const store = connectedStores.find(s => s.id === storeId);
            if (!store) return;
            
            // Add to linked products
            newProductData.linkedProducts.push({
                productId: productId,
                host: host,
                storeId: storeId,
                storeName: store.name,
                productImage: product.image || 'https://via.placeholder.com/60?text=Product',
                productName: product.name || `Product ID: ${productId}`,
                productInfo: product.description || ''
            });
            
            renderLinkedProductsTable();
            // Clear selection
            document.getElementById('linkProductStoreSelect').value = '';
            document.getElementById('storeProductsList').style.display = 'none';
        }
        
        function removeLinkedProduct(index) {
            newProductData.linkedProducts.splice(index, 1);
            renderLinkedProductsTable();
        }
        
        function renderLinkedProductsTable() {
            const tbody = document.getElementById('storeLinkagesTableBody');
            if (!tbody) return;
            
            if (newProductData.linkedProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="padding: 20px; text-align: center; color: #999;" data-ar="ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±Ÿàÿßÿ®ÿ∑ ŸÖÿ™ÿ¨ÿ±" data-en="No store linkages">No store linkages</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = newProductData.linkedProducts.map((linked, index) => {
                const store = connectedStores.find(s => s.id === linked.storeId);
                const host = hostConfig[linked.host] || hostConfig.custom;
                
                // Get product info from store (if available)
                const productImage = linked.productImage || 'https://via.placeholder.com/60?text=Product';
                const productName = linked.productName || `Product ID: ${linked.productId}`;
                const productInfo = linked.productInfo || '';
                
                return `
                    <tr>
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <img src="${productImage}" alt="${productName}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e0e0e0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${productName}</div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${productInfo || '-'}</div>
                                    <div class="store-source" style="display: flex; align-items: center; gap: 8px;">
                                        <div class="store-source-icon" style="background: ${host.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; width: 24px; height: 24px; border-radius: 4px;">
                                            ${host.icon}
                                        </div>
                                        <span style="font-size: 13px; color: #333;">${linked.storeName}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function addStoreLinkage() {
            // Disabled for now
            return;
        }
        
        function saveNewProduct() {
            // Collect form data
            newProductData.description = document.getElementById('newProductDescription').value.trim();
            
            // Get dimensions from three separate fields
            const length = parseFloat(document.getElementById('productLength')?.value || '0');
            const width = parseFloat(document.getElementById('productWidth')?.value || '0');
            const height = parseFloat(document.getElementById('productHeight')?.value || '0');
            
            // Format dimensions string
            if (length > 0 && width > 0 && height > 0) {
                newProductData.dimensions = `Length ${length} cm √ó Width ${width} cm √ó Height ${height} cm`;
            } else {
                newProductData.dimensions = '';
            }
            
            newProductData.weight = document.getElementById('newProductWeight').value.trim();
            newProductData.fragility = document.getElementById('newProductFragility').value;
            newProductData.budget = document.getElementById('newProductBudget').value;
            
            if (!newProductData.description) {
                alert(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨' : 'Please enter product description');
                return;
            }
            
            // Create product name from description (first 50 chars)
            const productName = newProductData.description.substring(0, 50);
            const productNameAr = productName;
            const productNameEn = productName;
            
            // Add to demo products
            const newProduct = {
                id: Date.now(),
                nameAr: productNameAr,
                nameEn: productNameEn,
                productPhoto: newProductData.photo || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=200&h=200&fit=crop',
                packageAr: null,
                packageEn: null,
                packagePhoto: null,
                storeId: newProductData.linkedProducts.length > 0 ? newProductData.linkedProducts[0].storeId : 1,
                storeName: newProductData.linkedProducts.length > 0 ? newProductData.linkedProducts[0].storeName : 'Demo Store',
                host: newProductData.linkedProducts.length > 0 ? newProductData.linkedProducts[0].host : 'custom',
                stockAmount: 0,
                hasPackage: false
            };
            
            demoProducts.push(newProduct);
            renderInventoryTable();
            closeAddProductDialog();
        }
        
        // Initialize - DO NOT auto-initialize flow, only show inventory
        // Check for Salla callback on page load and update redirect URI display
        window.addEventListener('DOMContentLoaded', function() {
            checkSallaCallback();
            updateRedirectUriDisplay();
            renderStores();
            renderInventoryTable();
            setLanguage('ar'); // Set default language
            updateLinkProductStoreSelect(); // Initialize store select in Add Product dialog
            
            // Update redirect URI when API URL changes
            const apiUrlInput = document.getElementById('apiUrl');
            if (apiUrlInput) {
                apiUrlInput.addEventListener('input', updateRedirectUriDisplay);
                apiUrlInput.addEventListener('change', updateRedirectUriDisplay);
            }
        });
    </script>
</body>
</html>